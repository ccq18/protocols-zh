# RFC 2328 中文翻译 (stub)
# 原文文件: ../../rfcs/RFCs2001-2500/rfc2328.txt

网络工作组                                              J. Moy
评论请求编号：2328                   Ascend Communications, Inc.
标准：54                                                      1998年4月
废止：2178
类别：标准轨道


                          OSPF 版本2


本备忘录的状态

    本文件为互联网社区制定的互联网标准轨道协议，旨在征求讨论和改进建议。请参阅当前版本的《互联网官方协议标准》（STD 1），了解该协议的标准化状态和最新情况。本备忘录的分发不受限制。

版权声明

    版权所有（C）互联网协会（1998年）。保留所有权利。

摘要

    本备忘录记录了OSPF协议的第2版。OSPF是一种链路状态路由协议，设计用于在单一自治系统内部运行。每个OSPF路由器维护一个相同的数据库，描述自治系统的拓扑结构。通过构建最短路径树，从该数据库中计算出路由表。

    在拓扑发生变化时，OSPF能够快速重新计算路由，且使用最少的路由协议流量。OSPF支持等成本多路径。还提供区域路由功能，增强路由保护并减少路由协议流量。此外，所有OSPF路由协议交换都经过认证。

    本备忘录与RFC 2178的差异在附录G中说明。所有差异均具有向后兼容性。

Moy                         标准轨道                     [第1页]

RFC 2328                     OSPF 版本2                   1998年4月

    本备忘录及RFC 2178、1583和1247的实现可以互操作。

    欢迎将您的意见发送至 ospf@gated.cornell.edu。

目录
```

1 引言 ........................................... 6
1.1 协议概述 ...................................... 6
1.2 常用术语定义 .................................. 8
1.3 链路状态路由技术简史 ......................... 11
1.4 本文档的结构 ................................ 12
1.5 致谢 ........................................ 12
2 链路状态数据库：组织结构与计算 ................ 13
2.1 路由器与网络的表示 ............................ 13
2.1.1 非广播网络的表示 ............................ 15
2.1.2 链路状态数据库示例 .......................... 18
2.2 最短路径树 .................................... 21
2.3 外部路由信息的使用 ............................ 23
2.4 等成本多路径 .................................... 26
3 将自治系统划分为区域 ............................ 26
3.1 自治系统的骨干区域 ............................ 27
3.2 区域间路由 .................................... 27
3.3 路由器的分类 .................................. 28
3.4 区域配置示例 .................................. 29
3.5 IP子网划分支持 ................................ 35
3.6 支持存根区域 .................................. 37
3.7 区域的划分 .................................... 38
4 功能总结 .......................................... 40
4.1 区域间路由 .................................... 41
4.2 AS外部路由 .................................... 41
4.3 路由协议数据包 ................................ 42
4.4 基本实现要求 .................................. 43
4.5 可选的OSPF功能 ................................ 46
5 协议数据结构 ...................................... 47
6 区域数据结构 ...................................... 49
7 建立邻接关系 ...................................... 52
7.1 Hello协议 ..................................... 52
7.2 数据库同步 .................................... 53
7.3 指定路由器 .................................... 54
7.4 备份指定路由器 ................................ 56
7.5 邻接关系图 .................................... 56

Moy                         标准轨迹                     [第2页]

RFC 2328                     OSPF第2版                   1998年4月

8 协议数据包处理 .............................................. 58  
8.1  发送协议数据包 ............................................ 58  
8.2  接收协议数据包 ............................................ 61  
9  接口数据结构 ................................................ 63  
9.1  接口状态 .................................................. 67  
9.2  引起接口状态变化的事件 .................................. 70  
9.3  接口状态机 ................................................ 72  
9.4  选举指定路由器 ............................................ 75  
9.5  发送Hello包 ............................................... 77  
9.5.1  在NBMA网络上发送Hello包 .............................. 79  
10 邻居数据结构 ............................................... 80  
10.1  邻居状态 ................................................. 83  
10.2  引起邻居状态变化的事件 ................................ 87  
10.3  邻居状态机 ............................................... 89  
10.4  是否成为邻接关系 ........................................ 95  
10.5  接收Hello包 .............................................. 96  
10.6  接收数据库描述包 ........................................ 99  
10.7  接收链路状态请求包 .................................... 102  
10.8  发送数据库描述包 ........................................ 103  
10.9  发送链路状态请求包 ...................................... 104  
10.10  示例 .................................................... 105  
11 路由表结构 ................................................. 107  
11.1  路由表查找 .............................................. 111  
11.2  无区域的示例路由表 .................................... 111  
11.3  有区域的示例路由表 .................................... 112  
12 链路状态广告（LSAs） ..................................... 115  
12.1  LSA头部 ................................................. 116  
12.1.1  LS存活时间 ........................................... 116  
12.1.2  选项 .................................................. 117  
12.1.3  LS类型 ............................................... 117  
12.1.4  链路状态ID ........................................... 117  
12.1.5  广告路由器 ........................................... 119  
12.1.6  LS序列号 ............................................. 120  
12.1.7  LS校验和 ............................................. 121  
12.2  链路状态数据库 ......................................... 121  
12.3  TOS的表示 ............................................... 122  
12.4  LSAs的生成 ............................................. 123  
12.4.1  路由器LSAs ........................................... 126  
12.4.1.1 描述点对点接口 .................................... 130  
12.4.1.2 描述广播和NBMA接口 ................................ 130  
12.4.1.3 描述虚拟链路 ........................................ 131  
12.4.1.4 描述点对多点接口 ....................................

界面 ............ 131

莫伊  标准轨道  [第3页]

RFC 2328  OSPF第2版  1998年4月

12.4.1.5 路由器LSA示例 ...................................... 132  
12.4.2 网络LSA .............................................. 133  
12.4.2.1 网络LSA示例 ....................................... 134  
12.4.3 摘要LSA .............................................. 135  
12.4.3.1 将摘要LSA引入 stub 区域 ......................... 137  
12.4.3.2 摘要LSA示例 ....................................... 138  
12.4.4 AS外部LSA ........................................... 139  
12.4.4.1 AS外部LSA示例 .................................... 140  
13  链路状态泛洪程序 ...................................... 143  
13.1  确定哪个LSA更新 .................................... 146  
13.2  在数据库中安装LSA .................................. 147  
13.3  泛洪的下一步 ........................................ 148  
13.4  接收自我生成的LSA .................................. 151  
13.5  发送链路状态确认包 .................................. 152  
13.6  重新传输LSA .......................................... 154  
13.7  接收链路状态确认 .................................... 155  
14  链路状态数据库老化 .................................... 156  
14.1  提前老化LSA ......................................... 157  
15  虚拟链路 .............................................. 158  
16  路由表计算 ............................................ 160  
16.1  计算区域的最短路径树 ................................. 161  
16.1.1  下一跳计算 ......................................... 167  
16.2  计算区域间路由 ....................................... 178  
16.3  检查中继区域的摘要LSA ............................... 170  
16.4  计算AS外部路由 ....................................... 173  
16.4.1  外部路径偏好 ...................................... 175  
16.5  增量更新——摘要LSA .................................. 175  
16.6  增量更新——AS外部LSA ................................ 177  
16.7  路由表变化引发的事件 ................................. 177  
16.8  等价成本多路径 ....................................... 178  
脚注 ...................................................... 179  
参考文献 .................................................. 183  
A  OSPF数据格式 .......................................... 185  
A.1  OSPF包封装 ........................................... 185  
A.2  选项字段 ............................................. 187  
A.3  OSPF包格式 ........................................... 189  
A.3.1  OSPF包头 ........................................... 190  
A.3.2  Hello包 ............................................ 193  
A.3.3  数据库描述包 ....................................... 195  
A.3.4  链路状态请求包 ..................................... 197  
A.3.5  链路状态更新包 ..................................... 199  
A.3.6  链路状态确认包 .....................................

抱歉，您提供的内容似乎不完整或无法理解。请提供完整的英文文本，我将为您进行翻译。

莫伊  标准轨道  [第4页]

RFC 2328  OSPF 版本2  1998年4月

A.4  LSA格式 .......................................... 203
A.4.1  LSA头部 ....................................... 204
A.4.2  路由器LSA ...................................... 206
A.4.3  网络LSA ........................................ 210
A.4.4  汇总LSA ........................................ 212
A.4.5  AS外部LSA ....................................... 214
B  架构常数 .......................................... 217
C  可配置常数 ........................................ 219
C.1  全局参数 ........................................ 219
C.2  区域参数 ........................................ 220
C.3  路由器接口参数 .................................. 221
C.4  虚拟链路参数 .................................... 224
C.5  NBMA网络参数 .................................... 224
C.6  点对多点网络参数 ................................ 225
C.7  主机路由参数 .................................... 226
D  认证 .............................................. 227
D.1  空认证 .......................................... 227
D.2  简单密码认证 .................................... 228
D.3  加密认证 ........................................ 228
D.4  消息生成 ........................................ 231
D.4.1  生成空认证 .................................... 231
D.4.2  生成简单密码认证 ................................. 232
D.4.3  生成加密认证 .................................... 232
D.5  消息验证 ........................................ 234
D.5.1  验证空认证 .................................... 234
D.5.2  验证简单密码认证 ................................. 234
D.5.3  验证加密认证 .................................... 235
E  链路状态ID分配算法 ................................. 236
F  对同一网络/子网的多接口 ............................. 239
G  与RFC 2178的差异 .................................... 240
G.1  泛洪修改 ........................................ 240
G.2  对外部路径偏好的更改 ............................... 241
G.3  虚拟下一跳的不完全解析 ............................. 241
G.4  路由表查找 ........................................ 241
安全注意事项 ........................................... 243
作者地址 ............................................... 243
完整版权声明 ........................................... 244

莫伊  标准轨道  [第5页]

RFC 2328  OSPF 版本2  1998年4月

1.  引言

本文件是关于开放式最短路径优先（OSPF）TCP/IP互联网路由协议的规范。OSPF被归类为内部网关协议（IGP），这意味着它在属于同一自治系统（AS）的路由器之间分发路由信息。OSPF协议基于链路状态或SPF（最短路径优先）技术，这不同于传统TCP/IP互联网路由协议所采用的贝尔曼-福特（Bellman-Ford）算法。

OSPF协议由互联网工程任务组（IETF）的OSPF工作组开发，专为TCP/IP互联网环境设计，包括对CIDR（无类别域间路由）和外部路由信息标记的明确支持。OSPF还提供路由更新的认证机制，并在发送和接收更新时利用IP多播。此外，为了快速响应拓扑变化，同时减少路由协议流量，进行了大量优化。

1.1 协议概述

OSPF仅根据IP数据包头中的目标IP地址进行路由。IP数据包在通过自治系统时“原封不动”地转发——不会在任何其他协议头中封装。OSPF是一种动态路由协议，能够迅速检测自治系统中的拓扑变化（如路由器接口故障），并在收敛期后计算出新的无环路路径。这个收敛期很短，且涉及的路由流量极少。

在链路状态路由协议中，每个路由器维护一个描述自治系统拓扑的数据库，该数据库称为链路状态数据库。所有参与的路由器拥有完全相同的数据库。数据库中的每一项代表某个路由器的局部状态（例如，该路由器的可用接口和可达邻居）。路由器通过泛洪机制将其局部状态传播到整个自治系统。

所有路由器并行运行相同的算法。从链路状态数据库出发，每个路由器构建一棵以自己为根的最短路径树。这棵最短路径树提供了到自治系统中每个目的地的路由路径。外部引入的路由信息作为叶子节点出现在树上。

当存在多个等成本路径到达某个目的地时，流量会在这些路径间平均分配。路径的“成本”由一个无量纲的度量值描述。

OSPF允许将一组网络进行分组，这样的分组被称为区域。区域的拓扑结构对自治系统的其他部分是隐藏的。这种信息隐藏机制显著减少了路由流量。此外，区域内的路由仅由该区域自身的拓扑决定，从而保护该区域免受不良路由数据的影响。区域是IP子网网络的泛化。

OSPF支持灵活配置IP子网。每个由OSPF分发的路由都包含目标地址和子网掩码。同一IP网络号的不同子网可以具有不同的大小（即不同的掩码），这通常被称为可变长度子网划分。数据包会被路由到最匹配（即最长或最具体）的子网。主机路由被视为子网，其掩码为“全1”（0xffffffff）。

所有的OSPF协议交换都经过认证。这意味着只有受信任的路由器才能参与自治系统的路由。可以使用多种认证方案；实际上，每个IP子网都可以配置不同的认证方案。

外部路由信息（例如，从边界网关协议BGP等外部网关协议学到的路由）会在整个自治系统中进行广告。这些外部路由信息与OSPF协议的链路状态数据是分开的。每个外部路由还可以由广告路由器打上标签，以便在自治系统边界的路由器之间传递额外信息。

Moy                         标准追踪                     [第7页]

RFC 2328                     OSPF第2版                   1998年4月

1.2 常用术语的定义

本节提供了对在整个文中使用的具有特定含义的术语的定义。对于不熟悉互联网协议套件的读者，建议参考[Ref13]了解IP的相关介绍。

路由器
    一个三级互联网协议数据包交换设备。在许多IP文献中，曾被称为网关。

自治系统
    一组通过共同的路由协议交换路由信息的路由器。简称为AS。

内部网关协议
    由属于同一自治系统的路由器使用的路由协议。简称为IGP。每个自治系统只有一个IGP，但不同的自治系统可以运行不同的IGP。

路由器ID
    一个为每个运行OSPF协议的路由器分配的32位数字。该数字在自治系统内唯一标识该路由器。

网络
    在本备忘录中，指IP网络/子网/超网。一个物理网络可能被分配多个IP网络/子网编号。我们将这些视为不同的网络。点对点物理网络是个例外——无论分配了多少（如果有的话）IP网络/子网编号，它们都被视为单一网络。

网络掩码
    一个32位数字，表示单一IP网络/子网/超网中的IP地址范围。该规范以十六进制数字显示网络掩码。

例如，类C IP网络的网络掩码显示为0xffffff00。在其他资料中，这样的掩码通常显示为255.255.255.0。

点对点网络
    连接一对路由器的网络。例如，56Kb串行线路就是一种点对点网络。

广播网络
    支持多个（超过两个）连接路由器的网络，并具有将单一物理消息广播到所有连接路由器的能力。邻居路由器在这些网络上通过OSPF的Hello协议动态发现。Hello协议本身利用了广播能力。OSPF协议还会利用多播能力（如果存在的话）。在广播网络上，每对路由器都假设可以直接通信。以太网就是广播网络的一个例子。

非广播网络
    支持多个（超过两个）路由器的网络，但没有广播能力。在这些网络上，邻居路由器通过OSPF的Hello协议维护。然而，由于缺乏广播能力，可能需要一些配置来帮助发现邻居。在非广播网络上，通常需要将OSPF协议包（本应多播的）逐一发送给每个邻居路由器。X.25公共数据网络（PDN）就是非广播网络的一个例子。

在非广播网络上，OSPF运行有两种模式。
第一种模式称为非广播多访问（NBMA），模拟了在广播网络上运行OSPF的操作方式。  
第二种模式称为点对多点（Point-to-MultiPoint），将非广播网络视为一组点对点的链路。  
非广播网络根据OSPF在网络上的操作模式不同，称为NBMA网络或点对多点网络。

---

接口  
指路由器与其连接的网络之间的连接。接口具有与之相关的状态信息，这些信息由底层协议和路由协议本身提供。  
连接到网络的接口通常具有一个IP地址和子网掩码（除非该网络是无编号的点对点网络）。  
接口有时也被称为链路。

邻居路由器  
指具有共同网络接口的两个路由器。  
邻居关系由OSPF的Hello协议维护，通常是动态发现的。

邻接  
在选定的邻居路由器之间形成的关系，目的是交换路由信息。  
并非所有邻居路由器对都会成为邻接关系。

链路状态广告（LSA）  
描述路由器或网络本地状态的数据单元。  
对于路由器而言，包括其接口和邻接的状态。  
每个链路状态广告会在整个路由域内泛洪。  
所有路由器和网络的链路状态广告汇总形成协议的链路状态数据库。  
在本文档中，链路状态广告简称为LSA。

Hello协议  
OSPF协议中用于建立和维护邻居关系的部分。  
在广播网络上，Hello协议还可以动态发现邻居路由器。

泛洪  
OSPF协议中用于分发和同步链路状态数据库的过程。

指定路由器（Designated Router）  
每个具有至少两个连接路由器的广播和NBMA网络上，都有一个指定路由器。

路由器会为网络生成链路状态广告（LSA），并在协议的运行中承担其他特殊责任。指定路由器（Designated Router）由Hello协议选举产生。

指定路由器的概念有助于减少在广播或非广播多路访问（NBMA）网络上所需的邻接关系数量。这反过来可以减少路由协议的流量以及链路状态数据库的大小。

底层协议
提供服务给互联网协议（IP）以及OSPF协议的基础网络接入协议。例如，X.25分组和帧层用于X.25包交换网络（PDN），以太网的数据链路层用于以太网。

1.3 链路状态路由技术的简要历史

OSPF是一种链路状态路由协议。这类协议在文献中也被称为SPF基础或分布式数据库协议。本节简要介绍影响OSPF协议发展的链路状态技术的演变。

第一种链路状态路由协议是在ARPANET包交换网络中开发的。该协议详见[Ref3]。它成为所有其他链路状态协议的起点。ARPANET的同质环境，即由单一供应商的包交换机通过同步串行线路连接，简化了原始协议的设计和实现。

对该协议的修改在[Ref4]中提出。这些修改旨在通过增加校验和（以检测数据库损坏）等措施，提高路由协议的容错能力。该论文还提出了减少链路状态协议中路由流量开销的方法。这通过引入机制实现，使得LSA的生成间隔可以增加一个数量级。

此外，还提出了一种用于ISO IS-IS路由协议的链路状态算法。该协议详见[Ref2]。该协议包括在广播网络上减少数据和路由流量的方法，具体做法是为每个广播网络选举一个指定路由器（Designated Router），由其生成该网络的LSA。

IETF的OSPF工作组在开发OSPF协议的过程中，扩展了相关工作。指定路由器（Designated Router）的概念得到了极大增强，以进一步减少所需的路由流量。多播功能被利用以实现额外的路由带宽压缩。还开发了一套区域路由方案，能够实现信息的隐藏、保护和减少。最后，这些算法被调整以在TCP/IP互联网中实现高效运行。

1.4 本文档的结构

本规范的前三个章节对协议的功能和能力进行了总体介绍。第4至16章详细说明了协议的机制。附录中规定了数据包格式、协议常量和配置项。

文中出现的诸如HelloInterval之类的标签，指的是协议常量。这些常量可能是可配置的，也可能不是。架构相关的常量总结在附录B，可配置的常量总结在附录C。

协议的详细规范以数据结构的形式呈现，旨在使说明更为精确。协议的实现需要支持所描述的功能，但不必使用本文中出现的精确数据结构。

1.5 致谢

作者感谢Ran Atkinson、Fred Baker、Jeffrey Burgan、Rob Coltun、Dino Farinacci、Vince Fuller、Phanindra Jujjavarapu、Milo Medin、Tom Pusateri、Kannan Varadhan、Zhaohui Zhang以及OSPF工作组的其他成员，感谢他们在此项目中提供的思想和支持。

OSPF点对多点（Point-to-MultiPoint）接口基于Fred Baker的工作。

OSPF的加密认证选项由Fred Baker和Ran Atkinson共同开发。

2. 链路状态数据库：组织结构与计算

以下小节介绍了OSPF链路状态数据库的组织方式，以及在数据库上执行的路由计算，以生成路由器的路由表。

2.1  路由器和网络的表示

自治系统的链路状态数据库描述了一个有向图。该图的顶点由路由器和网络组成。当两个路由器通过物理点对点网络相连时，它们之间有一条边。连接路由器与网络的边表示该路由器在该网络上有一个接口。网络可以是中继网络（transit network）或边缘网络（stub network）。中继网络能够承载既非本地发起也非本地目的的数据流。中继网络由具有双向边（既有入边又有出边）的图顶点表示。边缘网络的顶点只有入边。

图中每个网络节点的邻居关系取决于网络的类型（点对点、广播、非广播多访问（NBMA）或点对多点）以及连接到该网络的路由器数量。图1a中展示了三种情况。矩形表示路由器，圆圈和椭圆表示网络。路由器名称以“RT”开头，网络名称以“N”开头。路由器接口名称以“I”开头。路由器之间的线条表示点对点网络。图的左侧显示了网络及其连接的路由器，右侧显示了相应的图。

Moy                         标准追踪                        [第13页]

RFC 2328                     OSPF第2版                   1998年4月

（以下为图示内容的描述）

**从**

*      |RT1|RT2|
+---+Ia    +---+           *   ------------
|RT1|------|RT2|           T   RT1|   | X |
+---+    Ib+---+           O   RT2| X |   |
                           *    Ia|   | X |
                           *    Ib| X |   |

物理点对点网络

**从**

+---+                *
|RT7|                *      |RT7| N3|
+---+                T   ------------
  |                  O   RT7|   |   |
+----------------------+       *    N3| X |   |
       N3                  *

边缘网络

以下是英文内容的中文翻译：

```
                                                  **来自**
                +---+      +---+
                |RT3|      |RT4|              |RT3|RT4|RT5|RT6|N2 |
                +---+      +---+        *  ------------------------
                  |    N2    |          *  RT3|   |   |   |   | X |
            +----------------------+    T  RT4|   |   |   |   | X |
                  |          |          O  RT5|   |   |   |   | X |
                +---+      +---+        *  RT6|   |   |   |   | X |
                |RT5|      |RT6|        *   N2| X | X | X | X |   |
                +---+      +---+

                          广播或非广播多点接入网络



                    图1a：网络地图组件




Moy                         标准轨迹                    [第14页]


RFC 2328                     OSPF版本2                   1998年4月


             网络和路由器由顶点表示。
             如果列A和行B的交点标有X，则顶点A和顶点B之间由一条边相连。



        图1a的顶部显示两个路由器通过点对点链路相连。在生成的链路状态数据库图中，这两个路由器顶点由一对边直接相连，双向各一条。连接点对点网络的接口不必分配IP地址。当分配接口地址时，它们被建模为存根链路，每个路由器都广告一个到对方接口地址的存根连接。可选地，可以为点对点网络分配一个IP子网。在这种情况下，两个路由器都向IP子网广告存根链路，而不是彼此广告IP接口地址。

        图1a的中部显示一个只有一个连接路由器的网络（即存根网络）。在这种情况下，网络在链路状态数据库图的存根连接端显示。

        当多个路由器连接到广播网络时，链路状态数据库图显示所有路由器双向连接到该网络顶点。这在图1a的底部显示。

        图中的每个网络（存根或中继）都有一个IP地址和相关的网络掩码。掩码表示网络中的节点数。直接连接到路由器的主机（称为主机路由）在图中作为存根网络出现。主机路由的网络掩码始终为0xffffffff，表示网络中只有一个节点。


        2.1.1.  非广播网络的表示

            如前所述，OSPF可以在非广播网络上运行，模式有两种：非广播多点接入（NBMA）或点对多点（Point-to-MultiPoint）。
            模式的选择决定了Hello消息的传输方式。
```

莫伊  标准轨道  [第15页]

RFC 2328  OSPF版本2  1998年4月

在非广播网络上进行协议和泛洪工作，以及网络在链路状态数据库中的表示方式。

在NBMA（非广播多点接入）模式下，OSPF模拟在广播网络上的操作：为NBMA网络选举一个指定路由器（Designated Router），并由该指定路由器生成一个LSA（链路状态广告）用于描述网络。广播网络和NBMA网络的图形表示是相同的。这种表示在图1a的中间部分展示。

NBMA模式是运行OSPF在非广播网络上的最有效方式，无论是在链路状态数据库的大小还是在路由协议流量方面。然而，它有一个重要限制：所有连接到NBMA网络的路由器必须能够直接通信。在某些非广播网络上，这一限制可能得到满足，例如使用SVC（虚拟连接）技术的ATM子网。但在其他非广播网络上，比如只使用PVC（永久虚拟电路）的帧中继网络，通常无法满足这一条件。在非广播网络中，如果并非所有路由器都能直接通信，可以将非广播网络划分为逻辑子网，每个子网中的路由器可以直接通信，然后将每个子网作为一个NBMA网络运行（参见[Ref15]）。但这需要大量的管理工作，且容易配置错误。对于这种情况，可能更好的做法是在点对多点（Point-to-MultiPoint）模式下运行。

在点对多点模式中，OSPF将非广播网络上的所有路由器间连接视为点对点链路。不会为网络选举指定路由器，也不会为网络生成LSA。实际上，点对多点网络的顶点在链路状态数据库的图中并不存在。

图1b展示了点对多点网络的链路状态数据库表示。在图的左侧，展示了一个点对多点网络。假设除了RT4和RT5之外，所有路由器都可以直接通信。I3到I6表示这些路由器。

点对多点网络上的IP接口地址。在链路状态数据库的图形表示中，能够在点对多点网络上直接通信的路由器之间用双向边连接，每个路由器还与其自身的IP接口地址有一个盲端连接（这与实际点对点链路的表示不同；见图1a）。

在一些非广播网络上，使用点对多点模式和诸如逆向ARP（Inverse ARP，参见[Ref14]）等数据链路协议，即使没有广播支持，也可以实现OSPF邻居的自动发现。

```
                                                  **来自**
                +---+      +---+
                |RT3|      |RT4|              |RT3|RT4|RT5|RT6|
                +---+      +---+        *  --------------------
                I3|    N2    |I4        *  RT3|   | X | X | X |
            +----------------------+    T  RT4| X |   |   | X |
                I5|          |I6        O  RT5| X |   |   | X |
                +---+      +---+        *  RT6| X | X | X |   |
                |RT5|      |RT6|        *   I3| X |   |   |   |
                +---+      +---+            I4|   | X |   |   |
                                            I5|   |   | X |   |
                                            I6|   |   |   | X |

图1b：网络地图组件
点对多点网络

除RT4和RT5外，所有路由器都可以通过N2直接通信。I3到I6表示IP接口地址。

Moy  标准追踪  [第17页]

RFC 2328  OSPF版本2  1998年4月

2.1.2.  链路状态数据库示例

图2显示了一个自治系统的示意图。标记为H1的矩形表示一个主机，该主机通过SLIP连接到路由器RT12。因此，RT12在广告一个主机路由。路由器之间的线条表示物理点对点网络。唯一已分配接口地址的点对点网络是连接RT6和RT10的那一条。RT5和RT7与其他自治系统有BGP连接。这两个路由器都显示了一组通过BGP学习到的路由。
```

每个路由器接口的输出端都关联有一个成本值。这个成本值由系统管理员进行配置。成本越低，接口被用来转发数据流的可能性越大。外部派生的路由数据（例如，通过BGP学习到的路由）也会关联有成本。

由图2中的映射所形成的有向图在图3中进行了展示。弧线标注了对应路由器输出接口的成本值。没有标注成本的弧线其成本为0。请注意，从网络到路由器的弧线成本始终为0，但它们仍然具有重要意义。还要注意，外部派生的路由数据在图中表现为“存根”。

链路状态数据库由路由器生成的链路状态广告（LSA）拼凑而成。在相关的图形表示中，每个路由器或中转网络的邻域信息都用一个单独的LSA表示。图4以图形方式展示了这些LSA。路由器RT12连接到两个广播网络，并通过一条SLIP线路连接到一个主机。网络N6是一个广播网络，连接着三个路由器。从网络N6到其连接的路由器的所有链路成本均为0。请注意，网络N6的LSA实际上由该网络的一个连接路由器生成：即被选为该网络的指定路由器（Designated Router）的路由器。

这是一个示意图，展示了一个自治系统的网络拓扑结构。图中包含多个路由器（如RT1、RT2等）、节点（如N1、N2等）以及它们之间的连接关系。图中的数字和符号表示不同的连接端口和链路，反映了网络中各个设备的布局和连接方式。

以下是英文内容的中文翻译：

```
                 |RT|RT|RT|RT|RT|RT|RT|RT|RT|RT|RT|RT|
                 |1 |2 |3 |4 |5 |6 |7 |8 |9 |10|11|12|N3|N6|N8|N9|
              ----- ---------------------------------------------
              RT1|  |  |  |  |  |  |  |  |  |  |  |  |0 |  |  |  |
              RT2|  |  |  |  |  |  |  |  |  |  |  |  |0 |  |  |  |
              RT3|  |  |  |  |  |6 |  |  |  |  |  |  |0 |  |  |  |
              RT4|  |  |  |  |8 |  |  |  |  |  |  |  |0 |  |  |  |
              RT5|  |  |  |8 |  |6 |6 |  |  |  |  |  |  |  |  |  |
              RT6|  |  |8 |  |7 |  |  |  |  |5 |  |  |  |  |  |  |
              RT7|  |  |  |  |6 |  |  |  |  |  |  |  |  |0 |  |  |
          *   RT8|  |  |  |  |  |  |  |  |  |  |  |  |  |0 |  |  |
          *   RT9|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |0 |
          T  RT10|  |  |  |  |  |7 |  |  |  |  |  |  |  |0 |0 |  |
          O  RT11|  |  |  |  |  |  |  |  |  |  |  |  |  |  |0 |0 |
          *  RT12|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |0 |
          *    N1|3 |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
               N2|  |3 |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
               N3|1 |1 |1 |1 |  |  |  |  |  |  |  |  |  |  |  |  |
               N4|  |  |2 |  |  |  |  |  |  |  |  |  |  |  |  |  |
               N6|  |  |  |  |  |  |1 |1 |  |1 |  |  |  |  |  |  |
               N7|  |  |  |  |  |  |  |4 |  |  |  |  |  |  |  |  |
               N8|  |  |  |  |  |  |  |  |  |3 |2 |  |  |  |  |  |
               N9|  |  |  |  |  |  |  |  |1 |  |1 |1 |  |  |  |  |
              N10|  |  |  |  |  |  |  |  |  |  |  |2 |  |  |  |  |
              N11|  |  |  |  |  |  |  |  |3 |  |  |  |  |  |  |  |
              N12|  |  |  |  |8 |  |2 |  |  |  |  |  |  |  |  |  |
              N13|  |  |  |  |8 |  |  |  |  |  |  |  |  |  |  |  |
              N14|  |  |  |  |8 |  |  |  |  |  |  |  |  |  |  |  |
              N15|  |  |  |  |  |  |9 |  |  |  |  |  |  |  |  |  |
               H1|  |  |  |  |  |  |  |  |  |  |  |10|  |  |  |  |


                     图3：生成的有向图

                 网络和路由器由顶点表示。
                 如果列A和行B的交点标记有X，则从顶点A到顶点B的有向边的代价为X。
```

|RT12|N9|N10|H1|                 |RT9|RT11|RT12|N9|
           *  --------------------          *  ----------------------
           *  RT12|    |  |   |  |          *   RT9|   |    |    |0 |
           T    N9|1   |  |   |  |          T  RT11|   |    |    |0 |
           O   N10|2   |  |   |  |          O  RT12|   |    |    |0 |
           *    H1|10  |  |   |  |          *    N9|   |    |    |  |
           *                                *
                RT12的路由器链路状态广告              N9的网络链路状态广告

                  图4：单个链路状态组件

              网络和路由器由顶点表示。
              如果列A和行B的交点标记为X，则连接顶点A和顶点B的边的代价为X。

    2.2.  最短路径树

        当没有配置OSPF区域时，自治系统中的每个路由器都拥有相同的链路状态数据库，从而导致相同的图形表示。路由器根据此图通过计算以自身为根的最短路径树来生成其路由表。显然，最短路径树依赖于进行计算的路由器。我们示例中的RT6路由器的最短路径树如图5所示。

        这棵树提供到任何目标网络或主机的完整路径。然而，在转发过程中只使用到目标的下一跳。此外，还计算了到任何广告外部路由的最佳路径。由此得出的RT6路由器的路由表如表2所示。请注意，每个编号点对点网络（在本例中为RT6和RT10之间的串行线路）都有一条单独的路由。

        指向其他AS（如N12）网络的路由在图5的最短路径树中以虚线显示。使用

Moy                         标准追踪                        [第21页]

RFC 2328                     OSPF第2版                   1998年4月

RT6（起点）
                    RT5 o------------o-----------o Ib
                       /|\    6      |\     7
                     8/8|8\          | \
                     /  |  \        6|  \
                    o   |   o        |   \7
                   N12  o  N14       |    \
                       N13        2  |     \
                            N4 o-----o RT3  \
                                    /        \    5
                                  1/     RT10 o-------o Ia
                                  /           |\
                       RT4 o-----o N3        3| \1
                                /|            |  \ N6     RT7
                               / |         N8 o   o---------o
                              /  |            |   |        /|
                         RT2 o   o RT1        |   |      2/ |9
                            /    |            |   |RT8   /  |
                           /3    |3      RT11 o   o     o   o
                          /      |            |   |    N12 N15
                      N2 o       o N1        1|   |4
                                              |   |
                                           N9 o   o N7
                                             /|
                                            / |
                        N11      RT9       /  |RT12
                         o--------o-------o   o--------o H1
                             3                |   10
                                              |2
                                              |
                                              o N10


图5：路由器RT6的SPF树

未标记成本的边的成本为零（这些是网络到路由器的链路）。到网络N12-N15的路由信息为外部信息，详见第2.3节。

---

Moy  标准追踪  [第22页]

RFC 2328  OSPF版本2  1998年4月

表2：路由器RT6的路由表中列出本地目的地的部分。

这些外部派生的路由信息将在下一节中进行考虑。

2.3 使用外部路由信息

在创建树之后，会检查外部路由信息。这些外部路由信息可能来自其他路由协议，例如BGP，或者是静态配置（静态路由）。默认路由也可以作为自治系统（AS）外部路由信息的一部分被包含。

外部路由信息会在整个自治系统中不加修改地泛洪。在我们的示例中，所有自治系统中的路由器都知道RT7路由器有两条外部路由，度量值分别为2和9。

OSPF支持两种类型的外部度量。类型1外部度量以与OSPF接口成本相同的单位表示（即以链路状态度量衡量）。类型2外部度量的数量级更大；任何类型2的度量都被认为大于AS内部路径的成本。使用类型2外部度量假设AS之间的路由是路由包的主要成本，并且省去了将外部成本转换为内部链路状态度量的需要。

以类型1外部度量的处理为例，假设图2中的RT7和RT5路由器都在广告类型1的外部度量。对于每个被广告的外部路由，从RT6到该外部路由的总成本是外部路由广告的成本与RT6到广告路由器的距离之和。当两个路由器都在广告相同的外部目的地时，RT6会选择提供最小总成本的广告路由器。然后，RT6将到外部目的地的下一跳设置为到所选广告路由器的下一跳，即在路由到所选广告路由器时会使用的下一跳。

在图2中，RT5和RT7都在广告到目的地网络N12的外部路由。由于RT7广告的距离为10（8+2），优于RT5的14（6+8），因此RT7更受青睐。表3显示了在检查外部路由时添加到路由表中的条目：



| 目的地 | 下一跳 | 距离 |
|---------|---------|-------|
| N12     | RT10    | 10    |
| N13     | RT5     | 14    |
| N14     | RT5     | 14    |
| N15     | RT10    | 17    |

表3：路由器RT6的路由表中列出外部目的地的部分内容。

处理类型2外部度量的方法更为简单。广告最小外部度量的自治系统（AS）边界路由器会被选为代表，无论到该AS边界路由器的内部距离是多少。假设在我们的例子中，RT5和RT7都在广告类型2外部路由，那么所有目的地为网络N12的流量都将转发到RT7，因为2 < 8。当存在多个等成本的类型2路由时，会用到到广告路由器的内部距离来打破平局。

在AS中，类型1和类型2的外部度量可以同时存在。在这种情况下，类型1的外部度量总是优先考虑。

本节假设发往外部目的地的数据包总是通过广告该外部路由的AS边界路由器进行路由，但这并不总是理想的。例如，假设在图2中，网络N6连接了一个额外的路由器，称为RTX。进一步假设RTX不参与OSPF路由，但与AS边界路由器RT7交换BGP信息。那么，RT7最终会广告所有应路由到RTX的外部OSPF路由。如果这些目的地的包总是先路由到RT7（广告路由器），那么可能会引入额外的跳数。

为了解决这个问题，OSPF协议允许AS边界路由器在其AS外部链路广告（LSA）中指定“转发地址”。在上述例子中，RT7会将RTX的IP地址指定为所有应直接路由到RTX的目的地的“转发地址”。

“转发地址”还有另一个用途。它使得自治系统内部的路由器可以作为“路由服务器”工作。例如，在图2中，RT6可以成为一个路由服务器，通过静态配置和外部路由协议获取外部路由信息。RT6随后会开始将自己作为AS边界路由器进行广告，并生成一组OSPF的AS外部链路广告（AS-external-LSA）。在每个AS外部LSA中，RT6会通过适当设置LSA的“转发地址”字段，指明用于到达目的地的正确自治系统出口点。

2.4. 等价多路径

上述讨论简化为只考虑到达某一目的地的单一路由。实际上，如果存在多条到达同一目的地的等价路径，它们都会被发现并使用。这不需要对算法进行任何概念上的修改，相关讨论将推迟到我们更详细地介绍树构建过程时再进行。

在等价多路径的情况下，路由器可能有多条可用的下一跳通向某一特定目的地。

3. 将自治系统划分为区域

OSPF允许将连续的网络和主机集合在一起，形成一个区域。这样的一个组，以及具有接口连接到该组中任意网络的路由器，称为一个区域。每个区域都运行一份独立的基本链路状态路由算法。这意味着每个区域拥有自己的链路状态数据库和相应的图，如前一节所述。

区域的拓扑结构对区域外部是不可见的。相反，区域内部的路由器对区域外部的详细拓扑一无所知。这种知识的隔离使得协议能够显著减少路由流量，相较于将整个自治系统视为单一的链路状态域。

引入区域后，不再所有自治系统中的路由器都拥有相同的链路状态数据库。每个路由器实际上为其连接的每个区域维护一份独立的链路状态数据库。（连接到多个区域的路由器被称为区域边界路由器）。属于同一地区的两个路由器在该区域内拥有相同的区域链路状态数据库。

自治系统内的路由分为两个层次进行，取决于数据包的源和目的地是否在同一区域（使用区域内路由）或不同区域（使用区域间路由）。在区域内路由中，数据包仅根据区域内获得的信息进行路由；不能使用来自区域外的路由信息。这种设计保护区域内的路由免受恶意路由信息的注入。关于区域间路由的内容，我们将在第3.2节中讨论。

3.1. 自治系统的骨干区域

OSPF骨干区域是特殊的OSPF区域，通常称为区域0（有时写作Area 0.0.0.0，因为OSPF区域ID通常以IP地址格式表示）。OSPF骨干区域始终包含所有的区域边界路由器。骨干区域负责在非骨干区域之间分发路由信息。骨干区域必须是连续的，但不一定在物理上连续；可以通过配置虚拟链路来建立或维护骨干区域的连通性。

虚拟链路可以在任何两个具有共同非骨干区域接口的骨干路由器之间配置。虚拟链路属于骨干区域。协议将通过虚拟链路连接的两个路由器视为连接了一个未编号的点对点骨干网络。在骨干区域的拓扑图上，这两个路由器由弧线连接，其代价为两者之间的区域内距离。沿虚拟链路传输的路由协议流量仅使用区域内路由。

3.2 区域间路由

当在两个非骨干区域之间路由数据包时，会使用骨干区域。数据包的路径可以分为三个连续的部分：从源到区域边界路由器的区域内路径、源区域与目标区域之间的骨干路径，以及从目标区域到目的地的区域内路径。算法会找到具有最小成本的这类路径集合。

换句话说，区域间路由可以被看作是在自治系统内强制形成星形结构，骨干区域作为中心，非骨干区域作为辐条。

骨干区域的拓扑决定了区域之间使用的骨干路径。通过添加虚拟链路，可以增强骨干区域的拓扑结构，从而让系统管理员对区域间流量的路径有一定的控制。

当数据包离开源区域时，选择正确的区域边界路由器的方法与选择广告外部路由的路由器相同。每个区域边界路由器会为该区域总结其到所有区域外网络的成本。在计算完该区域的SPF树后，通过检查区域边界路由器的汇总信息，计算到所有区域间目的地的路由。

3.3 路由器的分类

在引入区域（areas）之前，唯一具有专门功能的OSPF路由器是那些广告外部路由信息的路由器，例如图2中的RT5路由器。当自治系统（AS）被划分为多个OSPF区域时，路由器根据功能被进一步划分为以下四个重叠的类别：

内部路由器
    所有直接连接的网络都属于同一区域的路由器。这些路由器运行一份基本路由算法的副本。

区域边界路由器
    连接多个区域的路由器。区域边界路由器为每个连接的区域运行多份基本算法的副本。它们将所连接区域的拓扑信息浓缩后分发到骨干区域，骨干区域再将信息传递到其他区域。

骨干路由器
    拥有连接到骨干区域接口的路由器，包括所有连接到多个区域的路由器（即区域边界路由器）。但骨干路由器不一定是区域边界路由器。所有接口都连接到骨干区域的路由器也被支持。

自治系统边界路由器
    与属于其他自治系统的路由器交换路由信息的路由器。这类路由器在整个自治系统内广告自治系统外部的路由信息。到每个自治系统边界路由器的路径为系统内的每个路由器所知。这一分类完全独立于前述分类：自治系统边界路由器可以是内部路由器，也可以是区域边界路由器，可能参与或不参与骨干区域的路由。

3.4 一个示例区域配置

图6展示了一个示例区域配置。第一区域包括网络N1-N4及其连接的路由器RT1-RT4。第二区域包括网络N6-N8及其连接的RT7、RT8、RT10和RT11。第三区域包括网络N9-N11和主机H1，以及连接的RT9、RT11和RT12。第三个区域被配置为将网络N9-N11和主机H1在对外广告时合并为一个单一的路由（详见第3.5节）。

在图6中，RT1、RT2、RT5、RT6、RT8、RT9和RT12是内部路由器。RT3、RT4、RT7、RT10和RT11是区域边界路由器。最后，如前所述，RT5和RT7是自治系统边界路由器。

图7显示了区域1的链路状态数据库。该图完整描述了该区域内的区域内路由情况，同时也展示了两个内部路由器RT1和RT2对互联网的完整视图。区域边界路由器RT3和RT4的任务是向区域1广告所有区域外目的地的距离。这些距离在图7中用虚线的边界路由表示。此外，RT3和RT4还必须向区域1广告AS边界路由器RT5和RT7的位置。最后，RT5和RT7发出的AS外部链路状态广告（LSA）会在整个AS中泛洪，特别是在区域1内。这些LSA被包含在区域1的数据库中，并提供到网络N12-N15的路由。

RT3和RT4还必须对区域1的拓扑进行汇总，以便进行更高层次的路由决策。

以下是该英文图示的中文翻译：

```
             ...........................
             .   +                     .
             .   | 3+---+              .      N12      N14
             . N1|--|RT1|\ 1           .        \ N13 /
             .   |  +---+ \            .        8\ |8/8
             .   +         \ ____      .          \|/
             .              /    \   1+---+8    8+---+6
             .             *  N3  *---|RT4|------|RT5|--------+
             .              \____/    +---+      +---+        |
             .    +         /      \   .           |7         |
             .    | 3+---+ /        \  .           |          |
             .  N2|--|RT2|/1        1\ .           |6         |
             .    |  +---+            +---+8    6+---+        |
             .    +                   |RT3|------|RT6|        |
             .                        +---+      +---+        |
             .                      2/ .         Ia|7         |
             .                      /  .           |          |
             .             +---------+ .           |          |
             .Area 1           N4      .           |          |
             ...........................           |          |
          ..........................               |          |
          .            N11         .               |          |
          .        +---------+     .               |          |
          .             |          .               |          |    N12
          .             |3         .             Ib|5         |6 2/
          .           +---+        .             +----+     +---+/
          .           |RT9|        .    .........|RT10|.....|RT7|---N15.
          .           +---+        .    .        +----+     +---+ 9    .
          .             |1         .    .    +  /3    1\      |1       .
          .            _|__        .    .    | /        \   __|_       .
          .           /    \      1+----+2   |/          \ /    \      .
          .          *  N9  *------|RT11|----|            *  N6  *     .
          .           \____/       +----+    |             \____/      .
          .             |          .    .    |                |        .
          .             |1         .    .    +                |1       .
          .  +--+   10+----+       .    .   N8              +---+      .
          .  |H1|-----|RT12|       .    .                   |RT8|      .
          .  +--+SLIP +----+       .    .                   +---+      .
          .             |2         .    .                     |4       .
          .             |          .    .                     |        .
          .        +---------+     .    .                 +--------+   .



Moy                         Standards Track                    [第30页]


RFC 2328                     OSPF 版本2                   1998年4月
```

以下是英文内容的中文翻译：

```
          .            N10         .    .                     N7       .
          .                        .    .区域 2                        .
          .区域 3                  .    ................................
          ..........................

                    图6：一个示例的OSPF区域配置

        它们的骨干LSA显示在表4中。这些摘要显示了哪些网络包含在区域1内（即网络N1-N4），以及从路由器RT3和RT4到这些网络的距离。

        骨干的链路状态数据库如图8所示。图中显示的路由器是骨干路由器。RT11是一个骨干路由器，因为它属于两个区域。为了使骨干连接起来，已在路由器R10和R11之间配置了虚拟链路。

        区域边界路由器RT3、RT4、RT7、RT10和RT11对其连接的非骨干区域的路由信息进行了汇总，以通过骨干进行分发；这些是图8中以虚线显示的边界点。请记住，第三个区域已被配置为将网络N9-N11和主机H1合并为一条路由。这在图8中为网络N9-N11和H1显示为一条虚线。路由器RT5和RT7是自治系统边界路由器；它们的外部信息也在图8中以虚线显示。

                     网络   RT3 广告   RT4 广告
                     _____________________________
                     N1        4          4
                     N2        4          4
                     N3        1          1
                     N4        2          3

              表4：由路由器RT3和RT4向骨干广告的网络

Moy                         标准追踪                     [第31页]

RFC 2328                     OSPF第2版                   1998年4月

                               **来自**
```

以下是英文内容的中文翻译：

```
                          |RT|RT|RT|RT|RT|RT|
                          |1 |2 |3 |4 |5 |7 |N3|
                       ----- -------------------
                       RT1|  |  |  |  |  |  |0 |
                       RT2|  |  |  |  |  |  |0 |
                       RT3|  |  |  |  |  |  |0 |
                   *   RT4|  |  |  |  |  |  |0 |
                   *   RT5|  |  |14| 8|  |  |  |
                   T   RT7|  |  |20|14|  |  |  |
                   O    N1|3 |  |  |  |  |  |  |
                   *    N2|  |3 |  |  |  |  |  |
                   *    N3|1 |1 |1 |1 |  |  |  |
                        N4|  |  |2 |  |  |  |  |
                     Ia,Ib|  |  |20|27|  |  |  |
                        N6|  |  |16|15|  |  |  |
                        N7|  |  |20|19|  |  |  |
                        N8|  |  |18|18|  |  |  |
                 N9-N11,H1|  |  |29|36|  |  |  |
                       N12|  |  |  |  |8 |2 |  |
                       N13|  |  |  |  |8 |  |  |
                       N14|  |  |  |  |8 |  |  |
                       N15|  |  |  |  |  |9 |  |

                      图7：区域1的数据库。

网络和路由器由顶点表示。
当列A与行B的交点标记有X时，顶点A到顶点B之间存在一条代价为X的边。













Moy                         标准轨迹                    [第32页]


RFC 2328                     OSPF版本2                   1998年4月


                                  **来自**

                            |RT|RT|RT|RT|RT|RT|RT
                            |3 |4 |5 |6 |7 |10|11|
                         ------------------------
                         RT3|  |  |  |6 |  |  |  |
                         RT4|  |  |8 |  |  |  |  |
                         RT5|  |8 |  |6 |6 |  |  |
                         RT6|8 |  |7 |  |  |5 |  |
                         RT7|  |  |6 |  |  |  |  |
                     *  RT10|  |  |  |7 |  |  |2 |
                     *  RT11|  |  |  |  |  |3 |  |
                     T    N1|4 |4 |  |  |  |  |  |
                     O    N2|4 |4 |  |  |  |  |  |
                     *    N3|1 |1 |  |  |  |  |  |
                     *    N4|2 |3 |  |  |  |  |  |
                          Ia|  |  |  |  |  |5 |  |
                          Ib|  |  |  |7 |  |  |  |
                          N6|  |  |  |  |1 |1 |3 |
                          N7|  |  |  |  |5 |5 |7 |
                          N8|  |  |  |  |4 |3 |2 |
                   N9-N11,H1|  |  |  |  |  |  |11|
                         N12|  |  |8 |  |2 |  |  |
                         N13|  |  |8 |  |  |  |  |
                         N14|  |  |8 |  |  |  |  |
                         N15|  |  |  |  |9 |  |  |


                     图8：骨干网的数据库。
```

网络和路由器由顶点表示。
连接顶点A和顶点B的边的代价为X，当且仅当列A与行B的交点处标有一个X。

骨干网使得区域边界路由器之间可以交换摘要信息。每个区域边界路由器都能接收到所有其他区域边界路由器的区域摘要信息。然后，它通过检查收集到的链路状态广告（LSA），并加入到每个广告路由器到骨干网的距离，形成一个到其区域外所有网络的距离图。

再次以路由器RT3和RT4为例，操作流程如下：它们首先计算骨干网的SPF树。这提供了到所有其他区域边界路由器的距离。同时，还记录了到属于骨干网网络（Ia和Ib）和自治系统边界路由器（RT5和RT7）的距离。这个计算过程如表5所示。

接下来，通过查看这些区域边界路由器的区域摘要，RT3和RT4可以确定到其区域外所有网络的距离。这些距离随后由RT3和RT4在区域内部进行广告。RT3和RT4在区域1中所做的广告内容如表6所示。注意，表6假设已为骨干网配置了区域范围，将Ia和Ib归入单一的LSA中。

由RT3和RT4导入到区域1的信息，使得内部路由器（如RT1）能够智能地选择区域边界路由器。例如，RT1会使用RT4作为到网络N6的出口，使用RT3作为到网络N10的出口，等等。

| 目的地 | 来自RT3的距离 | 来自RT4的距离 |
|---------|----------------|----------------|
| 到RT3  | *              | 21             |
| 到RT4  | 22             | *              |
| 到RT7  | 20             | 14             |
| 到RT10 | 15             | 22             |
| 到RT11 | 18             | 25             |
|---------|----------------|----------------|
| 到Ia   | 20             | 27             |
| 到Ib   | 15             | 22             |
|---------|----------------|----------------|
| 到RT5  | 14             | 8              |
| 到RT7  | 20             | 14             |

表5：由RT3和RT4计算的骨干网距离。

目的地   RT3 广告   RT4 广告
_______________________________
Ia, Ib        20          27
N6            16          15
N7            20          19
N8            18          18
N9-N11, H1    29          36
_______________________________
RT5           14           8
RT7           20          14

表6：由路由器RT3和RT4向区域1广告的目的地。

这是两个路由器在到网络N8的流量中进行负载共享的示意。

路由器RT1还可以通过这种方式确定到自治系统（AS）边界路由器RT5和RT7的最短路径。然后，通过查看RT5和RT7的AS外部链路状态广告（LSA），RT1可以在向另一个自治系统（如网络N12-N15）中的目的地发送数据时，在RT5和RT7之间做出选择。

请注意，RT6和RT10之间的线路故障将导致骨干网络断开。配置RT7和RT10之间的虚拟链路可以增强骨干网络的连通性和抗故障能力。

3.5. IP子网划分支持

OSPF在每个广告的路由中附加一个IP地址掩码。该掩码指示该路由所描述的地址范围。例如，目标为128.185.0.0、掩码为0xffff0000的汇总LSA实际上描述的是从128.185.0.0到128.185.255.255的单一路由。同样，主机路由总是以掩码0xffffffff广告，表示只有一个目标。

在每个广告目的地中包含掩码，使得实现所谓的变长子网划分成为可能。这意味着单一的IP类别A、B或C网络号可以被划分成多个不同大小的子网。例如，网络128.185.0.0可以被划分为62个不同大小的子网：15个4K大小的子网、15个256大小的子网，以及32个8大小的子网。表7列出了一些示例子网地址及其掩码。

表7：一些示例子网大小
网络地址             IP地址掩码        子网大小
------------------------------------------------
128.185.16.0        0xfffff000        4K
128.185.1.0         0xffffff00        256
128.185.0.8         0xfffffff8        8

有许多不同的方法可以将一个类A、B或C的网络划分为不同大小的子网。具体的操作步骤超出了本规范的范围。然而，本规范确立了以下指导原则：当一个IP数据包被转发时，总是将其转发到与目标地址最匹配的网络。这里的“最匹配”与最长或最具体匹配同义。例如，目标地址为0.0.0.0、掩码为0x00000000的默认路由，总是与每个IP目标地址匹配，但它的匹配程度最不具体。子网掩码必须被合理分配，以确保任何IP目标地址的最佳匹配是唯一且明确的。

为每个路由附加地址掩码还可以支持IP超网（supernetting）。例如，一个物理网络段可以被分配一个[地址，掩码]对[192.9.4.0, 0xfffffc00]。该段将成为一个单一的IP网络，包含从连续的四个类C网络编号192.9.4.0到192.9.7.0的所有地址。随着CIDR（无类别域间路由）技术的出现，这种地址分配方式正变得越来越普遍（参见[Ref10]）。

为了在区域边界实现更好的聚合，可以采用区域地址范围（详见第C.2节）。每个地址范围定义为一个[地址，掩码]对。许多不同的网络可以包含在一个地址范围内，就像一个子网划分的网络由多个子网组成一样。区域边界路由器随后通过为每个地址范围广告单一路由，来总结区域内容（以便向骨干网络分发）。该路由的成本是落在该范围内的所有网络的最大成本。

例如，一个子网划分的网络可以配置为单一的OSPF区域。在这种情况下，可以配置一个单一的地址范围：一个类A、B或C的网络编号及其自然的IP掩码。在区域内部，可以定义任意数量的不同大小的子网。然而，在区域外，将只分发一个覆盖整个子网的单一路由，甚至隐藏了网络实际上是子网划分的事实。该路由的成本是组成子网的各个子网成本的最大值。

3.6 支持备用区域

在某些自治系统中，链路状态数据库的主要部分可能由自治系统外部的链路状态广告（AS-external-LSA）组成。OSPF的AS外部链路状态广告通常会在整个自治系统内进行泛洪。然而，OSPF允许将某些区域配置为“ stub 区域”。在这些stub区域内，AS外部链路状态广告不会被泛洪到区域内部；对这些区域外部目的地的路由仅基于一个（每个区域的）默认路由。这一做法减少了stub区域内部路由器的链路状态数据库大小，从而降低了内存需求。

为了充分利用OSPF的stub区域支持，必须在stub区域内使用默认路由。这一操作的实现方式如下：一个或多个区域边界路由器必须通过汇总LSA在stub区域内广告默认路由。这些汇总默认路由会在整个stub区域内进行泛洪，但不会超出该区域（因此，这些默认路由仅适用于特定的stub区域）。这些汇总默认路由将用于任何无法通过区域内或区域间路径明确到达的目的地（即，自治系统外部的目的地）。

当区域只有一个出口点，或者不需要为每个外部目的地单独选择出口点时，可以将该区域配置为stub区域。例如，图6中的区域3可以配置为stub区域，因为所有外部流量都必须经过其唯一的区域边界路由器RT11。如果区域3被配置为stub区域，RT11将会广告一个默认路由（在一个汇总LSA中），而不是将网络N12-N15的AS外部LSA泛洪到整个区域。

OSPF协议确保所有属于某一区域的路由器都对该区域是否被配置为stub达成一致。这保证了在泛洪AS外部链路状态广告时不会引起混乱。

使用stub区域有一些限制。虚拟链路不能通过stub区域配置。此外，自治系统边界路由器不能被放置在stub区域内部。

3.7 区域的分割

OSPF不会主动尝试修复区域的分割。当一个区域被分割时，每个分割出来的部分都成为一个独立的区域。随后，骨干区域（backbone）负责在这些新区域之间进行路由。之前通过区域内部路由可达的某些目的地，现在可能需要通过区域间路由才能到达。

然而，为了在分割后保持完整的路由，地址范围不能跨多个区域分割。此外，骨干区域本身也不能被分割。如果发生分割，自治系统的部分区域将变得无法访问。骨干区域的分割可以通过配置虚拟链路（参见第15节）来修复。

另一种理解区域分割的方法是观察在第2节中介绍的自治系统图。区域ID可以被看作是图的边的颜色。[1] 图中的每条边都连接到一个网络，或者本身就是一个点对点网络。在任何情况下，边都用网络的区域ID着色。

一组具有相同颜色的边，通过顶点相互连接，代表一个区域。如果自治系统的拓扑结构完整，图中将有多个不同颜色的区域，每个颜色代表一个不同的区域ID。

当自治系统的拓扑发生变化时，某个区域可能会被分割。此时，自治系统的图将出现多个相同颜色（区域ID）的区域。只要这些同色区域通过单一的骨干区域相连，自治系统内的路由功能就能继续正常运作。

---

4. 功能总结

每个区域都运行一份独立的OSPF基本路由算法的副本。具有多个区域接口的路由器会运行多份算法的副本。以下是路由算法的简要总结。

当路由器启动时，首先初始化路由协议的数据结构。然后等待底层协议的指示，确认其接口已正常工作。

接着，路由器使用OSPF的Hello协议来获取邻居。路由器向邻居发送Hello包，并接收对方的Hello包。在广播和点对点网络中，路由器通过向多播地址AllSPFRouters发送Hello包，动态检测邻居路由器。在非广播网络中，可能需要一些配置来发现邻居。在广播和非广播多点接入（NBMA）网络中，Hello协议还会选举出一个网络的指定路由器（Designated Router）。

路由器将尝试与其新近获取的邻居建立邻接关系。链路状态数据库在相邻的路由器之间进行同步。在广播和非广播多点接入网络（NBMA）中，指定路由器（Designated Router）决定哪些路由器应成为邻接关系。

邻接关系控制着路由信息的分发。路由更新仅在邻接关系上进行发送和接收。

路由器会定期广播其状态，也称为链路状态。当路由器的状态发生变化时，也会广播链路状态。路由器的邻接关系反映在其链路状态广告（LSA）的内容中。邻接关系与链路状态之间的这种关系，使协议能够及时检测到死掉的路由器。

LSA在整个区域内进行泛洪。泛洪算法具有可靠性，确保区域内所有路由器拥有完全相同的链路状态数据库。该数据库由每个区域内路由器发起的LSA组成。每个路由器根据此数据库计算出一棵以自己为根的最短路径树。这棵最短路径树反过来生成协议的路由表。

---

Moy                         标准轨迹                    [第40页]

RFC 2328                     OSPF第2版                   1998年4月

---

4.1 区域间路由

前一节描述了协议在单一区域内的操作。对于区域内路由，没有其他路由信息是相关的。为了能够路由到区域外的目的地，区域边界路由器会向区域注入额外的路由信息。这些额外信息是自治系统（AS）其余部分拓扑的浓缩。

这种浓缩通过以下方式实现：每个区域边界路由器都定义为连接到骨干区域（backbone）。每个区域边界路由器会总结其连接的非骨干区域的拓扑信息，以便在骨干上传播，从而传递给所有其他区域边界路由器。这样，区域边界路由器就拥有关于骨干区域的完整拓扑信息，以及来自其他区域边界路由器的区域摘要信息。基于这些信息，路由器计算到所有区域间目的地的路径。然后，路由器将这些路径广告到其连接的区域中。这使得区域内部的路由器在转发区域间目的地的流量时，能够选择最佳的出口路由器。

---

4.2 AS外部路由

具有关于其他自治系统信息的路由器，可以将这些信息在整个自治系统内泛洪。该外部路由信息会原封不动地分发给每个参与的路由器。唯一的例外是：外部路由信息不会被泛洪到“存根”区域（详见第3.6节）。

为了利用外部路由信息，必须在整个自治系统内（存根区域除外）知道所有广告外部信息的路由器的路径。因此，这些自治系统边界路由器的位置由（非存根）区域边界路由器进行总结。

---

Moy                         标准轨迹                    [第41页]

RFC 2328                     OSPF第2版                   1998年4月

4.3. 路由协议数据包

OSPF协议直接在IP之上运行，使用IP协议号89。OSPF不提供任何显式的分段/重组支持。当需要分段时，采用IP的分段/重组机制。OSPF协议数据包设计成可以将较大的协议包拆分成多个较小的协议包。建议采用这种做法；应尽可能避免IP分段。

路由协议数据包应始终以IP的TOS字段设置为0进行发送。如果可能的话，路由协议数据包在发送和接收时都应优先于普通的IP数据流量。为了实现这一点，OSPF协议包应将其IP优先级字段设置为“互联网络控制”（详见[Ref5]）。

所有OSPF协议数据包共享一个通用的协议头，详见附录A。OSPF数据包类型列在下表8中，其格式也在附录A中描述。

| 类型 | 数据包名称             | 协议功能                     |
|--------|------------------------|------------------------------|
| 1      | Hello                  | 发现/维护邻居关系           |
| 2      | 数据库描述             | 汇总数据库内容               |
| 3      | 链路状态请求           | 数据库下载                   |
| 4      | 链路状态更新           | 数据库更新                   |
| 5      | 链路状态确认           | 泛洪确认                     |

（表8：OSPF数据包类型）

OSPF的Hello协议使用Hello包来发现和维护邻居关系。数据库描述包和链路状态请求包用于建立邻接关系。OSPF的可靠更新机制由链路状态更新包和链路状态确认包实现。

每个链路状态更新（Link State Update）数据包都携带一组新的链路状态广告（LSAs），这些LSAs距离其起点向外一跳。一个链路状态更新包中可能包含多个路由器的LSAs。每个LSA都标记有其原始路由器的ID以及其链路状态内容的校验和。每个LSA还具有一个类型字段；不同类型的OSPF LSAs在下表9中列出。

除了Hello包之外，OSPF路由协议包仅在邻接关系中传输。这意味着所有的OSPF协议包都只经过一个IP跳数，除了那些通过虚拟邻接关系发送的包。OSPF协议包的IP源地址是邻接关系一端的IP地址，目的地址要么是邻接关系的另一端，要么是一个IP多播地址。

4.4. 基本实现要求

实现OSPF需要以下系统支持：

计时器
    需要两种不同类型的计时器。第一种称为“单次触发计时器”，只触发一次并引发协议事件的处理。第二种称为“间隔计时器”，在连续的时间间隔内触发，用于定期发送数据包。例如，定期广播Hello包就是一个典型的应用。这两种计时器的粒度都是一秒。

    间隔计时器应当实现以避免漂移。在某些路由器实现中，数据包处理可能会影响计时器的执行。当多个路由器连接到同一网络并同时进行广播时，可能会导致路由包的同步（应当避免这种情况）。如果无法实现避免漂移的计时器，应在每次触发时向间隔计时器添加或减去少量随机值。

以下是英文内容的中文翻译：

```
        LS     LSA类型             LSA描述
        type   名称
        ________________________________________________________
        1      Router-LSAs        由所有路由器生成。
                                  该LSA描述
                                  路由器接口在某一区域内的
                                  状态信息。仅在单一区域内泛洪。
        ________________________________________________________
        2      Network-LSAs       由指定路由器为广播和非广播多点接入网络生成。此LSA包含
                                  连接到该网络的路由器列表。仅在单一区域内泛洪。
        ________________________________________________________
        3,4    Summary-LSAs       由区域边界路由器生成，并在相关
                                  区域内泛洪。每个汇总LSA描述
                                  通往区域外、但仍在自治系统内的
                                  目的地的路由（即区域间路由）。
                                  类型3汇总LSA描述通往网络的路由，
                                  类型4汇总LSA描述通往自治系统边界路由器的路由。
        ________________________________________________________
        5      AS-external-LSAs   由自治系统边界路由器生成，并在整个自治系统内泛洪。每个
                                  AS外部LSA描述通往另一个自治系统的目的地的路由。
                                  也可以用AS外部LSA描述该自治系统的默认路由。

Moy                         标准轨迹                        [第44页]

RFC 2328                     OSPF第2版                     1998年4月

            表9：OSPF链路状态广告（LSAs）。
```

IP多播
    某些OSPF数据包采用IP多播数据报的形式。需要支持接收和发送IP多播数据报，以及相应的底层协议支持。OSPF使用的IP多播数据报从不经过超过一跳的传输。因此，不需要具备转发IP多播数据报的能力。关于IP多播的更多信息，请参见[Ref7]。

可变长子网支持
    路由器的IP协议支持必须包括将单一的IP类A、B或C网络号划分为多个不同规模子网的能力。这通常称为可变长子网划分（VLSM）；详细信息请参见第3.5节。

IP超网支持
    路由器的IP协议支持还必须包括将连续的IP类A、B和C网络集合聚合成更大范围的超网（supernet）的能力。超网被提出作为一种改善全球互联网IP路由扩展性的方法。关于IP超网的更多信息，请参见[Ref10]。

底层协议支持
    这里所指的底层协议是网络接入协议，例如以太网数据链路层。在网络接口上线或下线时，必须将相关指示信息传递给OSPF。例如，在以太网中，了解以太网收发器电缆何时被拔出是非常有价值的。

非广播底层协议支持
    在非广播网络中，可以通过提供指示，帮助OSPF的Hello协议识别尝试向已失效或不存在的路由器发送数据包的情况。例如，在X.25分组交换网络（PDN）中，收到带有适当原因和诊断的X.25清除消息（clear）可以表明邻居路由器已失效，这些信息会传递给OSPF。

列表操作原语
    大部分OSPF功能是通过对LSA（链路状态广告）列表的操作来描述的。例如，为了重传给邻居路由器直到收到确认的LSA集合被视为一个列表。任何特定的LSA都可能出现在多个这样的列表中。OSPF实现需要能够操作这些列表，必要时添加或删除其中的LSA。

任务支持
某些在本规范中描述的程序会调用其他程序。有时，这些其他程序应在当前程序完成之前就行执行，也就是说应“内联”执行。这在文本中通过指示执行某个程序的指令来表示。另一些情况下，其他程序只在当前程序完成后才执行，这通过调度任务的指示来表示。

4.5 可选的OSPF功能

OSPF协议定义了几种可选功能。路由器会在其OSPF Hello包、数据库描述包以及LSA中指示其支持的可选功能。这使得支持不同可选功能的路由器可以在单一自治系统中共存。

某些功能必须由连接到特定区域的所有路由器支持。在这种情况下，除非邻居报告的功能匹配（即功能不匹配会阻止邻居关系的建立），否则路由器不会接受邻居的Hello包。例如，外部路由能力（ExternalRoutingCapability）就是这种情况。

其他功能可以在数据库交换过程中协商确定。这通过在数据库描述包中指定可选功能来实现。在这种情况下，如果与邻居的功能不匹配，双方之间只会交换部分链路状态数据库。

路由表的构建过程也会受到可选功能的存在或缺失的影响。例如，由于这些可选功能在LSA中报告，不能执行某些功能的路由器可以在构建最短路径树时被避免。

本备忘录定义的OSPF可选功能如下。更多信息请参见附录A.2。

外部路由能力（ExternalRoutingCapability）
整个OSPF区域可以配置为“存根区”（参见第3.6节）。存根区不会被泛洪外部LSA。该功能由OSPF选项字段中的E位表示（参见A.2节）。为了确保存根区的配置一致，所有与此类区域接口的路由器在其Hello包中必须将E位清除（参见第9.5节和第10.5节）。

5. 协议数据结构

以下是对上述英文内容的中文流畅翻译：

在此文中，OSPF协议的描述主要围绕其在各种协议数据结构上的操作。以下列出了顶层的OSPF数据结构。任何需要进行的初始化操作都已注明。OSPF区域、接口和邻居也有相关的数据结构，这些将在本规范的后续部分进行描述。

路由器ID
    一个32位的数字，用于唯一标识该路由器在自治系统（AS）中的身份。一个可能的实现策略是使用该路由器所属的IP接口地址中最小的那个地址。如果路由器的OSPF路由器ID被更改，必须重启路由器的OSPF软件，才能使新ID生效。在此之前，路由器应清除其自发的链路状态广告（LSA）在路由域中的存储（参见第14.1节），否则这些LSA将会在最大存活时间（MaxAge）内持续存在。

Moy                         标准追踪                    [第47页]

RFC 2328                     OSPF版本2                   1998年4月

区域结构
    每个连接到该路由器的区域都拥有自己的数据结构。该数据结构描述了基本OSPF算法的运行机制。请记住，每个区域都运行一份独立的基本OSPF算法副本。

骨干（区域）结构
    OSPF骨干区域负责区域间路由信息的传播。

配置的虚拟链路
    配置了虚拟链路的区域，该虚拟链路以该路由器作为一端点。为了配置虚拟链路，路由器本身必须是区域边界路由器。虚拟链路由另一端点的路由器ID识别，该端点也是一个区域边界路由器。这两个端点路由器必须连接到同一个区域，称为虚拟链路的中转区域。虚拟链路属于骨干区域，表现得就像两个路由器之间没有编号的点对点网络一样。虚拟链路利用其中转区域的区域内路由信息来转发数据包。虚拟链路的建立和拆除通过为中转区域构建最短路径树来实现。

外部路由列表
    这些是指向自治系统（AS）外部目的地的路由，可能通过与其他路由协议（如BGP）的直接交互、配置参数，或两者的结合（例如，OSPF通过配置的度量值广告动态外部信息）获得。拥有这些外部路由的路由器被称为AS边界路由器。这些路由通过AS外部链路状态广告（AS-external-LSA）由路由器在OSPF路由域中进行广告。

外部链路状态广告（AS-external-LSAs）列表
    这是链路状态数据库的一部分。这些LSA由自治系统（AS）边界路由器生成，包含指向自治系统外部目的地的路由信息。请注意，如果路由器本身就是一个AS边界路由器，那么其中一些AS-external-LSAs是由其自身生成的。

Moy                         标准轨迹                        [第48页]

RFC 2328                     OSPF版本2                     1998年4月

路由表
    由链路状态数据库派生而来。路由表中的每一项都以目的地为索引，包含到该目的地的代价以及一组用于转发数据包的路径。路径由其类型和下一跳描述。更多信息请参见第11节。

图9展示了典型路由器中存在的数据结构集合。图中所示的路由器是RT10，来自图6中的地图。请注意，RT10路由器配置了一个虚拟链路连接到RT11路由器，区域2作为该链路的中转区域。这由图9中的虚线表示。当虚拟链路变为活动状态时，通过为区域2建立最短路径树，它将成为骨干网的一个接口（参见图9中描绘的两个骨干接口）。

6. 区域数据结构

    区域数据结构包含运行基本OSPF路由算法所需的所有信息。每个区域维护自己的链路状态数据库。一个网络属于单一的区域，一个路由器接口也连接到单一的区域。每个路由邻接关系也属于单一的区域。

    OSPF骨干区域是负责传播区域间路由信息的特殊区域。

    区域链路状态数据库由该区域路由器生成的router-LSAs、network-LSAs和summary-LSAs组成。这些信息仅在单一区域内泛洪。AS-external-LSAs（参见第5节）也被视为每个区域链路状态数据库的一部分。

区域ID
    一个32位数字，用于标识该区域。ID为0.0.0.0的区域是保留给骨干区域的。

区域地址范围列表
    为了在区域边界处聚合路由信息，可以使用区域地址范围。每个地址范围由一个[address, mask]对和一个状态指示（广告或不广告，见第12.4.3节）来指定。

+----+
                              |RT10|------+
                              +----+       \+-------------+
                             /      \       |路由表       |
                            /        \      +-------------+
                           /          \
              +------+    /            \    +--------+
              |区域2 |---+              +---|骨干区  |
              +------+***********+          +--------+
             /        \           *        /          \
            /          \           *      /            \
       +---------+  +---------+    +------------+       +------------+
       |接口     |  |接口     |    |虚拟链路    |       |接口 Ib   |
       |连接到N6 |  |连接到N8 |    |到RT11     |       +------------+
       +---------+  +---------+    +------------+             |
           /  \           |               |                   |
          /    \          |               |                   |
   +--------+ +--------+  |        +-------------+      +------------+
   |邻居RT8 | |邻居RT7 |  |        |邻居RT11    |      |邻居RT6   |
   +--------+ +--------+  |        +-------------+      +------------+
                          |
                     +-------------+
                     |邻居RT11     |
                     +-------------+


图9：路由器RT10的数据结构

相关路由器接口
    连接到该区域的路由器接口。一个路由器接口属于且仅属于一个区域（或骨干区）。
    对于骨干区，这个列表包括所有虚拟链路。
    虚拟链路由其另一端的路由器ID标识；其成本是两台路由器之间通过Transit区域的最短区域内路径的成本。

Moy                         标准追踪                        [第50页]

RFC 2328                     OSPF第2版                     1998年4月

路由器-LSA列表
    每个区域中的每台路由器都会生成一个路由器LSA。它描述了该路由器到区域内接口的状态。

网络-LSA列表
    区域内每个中继广播网络和NBMA网络都会生成一个网络LSA。网络LSA描述了当前连接到该网络的路由器集合。

摘要-LSA列表
    摘要LSA由区域边界路由器生成。它们描述了到自治系统内部但区域外部的目的地的路由（即，区域间目的地）。

最短路径树
    以本路由器为根的区域内的最短路径树。通过收集到的路由器LSA和网络LSA，利用Dijkstra算法（参见第16.1节）计算得出。

传输能力
    该参数指示该区域是否能够承载数据流量，即该数据流量既不在该区域内产生，也不在该区域内终止。当构建该区域的最短路径树时（参见第16.1节），会计算此参数；如果该区域作为中转区域，且存在一个或多个完全相邻的虚拟链路使用该区域作为中转区域，则将此参数设置为TRUE。此参数还作为后续路由表构建步骤的输入（参见第16.3节）。当某个区域的传输能力被设置为TRUE时，称该区域为“中转区域”。

外部路由能力
    指示AS外部链路状态广告（LSA）是否会被泛洪到该区域内或通过该区域传播。这是一个可配置参数。如果将AS外部LSA排除在该区域之外，则该区域被称为“stub区域”。在stub区域内，通往AS外部目的地的路由将仅基于默认摘要路由。骨干区域不能配置为stub区域。此外，虚拟链路也不能通过stub区域配置。更多信息请参见第3.6节。

StubDefaultCost
    如果该区域被配置为stub区域，并且该路由器本身是区域边界路由器，则StubDefaultCost表示该路由器应向该区域广告的默认摘要LSA的成本。更多信息请参见第12.4.3节。

除非另有说明，本文件的其余部分涉及OSPF协议在单一区域内的操作。

7. 建立邻接关系

    OSPF在邻居路由器之间建立邻接关系，以便交换路由信息。并非所有邻居路由器都会成为邻接关系。本文介绍建立邻接关系的基本原则。更多细节请参见第10节。

7.1. Hello协议

    Hello协议负责建立和维护邻居关系。它还确保邻居之间的通信是双向的。Hello包会定期从所有路由器接口发送。当路由器在邻居的Hello包中看到自己被列出时，表示双向通信已建立。在广播和非广播多点接入（NBMA）网络中，Hello协议会选举出一个指定路由器（Designated Router）以管理网络。

Hello协议在广播网络、非广播多访问（NBMA）网络和点对多点（Point-to-MultiPoint）网络上的工作方式不同。在广播网络上，每个路由器通过定期多播Hello包来宣传自己。这使得邻居可以动态地被发现。这些Hello包包含了路由器对指定路由器（Designated Router）身份的看法，以及最近看到的Hello包中包含的路由器列表。

在NBMA网络上，为了使Hello协议正常工作，可能需要一些配置。每个可能成为指定路由器的路由器都拥有一份网络中所有其他路由器的列表。当接口首次在NBMA网络上变得可用时，具有成为指定路由器潜力的路由器会向所有其他潜在的指定路由器发送Hello包。这是为了尝试找到该网络的指定路由器。如果该路由器被选为指定路由器，它会开始向所有连接到该网络的路由器发送Hello包。

在点对多点网络上，路由器会向所有可以直接通信的邻居发送Hello包。这些邻居可以通过反向ARP（Inverse ARP）等协议动态发现，也可以通过配置来确定。

在邻居被发现、双向通信得到保证，并且（如果是在广播或NBMA网络上）已选出指定路由器后，就会决定是否与邻居建立邻接关系（参见第10.4节）。如果决定建立邻接关系，第一步就是同步邻居的链路状态数据库。下一节将对此进行详细介绍。

7.2 数据库的同步

在链路状态路由算法中，所有路由器的链路状态数据库保持同步非常重要。OSPF通过只要求相邻路由器保持同步来简化这一过程。同步过程在路由器尝试建立邻接关系时立即开始。每个路由器通过向邻居发送一系列数据库描述包（Database Description packets）来描述其数据库。每个数据库描述包都描述了属于该路由器数据库的一组链路状态广告（LSAs）。当邻居看到一个比自己数据库副本更新的LSA时，会记下这个较新的LSA，表示应请求该LSA的最新版本。

这种发送和接收数据库描述包的过程被称为“数据库交换过程”。在这个过程中，两个路由器形成主从关系。每个数据库描述包都带有一个序列号。由主（发起请求的路由器）发送的数据库描述包（轮询）会被从（响应的路由器）通过回显序列号的方式确认。无论是轮询还是其响应，都包含链路状态数据的摘要。只有主路由器被允许重新传输数据库描述包，并且它只在固定的时间间隔内进行重传，这个间隔由每个接口配置的常量RxmtInterval决定。

每个数据库描述包都包含一个指示后续是否还有更多包的标志位——M位。当一个路由器接收并发送的数据库描述包中M位都关闭时，数据库交换过程结束。

在数据库交换过程期间及之后，每个路由器都会保存一份邻居拥有的、更新更完整的链路状态广告（LSA）列表。这些LSA会在链路状态请求包中被请求。未满足的链路状态请求包会在固定的时间间隔RxmtInterval内被重新传输。当数据库描述过程完成，所有链路状态请求都已满足后，数据库被认为已同步，路由器之间的邻接关系也被标记为完全邻接。此时，邻接关系已完全建立并正常工作，并在两个路由器的路由器LSA中进行广告。

一旦数据库交换过程开始，邻接关系就会被洪泛（flooding）机制使用。这简化了数据库的同步过程，并保证同步在可预期的时间内完成。

7.3. 指定路由器

每个广播网络和非广播多点接入网络（NBMA）网络都必须有一个指定路由器。指定路由器在路由协议中主要执行两个功能：

- 指定路由器代表网络发起一个网络LSA。该LSA列出当前连接到该网络的所有路由器（包括指定路由器自己）。该LSA的链路状态ID（详见第12.1.4节）是指定路由器的IP接口地址。然后，可以通过使用网络的子网/网络掩码来获取该网络的IP网络编号。

以下是英文内容的中文翻译：

```
        o   指定路由器（Designated Router）在网络中与所有其他路由器建立邻接关系。由于链路状态数据库通过邻接建立（adjacency bring-up）和泛洪（flooding）过程在邻接点之间同步，因此指定路由器在同步过程中起着核心作用。

        指定路由器由Hello协议选举产生。路由器的Hello包中包含其路由器优先级（Router Priority），该优先级可以在每个接口上进行配置。通常，当一个路由器的接口首次变得可用时，它会检查网络上是否已有指定路由器。如果已有指定路由器，它会接受该路由器，无论其路由器优先级如何。（这使得预测指定路由器的身份变得更困难，但也减少了指定路由器的变更频率。详见下文。）否则，如果该路由器在网络中的路由器优先级最高，它就会成为指定路由器。关于指定路由器选举的更详细（且更准确）描述，请参见第9.4节。

        指定路由器是许多邻接关系的端点。为了优化广播网络上的泛洪过程，指定路由器会将其链路状态更新包（Link State Update Packets）多播到“AllSPFRouters”地址，而不是通过每个邻接点单独发送包。

        本文第2节讨论了区域的有向图表示。路由器节点用其路由器ID标记。中继网络（Transit network）节点实际上用其指定路由器的IP地址标记。当指定路由器发生变化时，网络图上的节点似乎被替换成了一个全新的节点。这将导致网络及其所有连接的路由器发出新的链路状态广告（LSAs）。在链路状态数据库再次收敛之前，可能会出现临时的连接中断。这可能导致对数据流量返回ICMP不可达（ICMP unreachable）消息。因此，指定路由器应尽量少变更。路由器优先级应被配置为，使得网络中最可靠的路由器最终成为指定路由器。

Moy                         标准追踪                        [第55页]

RFC 2328                     OSPF第2版                     1998年4月

    7.4.  备用指定路由器（Backup Designated Router）
```

为了使切换到新的指定路由器（Designated Router）更加顺畅，每个广播和非广播多点接入（NBMA）网络都配备有一个备份指定路由器（Backup Designated Router）。备份指定路由器也与网络上的所有路由器相邻，当之前的指定路由器发生故障时，它会成为新的指定路由器。如果没有备份指定路由器，当需要选举新的指定路由器时，必须在新指定路由器与网络中所有其他路由器之间建立新的邻接关系。建立邻接关系的过程之一是同步链路状态数据库，这可能会花费相当长的时间。在此期间，网络将无法进行转发数据流量。备份指定路由器的存在避免了重新建立这些邻接关系的需要，因为它们已经存在。这意味着中断转发流量的时间只持续到新LSA（宣布新指定路由器）被洪泛的时间。

备份指定路由器不会为网络生成网络链路状态广告（network-LSA）。如果它这样做，切换到新指定路由器的速度会更快，但这在数据库大小和收敛速度之间存在权衡，尤其是在指定路由器消失时。

备份指定路由器也是通过Hello协议选举出来的。每个Hello包中都包含一个字段，用于指定该网络的备份指定路由器。

在洪泛过程的某些步骤中，备份指定路由器扮演被动角色，让指定路由器承担更多工作。这可以减少本地路由流量。有关更多信息，请参见第13.3节。

7.5. 邻接关系的图示

邻接关系绑定于两个路由器共有的网络。如果两个路由器有多个共同的网络，它们之间可能存在多个邻接关系。

可以将网络上的邻接关系集合想象成一个无向图。图中的顶点代表路由器，若两个路由器相邻，则在它们之间有一条边。邻接关系图描述了路由协议包，特别是链路状态更新包（Link State Update Packets），在自治系统（Autonomous System）中的流动情况。

根据是否为网络选举出指定路由器（Designated Router），可以形成两种不同的图。 在物理点对点网络、点对多点网络以及虚拟链路上，邻接路由器在能够直接通信时就会变得相邻。 相比之下，在广播和非广播多点接入（NBMA）网络中，只有指定路由器（DR）和备份指定路由器（BDR）会与所有连接到网络的其他路由器成为邻接。

图10展示了这些邻接关系的示意图。假设RT7成为了网络N2的指定路由器（DR），而RT3成为备份指定路由器（BDR）。在洪泛过程中，备份指定路由器（RT3）执行的功能比指定路由器（RT7）要少（详见第13.3节）。这也是连接备份指定路由器RT3的虚线的原因。

8. 协议包的处理

本节讨论OSPF路由协议包的一般处理方式。保持路由器的链路状态数据库同步非常重要，因此，路由协议包在发送和接收时应优先于普通数据包。

路由协议包仅在邻接关系中传输（除了用于发现邻接关系的Hello包）。这意味着，除虚拟链路传输的包外，所有路由协议包都只经过一个IP跳。

所有路由协议包都以标准头部开始。下面的章节详细介绍了如何填写和验证这个标准头部。随后，每种包类型的章节会提供关于该类型包处理的具体细节。

8.1  发送路由协议数据包

当路由器发送路由协议数据包时，它会按照以下方式填写标准OSPF数据包头的字段。有关头部格式的详细信息，请参阅第A.3.1节：

版本号
    设置为2，即本规范所记录的协议版本号。

数据包类型
    OSPF数据包的类型，例如链路状态更新（Link State Update）或Hello包。

数据包长度
    整个OSPF数据包的长度（以字节为单位），包括标准的OSPF数据包头。

路由器ID
    发送该数据包的路由器的身份标识。

区域ID
    该数据包所发送到的OSPF区域。

校验和
    整个OSPF数据包（不包括64位的认证字段）经过标准IP 16位一补码校验的结果。此校验和是在相应的认证过程中计算的；对于某些OSPF认证类型，校验和的计算会被省略。详细信息请参见第D.4节。

认证类型（AuType）和认证
    每个OSPF数据包交换都经过认证。认证类型由协议分配，并在附录D中有详细说明。每个IP网络/子网可以使用不同的认证程序。AuType指示所使用的认证程序类型。64位的认证字段由所选的认证程序使用。在形成待发送数据包时，认证程序应作为最后一步调用。详细信息请参见第D.4节。

数据包的IP目标地址的选择如下：在物理点对点网络上，IP目标地址总是设置为AllSPFRouters（所有SPF路由器）。在所有其他类型的网络（包括虚拟链路）上，大多数OSPF数据包以单播方式发送，即直接发送到邻接的另一端。在这种情况下，IP目标地址就是与邻接另一端相关联的邻居IP地址（参见第10节）。唯一不会以单播方式发送的包是在广播网络上；在这些网络上，Hello包会被发送到多播地址AllSPFRouters，指定的路由器（Designated Router）及其备份也会发送链路状态更新（Link State Update）包。

将数据包和链路状态确认包发送到多播地址 AllSPFRouters，而所有其他路由器则将它们的链路状态更新包和链路状态确认包都发送到多播地址 AllDRouters。

链路状态更新包的重传总是直接发送给邻居。在多访问网络中，这意味着重传应发送到邻居的IP地址。

IP源地址应设置为发送接口的IP地址。连接到无编号点对点网络的接口没有关联的IP地址。在这些接口上，IP源应设置为路由器的其他任意IP地址。因此，路由器必须至少分配有一个IP地址。[2] 需要注意的是，在大多数情况下，虚拟链路的行为与无编号点对点网络完全相同。然而，每个虚拟链路确实有一个IP接口地址（在路由表构建过程中发现），在通过虚拟链路发送数据包时用作IP源地址。

关于特定OSPF数据包类型格式的更多信息，请参阅表10中列出的章节。

| 类型 | 数据包名称             | 详细章节（传输）     |
|-------|------------------------|---------------------|
| 1     | Hello                  | 第9.5节             |
| 2     | 数据库描述             | 第10.8节            |
| 3     | 链路状态请求           | 第10.9节            |
| 4     | 链路状态更新           | 第13.3节            |
| 5     | 链路状态确认           | 第13.5节            |

表10：描述OSPF协议数据包传输的章节。

---

Moy 规范追踪 [第60页]

RFC 2328 版本2的OSPF（1998年4月）

---

8.2 接收协议数据包

每当路由器接收到协议数据包时，会标记该数据包是从哪个接口接收的。对于配置了虚拟链路的路由器，可能不立即清楚应将数据包关联到哪个接口。例如，考虑图6中的路由器RT11。如果RT11在其连接到网络N8的接口上接收到一个OSPF协议包，它可能希望将该包关联到区域2的接口，或者关联到与RT10的虚拟链路（该链路是骨干网的一部分）。在以下假设中，我们认为该数据包最初关联到非虚拟链路。

为了在IP层接受该数据包，它必须通过一系列测试，即使在将数据包传递给OSPF处理之前：

- IP校验和必须正确。

- 数据包的IP目标地址必须是接收接口的IP地址，或是所有SPFRouters或所有DRouters的多播地址。

- 指定的IP协议必须是OSPF（89）。

- 本地生成的数据包不应传递给OSPF。也就是说，应检查源IP地址，确保这不是由路由器本身生成的多播包。

接下来，验证OSPF数据包头。头部中指定的字段必须与接收接口的配置相匹配。如果不匹配，应丢弃该数据包：

- 版本号字段必须指定协议版本2。

- 必须验证OSPF头部中的区域ID（Area ID）。如果以下两种情况都不符合，则应丢弃该数据包。头部中指定的区域ID必须满足以下条件之一：

  1. 与接收接口的区域ID匹配。在这种情况下，数据包是经过单跳传送的。因此，数据包的IP源地址应位于与接收接口相同的网络中。这可以通过将数据包的IP源地址和接口的IP地址都与接口掩码进行比较来验证。在点对点网络上不应进行此比较。在点对点网络中，链路两端的接口地址是独立分配的（如果分配的话）。

  2. 表示骨干区域。在这种情况下，数据包是通过虚拟链路传送的。接收的路由器必须是区域边界路由器，且数据包中指定的路由器ID（源路由器）必须是已配置虚拟链路的另一端。接收接口还必须连接到虚拟链路配置的中转区域。如果所有这些检查都通过，则接受该数据包，并将其与虚拟链路（以及骨干区域）关联。

- 只有当接收接口的状态为DR或Backup时，才应接受目标IP为AllDRouters的数据包（详见第9.1节）。

- 数据包中指定的AuType必须与关联区域中配置的AuType相匹配。

必须对数据包进行认证。认证过程由设置的AuType（见附录D）指示。认证过程可以使用一种或多种认证密钥，这些密钥可以在每个接口的基础上进行配置。认证过程还可以验证OSPF数据包头中的校验和字段（当使用时，该字段设置为除去64位认证字段后，OSPF数据包内容的标准IP 16位一补码校验和）。如果认证过程失败，应丢弃该数据包。

如果数据包类型为Hello，则应由Hello协议（见第10.5节）进行进一步处理。所有其他类型的数据包仅在邻接关系中进行发送/接收。这意味着该数据包必须由路由器的某个活动邻居发送。如果接收接口连接的是广播网络、多点网络或非广播多点网络（NBMA），则通过数据包IP头中的源IP地址识别发送者。如果接收接口连接的是点对点网络或虚拟链路，则通过数据包的OSPF头中的路由器ID（源路由器）识别发送者。与接收接口相关联的数据结构中包含活动邻居的列表。任何不匹配任何活动邻居的数据包都将被丢弃。

此时，所有接收的协议数据包都与一个活动邻居相关联。对于特定数据包类型的后续输入处理，请参阅表11中列出的章节。

| 类型 | 数据包名称             | 详细章节（接收）     |
|-------|------------------------|---------------------|
| 1     | Hello                  | 第10.5节            |
| 2     | 数据库描述             | 第10.6节            |
| 3     | 链路状态请求           | 第10.7节            |
| 4     | 链路状态更新           | 第13节              |
| 5     | 链路状态确认           | 第13.7节            |

表11：描述OSPF协议数据包接收的章节。

9. 接口数据结构

OSPF接口是路由器与网络之间的连接。我们假设每个连接的网络/子网只有一个OSPF接口，尽管在附录F中考虑了在单一网络上支持多个接口的情况。每个接口结构最多具有一个IP接口地址。

一个OSPF接口可以被视为属于包含其连接网络的区域。该接口上由路由器发出的所有路由协议数据包都带有该接口的区域ID。一个接口上可能会建立一个或多个路由器邻接关系。路由器的链路状态广告（LSA）反映了其接口及其相关邻接关系的状态。

与接口相关的以下数据项需要注意：其中一些实际上是连接网络的配置项；这些配置项在所有连接到该网络的路由器上必须保持一致。

类型
    OSPF接口的类型可以是点对点（point-to-point）、广播（broadcast）、非广播多点接入（NBMA）、多点（Point-to-MultiPoint）或虚拟链路（virtual link）。

状态
    接口的功能级别。状态决定了是否允许在该接口上形成完整的邻接关系。状态也会反映在路由器的LSA中。

IP接口地址
    与接口关联的IP地址。这是通过该接口发出的所有路由协议数据包中的源IP地址。未编号点对点网络的接口没有关联的IP地址。

IP接口掩码
    也称为子网掩码，用于指示IP接口地址中标识连接网络的部分。用IP接口掩码对IP接口地址进行掩码后，即得到连接网络的IP网络号。在点对点网络和虚拟链路上，IP接口掩码未定义。在这些网络上，链路本身没有分配IP网络号，因此链路两端的地址是独立分配的（如果分配的话）。

区域ID
    所连接网络所属区域的区域ID。所有由该接口发出的路由协议数据包都带有此区域ID的标签。

InfTransDelay（链路传输延迟）
        估算通过该接口传输一份链路状态更新包所需的秒数。在传输之前，链路状态更新包中的LSA（链路状态广告）会将其年龄增加该值。该值应考虑传输和传播延迟，且必须大于零。

Router Priority（路由器优先级）
        一个8位无符号整数。当两个连接到同一网络的路由器都试图成为指定路由器（Designated Router）时，优先级高的路由器优先。当路由器的优先级设置为0时，该路由器不能成为该网络上的指定路由器。该值在通过此接口发送的Hello包中进行广告。

Hello Timer（Hello定时器）
        一个间隔定时器，用于触发接口发送Hello包。该定时器每隔HelloInterval秒触发一次。注意，在非广播网络上，会为每个合格的邻居单独发送Hello包。

Wait Timer（等待定时器）
        一个单次定时器，用于使接口退出等待状态，从而选择网络上的指定路由器。该定时器的持续时间为RouterDeadInterval秒。

邻居路由器列表
        连接到该网络的其他路由器。此列表由Hello协议形成。会与部分邻居建立邻接关系。邻接邻居的集合可以通过检查所有邻居的状态来确定。

Designated Router（指定路由器）
        为连接的网络选定的指定路由器。指定路由器在所有广播和非广播多点接入（NBMA）网络上由Hello协议选出。为指定路由器保存两个标识：其路由器ID和在网络上的IP接口地址。指定路由器会广告网络的链路状态；此网络LSA标记为指定路由器的IP地址。初始化时，指定路由器的地址为0.0.0.0，表示尚未有指定路由器。

Backup Designated Router（备份指定路由器）
        备份指定路由器也由Hello协议在所有广播和NBMA网络上选出。所有连接到该网络的路由器都与指定路由器和备份指定路由器建立邻接关系。当当前的指定路由器失效时，备份指定路由器会成为新的指定路由器。备份指定路由器的地址初始化为0.0.0.0，表示尚未有备份指定路由器。

接口输出成本
    在接口上传输数据包的成本，以链路状态度量表示。 这是在路由器LSA中作为该接口的链路成本进行广告。接口的成本必须大于零。

重传间隔
    针对属于该接口的邻接关系，LSA重传的秒数间隔。 也用于重传数据库描述和链路状态请求包。

认证类型
    附属网络/子网上使用的认证类型。 认证类型在附录D中定义。 所有OSPF包交换都经过认证。 不同的网络/子网可以使用不同的认证方案。

Moy                         标准轨迹                    [第66页]

RFC 2328                     OSPF第2版                   1998年4月

认证密钥
    该配置数据允许生成和/或验证OSPF协议包的认证过程。 认证密钥可以在每个接口级别进行配置。 例如，如果AuType指示简单密码，则认证密钥为一个64位的明文密码，插入到OSPF包头中。 如果AuType指示加密认证，则认证密钥为共享秘密，用于生成/验证消息摘要，这些摘要会附加到OSPF协议包中。 使用加密认证时，支持多个同时使用的密钥，以实现平滑的密钥过渡（参见第D.3节）。

9.1. 接口状态

    本节记录了路由器接口可能达到的各种状态。 状态按功能逐步发展排序。 例如，首先列出非操作状态，然后列出一些中间状态，最后达到完全功能状态。 规范在描述中会用到这种排序，例如“那些状态大于X的接口”。 图11显示了接口状态变化的图示。 图中的弧线标注了引起状态变化的事件。 这些事件在第9.2节中有详细描述。 接口状态机的详细说明在第9.3节中。

下线
    这是初始的接口状态。在此状态下，下层协议已指示该接口不可用。该接口上不会发送或接收任何协议流量。在此状态下，应将接口参数设置为其初始值。所有接口定时器应被禁用，并且该接口不应有任何邻接关系。

环回
    在此状态下，路由器与网络的接口处于环回状态。

（图示部分省略）

除了图中所示的状态转换外，事件“接口下线（InterfaceDown）”总是会强制进入“下线（Down）”状态，而事件“环回指示（LoopInd）”总是会强制进入“环回（Loopback）”状态。

接口可能在硬件或软件层面被环回。该接口将无法进行正常的数据传输。然而，仍然可能希望获取该接口的质量信息，比如通过向接口发送ICMP回显请求（ping）或进行比特误码测试等。因此，IP数据包仍然可以被定向到处于环回状态的接口。为此，这类接口会在路由器的链路状态广告（LSA）中作为单一主机路由进行广告，其目的地址为该IP接口的地址。[4]

等待
    在此状态下，路由器正试图确定网络的（备份）指定路由器的身份。为此，路由器会监控其接收的Hello包。路由器在未从等待状态转换出来之前，不允许选举备份指定路由器或指定路由器。这可以防止不必要的（备份）指定路由器变更。

点对点
    在此状态下，接口已正常工作，并连接到物理点对点网络或虚拟链路。进入此状态后，路由器会尝试与邻居路由器建立邻接关系。Hello包每隔HelloInterval秒向邻居发送一次。

DR其他
    该接口连接到广播或NBMA网络，网络上已由其他路由器被选为指定路由器。在此状态下，路由器本身尚未被选为备份指定路由器。路由器会与指定路由器和备份指定路由器（如果存在）建立邻接关系。

备份
    在此状态下，路由器本身是连接网络的备份指定路由器。当当前的指定路由器发生故障时，它将被提升为指定路由器。路由器会与网络上所有其他路由器建立邻接关系。备份指定路由器在洪泛过程中执行的功能略有不同（参见第13.3节），更多关于备份指定路由器功能的细节请参见第7.4节。

DR
    在此状态下，路由器本身是连接网络的指定路由器。它会与网络上所有其他路由器建立邻接关系。路由器还必须为网络节点生成一个网络LSA。该网络LSA将包含所有连接到该网络的路由器（包括自己）的链路信息。关于指定路由器执行的功能的更多细节，请参见第7.3节。

9.2 触发接口状态变化的事件

状态的变化可以由多种事件引起。这些事件在图11中以带标签的弧线表示。标签定义如下。关于这些事件对OSPF协议操作影响的详细解释，请参见第9.3节。

接口已启用
    低层协议已指示网络接口处于正常运行状态。这使得接口能够从“关闭”状态过渡出来。在虚拟链路上，接口的运行状态指示实际上是最短路径计算的结果（详见第16.7节）。

等待定时器
    等待定时器已触发，表示在选举（备用）指定路由器之前所需的等待期已结束。

已检测到备用路由器
    路由器已检测到网络中是否存在备用指定路由器。这可以通过两种方式实现：第一，可能收到来自邻居的Hello包，声称自己是备用指定路由器；第二，可能收到来自邻居的Hello包，声称自己是指定路由器，并指示没有备用指定路由器。在任何情况下，必须与邻居进行双向通信，即该路由器也必须出现在邻居的Hello包中。此事件标志着等待状态的结束。

邻居变化
    与接口相关联的双向邻居集合发生了变化。需要重新计算（备用）指定路由器。以下邻居变化会引发邻居变化事件。关于邻居状态的详细解释，请参见第10.1节。

    o 已与邻居建立了双向通信。换句话说，邻居的状态已转变为2-Way或更高。

    o 不再与某个邻居进行双向通信。换句话说，邻居的状态已转变为Init或更低。

    o 某个双向邻居新近声明自己为指定路由器或备用指定路由器。这可以通过检查该邻居的Hello包来检测。

    o 某个双向邻居不再声明自己为指定路由器，或不再声明自己为备用指定路由器。这也通过检查该邻居的Hello包来检测。

    o 某个双向邻居的路由优先级（Router Priority）发生了变化。这同样通过检查该邻居的Hello包来检测。

循环指示
    已收到接口已回环（loopback）到自身的指示。该指示可以来自网络管理或底层协议。

非回环指示
    已收到接口不再回环的指示。与循环指示类似，此指示也可以来自网络管理或底层协议。

接口关闭
    底层协议表明该接口不再正常工作。无论当前接口状态如何，新的接口状态都将变为“关闭”。

9.3. 接口状态机

以下是接口状态变化的详细描述。每次状态变化由一个事件（第9.2节）触发。该事件可能会产生不同的效果，具体取决于接口的当前状态。因此，下面的状态机是按当前接口状态和接收的事件组织的。状态机中的每个条目描述了由事件引起的结果新接口状态以及所需的额外操作。

当接口状态发生变化时，可能需要生成新的路由器LSA。有关详细信息，请参见第12.4节。

以下一些必要的操作涉及为邻居状态机生成事件。例如，当接口变得不可用时，必须销毁与该接口相关的所有邻居连接。关于邻居状态机的更多信息，请参见第10.3节。

状态：关闭（Down）

事件：接口上线（InterfaceUp）

新状态：取决于操作例程

操作：启动间隔Hello定时器，定期通过该接口发送Hello包。如果连接的网络是物理点对点网络、点对多点网络或虚拟链路，则接口状态转变为点对点（Point-to-Point）。否则，如果路由器没有资格成为指定路由器（Designated Router），接口状态转变为“其他DR”（DR Other）。

否则，所连接的网络是广播或 NBMA 网络，路由器有资格成为指定路由器。在这种情况下，为了尝试发现所连接网络的指定路由器，接口状态被设置为等待（Waiting），并启动单次等待定时器（Wait Timer）。此外，如果网络是 NBMA 网络，还应检查该接口配置的邻居列表，并为每个也有资格成为指定路由器的邻居生成邻居事件“Start”。

状态：等待（Waiting）

事件：检测到备份（BackupSeen）

新状态：取决于操作例程。

操作：计算所连接网络的备份指定路由器（Backup Designated Router）和指定路由器（Designated Router），详见第9.4节。根据此计算，接口的新状态将是“DR其他（DR Other）”、“备份（Backup）”或“DR”。

状态：等待（Waiting）

事件：等待定时器（WaitTimer）

新状态：取决于操作例程。

操作：计算所连接网络的备份指定路由器和指定路由器，详见第9.4节。根据此计算，接口的新状态将是“DR其他”、“备份”或“DR”。

状态：DR其他（DR Other）、备份（Backup）或DR（DR）

事件：邻居变化（NeighborChange）

新状态：取决于操作例程。

操作：重新计算所连接网络的备份指定路由器和指定路由器，详见第9.4节。根据此计算，接口的新状态将是“DR其他”、“备份”或“DR”。

状态：任何状态（Any State）

事件：接口关闭（InterfaceDown）

新状态：关闭（Down）

操作：重置所有接口变量，禁用接口定时器。同时，销毁与该接口相关的所有邻居连接。这通过对所有相关邻居生成“KillNbr”事件实现（详见第10.2节）。

状态：任何状态（Any State）

事件：环路指示（LoopInd）

新状态：回环（Loopback）

操作：由于该接口不再连接到所连接的网络，执行与上述接口关闭事件相关的操作。

状态：回环（Loopback）

事件：解除环路指示（UnloopInd）

新状态：关闭（Down）

操作：无需采取任何措施。例如，接口变量在进入回环状态时已经被重置。请注意，在接口再次完全正常工作之前，必须接收到接口上线（InterfaceUp）事件。

9.4 选举指定路由器（Designated Router）

本节描述用于计算网络的指定路由器（DR）和备份指定路由器（BDR）的算法。该算法由接口状态机调用。当路由器首次为某个网络运行选举算法时，该网络的DR和BDR都初始化为0.0.0.0。这表示当前没有指定路由器和备份指定路由器。

指定路由器的选举算法如下进行：
将进行计算的路由器称为路由器X。检查与路由器X相连并已建立双向通信的邻居列表。该列表正是路由器X在该网络上的邻居（在此网络上）中状态大于或等于2-Way（参见第10.1节）的邻居集合。路由器X本身也包含在该列表中。然后，从列表中剔除所有不符合成为指定路由器资格的路由器。（优先级为0的路由器不能成为指定路由器。）接下来只考虑剩余在列表中的路由器，执行以下步骤：

（1）记录当前网络的DR和BDR的值，以便后续进行比较。

（2）计算网络的新BDR。只有那些尚未声明自己为DR的路由器才有资格成为BDR。如果列表中有一个或多个路由器已声明自己为BDR（即它们在Hello包中显示自己为BDR，但未显示为DR），则选择优先级最高的路由器作为BDR。如果优先级相同，则选择ID最高的路由器。如果没有路由器声明自己为BDR，则继续进行下一步。

请选择具有最高路由器优先级（再次排除那些已声明自己为指定路由器的路由器），并再次使用路由器ID来打破平局。

（3）计算网络的新指定路由器，方法如下：如果一个或多个路由器已声明自己为指定路由器（即它们在Hello包中显示自己为指定路由器），则优先选择具有最高路由器优先级的路由器作为指定路由器。在平局的情况下，选择路由器ID最高的路由器。如果没有路由器声明自己为指定路由器，则将指定路由器设为新当选的备用指定路由器。

（4）如果路由器X现在成为了新指定路由器或新备用指定路由器，或者不再是指定路由器或备用指定路由器，则重复步骤2和3，然后继续执行步骤5。例如，如果路由器X现在是指定路由器，重复步骤2时，X将不再有资格参与备用指定路由器的选举。这将确保没有路由器同时声明自己为备用指定路由器和指定路由器。

（5）通过这些计算，路由器本身可能成为指定路由器或备用指定路由器。有关这将带来的额外职责，请参见第7.3节和第7.4节。应相应地设置路由器接口的状态。如果路由器本身现在是指定路由器，则新的接口状态为DR；如果是备用指定路由器，则状态为Backup；否则，状态为DR Other。

（6）如果连接的网络是非广播多点接入网络（NBMA网络），且路由器刚刚成为指定路由器或备用指定路由器，则必须开始向那些不具备成为指定路由器资格的邻居（参见第9.5.1节）发送Hello包。这是通过对每个路由器优先级为0的邻居调用邻居事件Start来实现的。

Moy                         标准轨迹                    [第76页]

RFC 2328                     OSPF第2版                   1998年4月

(7) 如果上述计算导致指定路由器（Designated Router）或备用指定路由器（Backup Designated Router）的身份发生变化，与该接口相关联的邻接关系集将需要进行修改。某些邻接关系可能需要建立，而另一些则可能需要断开。为实现这一点，应在所有状态至少为2-路由（2-Way）的邻居上调用事件 AdjOK?。这将促使它们的邻接资格重新被审查（参见第10.3节和第10.4节）。

选举算法复杂的原因在于希望在当前指定路由器失效时，能够有序地从备用指定路由器过渡到正式的指定路由器。这一有序过渡通过引入滞后（hysteresis）机制得以保证：在旧的备用指定路由器接受其新的指定路由器职责之前，不会选出新的备用指定路由器。

上述程序可能会选出同一台路由器既为指定路由器（DR），又为备用指定路由器（BDR），但该路由器本身永远不会是计算路由器（Router X）。被选出的指定路由器可能不是拥有最高路由优先级（Router Priority）的路由器，也不一定是拥有第二高路由优先级的备用指定路由器。如果路由器X本身不具备成为指定路由器的资格，那么在上述程序中可能既没有选出备用指定路由器，也没有选出指定路由器。还应注意，如果路由器X是唯一有资格成为指定路由器的附属路由器，它将自己选为指定路由器，且网络中不会有备用指定路由器。

9.5. 发送Hello包

每个功能正常的路由器接口都会发送Hello包。这些包用于发现和维护邻居关系。在广播和非广播多路访问（NBMA）网络中，Hello包还用于选举指定路由器（DR）和备用指定路由器（BDR）。

Hello包的格式详见第A.3.2节。Hello包包含路由器的路由优先级（用于选择指定路由器），以及接口上发送Hello包的间隔时间（HelloInterval）。此外，Hello包还指示邻居必须多久被听到一次以保持活跃状态（RouterDeadInterval）。所有连接到同一网络的路由器，其HelloInterval和RouterDeadInterval必须相同。Hello包还包含所连接网络的IP地址掩码（Network Mask）。在无编号点对点网络和虚拟链路上，该字段应设置为0.0.0.0。

Hello包的Options字段描述了路由器的可选OSPF功能。在本规范中定义了一项可选功能（参见第4.5节和A.2节）。只有当所连接的区域能够处理AS外部LSA（即不是stub区域）时，Options字段中的E位才应被设置。如果E位设置错误，邻居路由器将拒绝接受该Hello包（参见第10.5节）。未识别的Options字段中的位应设置为零。

为了确保邻接路由器之间的双向通信，Hello包中包含了最近收到的所有路由器的列表。Hello包还包含了路由器当前选择的指定路由器（Designated Router）和备份指定路由器（Backup Designated Router）。如果这些字段的值为0.0.0.0，表示尚未选出。

在广播网络和物理点对点网络上，Hello包每隔HelloInterval秒通过IP多播地址AllSPFRouters发送一次。在虚拟链路上，Hello包作为单播（直接发给虚拟链路的另一端）每隔HelloInterval秒发送一次。在点对多点网络上，每个邻居每隔HelloInterval秒会收到单独的Hello包。关于在NBMA网络上发送Hello包的内容将在下一节中介绍。

---

Moy  规范追踪  [第78页]

RFC 2328  OSPF第2版  1998年4月

9.5.1. 在NBMA网络上发送Hello包

静态配置信息在非广播网络（详见第C.5和C.6节）中可能是必要的，以使Hello协议正常工作。在NBMA（非广播多点接入）网络上，每个有资格成为指定路由器（Designated Router）的连接路由器都会获知网络上所有邻居的情况（通过配置或某种未指明的机制）。每个邻居都被标记为具有其对应的指定路由器资格。

接口状态必须至少达到“等待”状态，才能向NBMA接口发送任何Hello包。Hello包随后会以单播的方式直接发送给部分邻居。有时，Hello包会定期通过定时器发送；有时则作为对收到的Hello包的响应而发送。路由器的Hello发送行为会根据其是否有资格成为指定路由器而有所不同。

如果路由器有资格成为指定路由器，它必须定期向所有同样有资格的邻居发送Hello包。此外，如果该路由器本身是指定路由器或备用指定路由器，它还必须定期向所有其他邻居发送Hello包。这意味着任何两个有资格的路由器之间总是在交换Hello包，这对于正确执行指定路由器选举算法是必要的。为了减少Hello包的数量，NBMA网络上的有资格路由器数量应保持较少。

如果路由器没有资格成为指定路由器，它必须定期向指定路由器和备用指定路由器（如果存在）发送Hello包。它还必须对从任何有资格的邻居（除了当前的指定路由器和备用指定路由器）收到的Hello包作出回复。这是为了与潜在的指定路由器建立初步的双向关系。

在定期向任何邻居发送Hello包时，Hello包之间的间隔由邻居的状态决定。如果邻居处于“Down”状态，则每隔PollInterval秒发送一次Hello包；否则，每隔HelloInterval秒发送一次。

OSPF路由器与其邻居路由器进行通信。每一次单独的通信由一个“邻居数据结构”描述。每个通信都绑定在特定的OSPF路由器接口上，并且通过邻居路由器的OSPF路由器ID或其邻居IP地址（见下文）进行识别。因此，如果OSPF路由器与另一台路由器在多个网络上有共同连接，就会产生多次通信，每次通信由一个唯一的邻居数据结构描述。每个单独的通信在文中被非正式地称为一个“邻居”。

邻居数据结构包含所有与两台邻居之间形成或已形成的邻接关系相关的信息。（但要记住，并非所有邻居都会成为邻接关系。）邻接关系可以看作是两台路由器之间高度发展的对话。

状态
    表示邻居通信的功能级别。详细内容见第10.1节。

不活动计时器
    一个单次触发的定时器，表示最近没有收到来自该邻居的Hello包。计时器的长度为RouterDeadInterval秒。

主/从关系
    当两台邻居交换数据库时，它们形成主/从关系。主路由器发送第一个数据库描述包（Database Description Packet），并且是唯一可以重传的部分。从路由器只能响应主路由器的数据库描述包。主/从关系在ExStart状态中协商确定。

DD序列号
    当前发往邻居的数据库描述包的DD序列号。

最后接收的数据库描述包
    包含在最后一次从邻居接收的数据库描述包中的初始化（I）、更多（M）和主（MS）位、选项字段以及DD序列号。用于判断下一次接收的数据库描述包是否为重复包。

邻居ID
    邻居路由器的OSPF路由器ID。当收到邻居的Hello包时会学习到邻居ID，或者在虚拟邻接的情况下（见第C.4节）进行配置。

邻居优先级
    邻居路由器的路由器优先级。包含在邻居的Hello包中，用于在附属网络中选择指定路由器（Designated Router）。

邻居IP地址
    与相邻路由器接口相连的网络的IP地址。在协议数据包作为单播沿此邻接关系发送时，用作目标IP地址。当邻居被选为指定路由器（参见第12.4.1节）时，也在路由器链路状态广告（LSA）中用作连接网络的链路ID。邻居IP地址是在接收到邻居的Hello包时学习到的。对于虚拟链路，邻居IP地址是在构建路由表的过程中学习到的（参见第15节）。

邻居选项
    邻居支持的可选OSPF功能。在数据库交换过程中学习到（参见第10.6节）。邻居的可选OSPF功能也会在其Hello包中列出。这使得可以拒绝接收的Hello包（即邻居关系甚至不会开始建立），如果在某些关键的OSPF功能上存在不匹配（参见第10.5节）。这些可选OSPF功能在第4.5节中有详细说明。

邻居的指定路由器
    邻居对指定路由器的看法。如果这个邻居就是自己，在本地计算指定路由器时非常重要。仅在广播和非广播多点接入（NBMA）网络上定义。

邻居的备用指定路由器
    邻居对备用指定路由器的看法。如果这个邻居就是自己，在本地计算备用指定路由器时非常重要。仅在广播和非广播多点接入（NBMA）网络上定义。

以下一组变量是LSA的列表。这些列表描述了区域链路状态数据库的子集。本文档定义了五种不同类型的LSA，区域链路状态数据库中可能都存在：路由器LSA、网络LSA，以及第3类和第4类摘要LSA（都存储在区域数据结构中），以及自治系统外部LSA（存储在全局数据结构中）。

链路状态重传列表
    已经被泛洪但尚未确认的LSA列表。这些LSA会在一定间隔内重新传输，直到被确认或邻接关系被破坏。

数据库摘要列表
    构成区域链路状态数据库的所有LSA的完整列表，当邻居进入数据库交换状态时。此列表会在数据库描述包中发送给邻居。

链接状态请求列表
    该列表包含需要从该邻居处接收的链路状态广告（LSA），以便同步两个邻居的链路状态数据库。此列表在接收数据库描述包时创建，然后通过链路状态请求包发送给邻居。当收到适当的链路状态更新包时，该列表会被清空。

Moy                         标准轨迹                    [第82页]

RFC 2328                     OSPF 版本2                   1998年4月

10.1.  邻居状态

    邻居的状态（实际上是与邻居路由器之间的会话状态）在以下章节中进行了描述。这些状态按功能逐步发展排序。例如，首先列出非操作状态（inoperative），然后是一些中间状态，最后达到完全功能的最终状态。规范中利用这种排序，有时会提及“状态大于X的邻居/邻接”。图12和图13展示了邻居状态变化的图示。图中的弧线标注了引起状态变化的事件。邻居事件在第10.2节中有详细描述。

    图12中的图示显示了由Hello协议引起的状态变化。Hello协议负责邻居的发现与维护，以及确保邻居之间的双向通信。

    图13中的图示显示了邻接关系的形成。并非所有相邻的两个路由器都会成为邻接（详见第10.4节）。邻接关系从邻居处于ExStart状态开始形成。在两个路由器确认其主/从关系后，状态转变为Exchange。此时，邻居开始参与泛洪过程，两个邻居开始同步数据库。当同步完成后，邻居处于Full状态，我们称这两个路由器已完全邻接。此时，邻接关系会在LSA中列出。

    关于邻居状态变化的更详细描述，以及每次变化中涉及的其他操作，请参见第10.3节。

下线（Down）
    这是邻居会话的初始状态，表示近期未收到来自邻居的任何信息。在非广播多点接入（NBMA）网络中，仍可能以较低频率向“下线”邻居发送Hello包（详见第9.5.1节）。

以下是英文内容的中文翻译：

```
                                   +----+
                                   |Down|
                                   +----+
                                     |\
                                     | \开始
                                     |  \      +-------+
                             你好   |   +---->|尝试|
                            已接收   |         +-------+
                                     |             |
                             +----+<-+             |已接收你好
                             |初始化|<---------------+
                             +----+<--------+
                                |           |
                                |双向      |单向
                                |已接收   |已接收
                                |           |
              +-------+         |        +-----+
              |ExStart|<--------+------->|双向|
              +-------+                  +-----+

              图12：邻居状态变化（Hello协议）

                  除了图中显示的状态转换外，
                  事件KillNbr总是将状态强制设为Down，
                  事件InactivityTimer总是将状态强制设为Down，
                  事件LLDown总是将状态强制设为Down。






Moy                         标准轨迹                    [第84页]


RFC 2328                     OSPF第2版                   1998年4月


                                  +-------+
                                  |ExStart|
                                  +-------+
                                    |
                     协商完成   |
                                    +->+--------+
                                       |交换|
                                    +--+--------+
                                    |
                            交换|
                              完成  |
                    +----+          |      +-------+
                    |完全|<---------+----->|加载中|
                    +----+<-+              +-------+
                            |  加载完成     |
                            +------------------+

            图13：邻居状态变化（数据库交换）

                除了图中显示的状态转换外，
                事件SeqNumberMismatch强制进入ExStart状态，
                事件BadLSReq强制进入ExStart状态，
                事件1-Way强制进入Init状态，
                事件KillNbr总是将状态强制设为Down，
                事件InactivityTimer总是将状态强制设为Down，
                事件LLDown总是将状态强制设为Down，
                事件AdjOK?导致邻接的建立或断开。
```

尝试（Attempt）
    该状态仅适用于连接到NBMA（非广播多点接入）网络的邻居。它表示尚未从邻居那里接收到最新的信息，但应加大努力与邻居联系。这可以通过以HelloInterval（参见第9.5.1节）为间隔发送邻居Hello包来实现。

初始化（Init）
    在此状态下，最近从邻居那里收到过Hello包。然而，还未与邻居建立双向通信（即，路由器本身未出现在邻居的Hello包中）。所有处于此状态（或更高状态）的邻居，都在从相关接口发送的Hello包中列出。

两端已达（2-Way）
    在此状态下，两个路由器之间的通信已实现双向。这是通过Hello协议的操作确保的。这是建立邻接关系的最早阶段。来自状态2-Way或更高状态邻居的集合中，将选出（备用）指定路由器。

开始（ExStart）
    这是两个邻居路由器建立邻接的第一步。此步骤的目标是决定哪个路由器为主（Master），以及确定初始的DD（数据库描述）序列号。在此状态或更高状态下的邻居会话被称为邻接。

交换（Exchange）
    在此状态下，路由器通过向邻居发送数据库描述包（Database Description packets）来描述其完整的链路状态数据库。每个数据库描述包都带有一个DD序列号，并且会被明确确认。在任何时刻，只允许有一个数据库描述包未被确认。在此状态下，还可以发送链路状态请求包（Link State Request Packets），请求邻居提供更新的LSA（链路状态广告）。所有处于Exchange状态或更高状态的邻接关系都用于泛洪过程。实际上，这些邻接关系完全能够传输和接收所有类型的OSPF路由协议包。

加载（Loading）
    在此状态下，发送链路状态请求包，向邻居请求在Exchange状态中发现但尚未接收的最新LSA。

完全（Full）
    在此状态下，邻居路由器已完全建立邻接关系。这些邻接关系现在会出现在路由器LSA（router-LSA）和网络LSA（network-LSA）中。

RFC 2328                     OSPF 版本 2                   1998年4月

10.2  导致邻居状态变化的事件

状态的变化可以由多种事件引起。这些事件在图12和图13的弧线标签中显示。标签的定义如下：

HelloReceived
    已经从邻居那里接收到Hello包。

Start
    表示现在应以HelloInterval秒的间隔向邻居发送Hello包。此事件仅在与NBMA网络相关的邻居中生成。

2-WayReceived
    两个邻居路由器之间已实现双向通信。这由路由器在邻居的Hello包中看到自己而表示。

NegotiationDone
    已经协商完成主/从关系，并交换了数据库描述（DD）序列号。这标志着开始发送和接收数据库描述包。关于此事件的生成，详见第10.8节。

ExchangeDone
    两个路由器都已成功传输完整的数据库描述序列。每个路由器现在都知道其链路状态数据库中哪些部分是过时的。关于此事件的生成，详见第10.8节。

BadLSReq
    收到一个针对数据库中不存在的LSA的链路状态请求（LSA请求）。这表明数据库交换过程中出现了错误。

Loading Done
    已经接收了所有过时部分的链路状态更新。这由数据库交换完成后，链路状态请求列表变为空来表示。

AdjOK?
    必须决定是否应与邻居建立或维护邻接关系。此事件将启动一些邻接关系的建立，同时也可能破坏其他邻接关系。

以下事件会导致已建立良好的邻居关系退回到较低的状态。与上述事件不同，这些事件可能在邻居会话处于任何状态时发生。

SeqNumberMismatch
            收到的数据库描述包存在以下情况之一：
            a) 具有意外的DD序列号；
            b) 意外设置了Init位；
            c) 选项字段与上次接收到的数据库描述包中的选项字段不同。这些情况中的任何一种都表明在邻居关系建立过程中发生了错误。

1-Way
            从邻居处收到一个Hello包，但其中未提及本路由器。这表明与邻居的通信不是双向的。

KillNbr
            这是一个指示，表明与该邻居的所有通信现在都不可能了，强制邻居回到Down状态。

InactivityTimer
            活动计时器已触发。这意味着最近没有收到来自邻居的Hello包。邻居状态将回到Down。

LLDown
            这是来自底层协议的指示，表明邻居现在无法到达。例如，在X.25网络中，这可以由X.25的清除指示（clear indication）以及相应的原因和诊断字段表示。此事件会将邻居强制置于Down状态。

10.3. 邻居状态机

        下面是邻居状态变化的详细描述。每次状态变化由一个事件（见第10.2节）触发。该事件可能会产生不同的效果，具体取决于邻居的当前状态。因此，以下状态机按邻居的当前状态和接收的事件进行组织。状态机中的每个条目描述由事件引发的结果新邻居状态以及所需的额外操作。

        当邻居的状态发生变化时，可能需要重新运行指定路由器（Designated Router, DR）选举算法。这取决于是否生成了接口的邻居变化事件（参见第9.2节）。此外，如果接口处于DR状态（即本路由器本身是指定路由器），邻居状态的变化可能会导致生成新的网络LSA（参见第12.4节）。

        当邻居状态机需要调用接口状态机时，应作为计划任务（参见第4.4节）进行。这简化了流程，确保两个状态机不会递归执行。

状态：Down

事件：Start

新状态：Attempt

操作：向邻居（该邻居始终与一个NBMA网络相关联）发送一个Hello包，并启动邻居的非活动计时器。计时器的后续触发表明未能与邻居建立通信。

状态：尝试（Attempt）

Moy                         标准轨迹                    [第89页]

RFC 2328                     OSPF第2版                   1998年4月

事件：收到Hello包（HelloReceived）

新状态：初始化（Init）

操作：重新启动邻居的非活动计时器，因为已收到邻居的消息。

状态：下线（Down）

事件：收到Hello包（HelloReceived）

新状态：初始化（Init）

操作：启动邻居的非活动计时器。计时器的后续触发表明邻居已死。

状态：初始化或更高（Init or greater）

事件：收到Hello包（HelloReceived）

新状态：无状态变化（No state change）

操作：重新启动邻居的非活动计时器，因为再次收到邻居的消息。

状态：初始化（Init）

事件：收到双向通信确认（2-WayReceived）

新状态：取决于操作例程（Depends upon action routine）

操作：判断是否应与邻居建立邻接关系（参见第10.4节）。如果不应建立，邻居状态为双向（2-Way）。

否则（应建立邻接关系），邻居状态转为开始协商（ExStart）。进入此状态后，路由器会在邻居数据结构中递增数据库描述（DD）序列号。如果这是首次尝试建立邻接关系，应为DD序列号赋予唯一值（如当前时间）。然后，路由器宣布自己为主（将主/从位设置为主），并开始发送数据库描述包，设置初始化（I）、更多（M）和主（MS）位。此数据库描述包应为空，且应在重传间隔（RxmtInterval）内不断重传，直到进入下一状态（参见第10.8节）。

状态：开始协商（ExStart）

事件：协商完成（NegotiationDone）

新状态：交换（Exchange）

操作：路由器必须在邻居数据库摘要列表中列出其整个区域链路状态数据库的内容。区域链路状态数据库由区域结构中包含的路由器LSA、网络LSA和摘要LSA组成，以及全局结构中包含的AS外部LSA。虚拟邻居的数据库摘要列表中省略AS外部LSA。如果区域被配置为存根（参见第3.6节），则也会省略AS外部LSA。年龄等于MaxAge的LSA将被加入邻居的链路状态重传列表。数据库摘要列表的摘要将通过数据库描述包发送给邻居。每个数据库描述包具有一个DD序列号，并且会被明确确认。在任何时刻，只允许有一个数据库描述包处于待发状态。关于数据库描述包的发送和接收的更多细节，请参见第10.8节和第10.6节。

状态：交换（Exchange）

事件：交换完成（ExchangeDone）

新状态：取决于操作例程。

操作：如果邻居的链路状态请求列表为空，则新邻居状态为完全（Full）。无需其他操作。这是邻居关系的最终状态。否则，新邻居状态为加载（Loading）。开始（或继续）向邻居发送链路状态请求包（参见第10.9节），请求邻居提供更新的LSA（这些LSA已被发现但尚未在交换状态中接收）。这些LSA列在与邻居相关联的链路状态请求列表中。

状态：加载（Loading）

事件：加载完成（Loading Done）

新状态：完全（Full）

操作：无需操作。这是邻居关系的最终状态。

状态：两端（2-Way）

事件：邻居确认（AdjOK？）

新状态：取决于操作例程。

行动：确定是否应与邻居路由器建立邻接（参见第10.4节）。如果不应，则邻居状态保持在双向（2-Way）；否则，将邻居状态转变为ExStart，并执行与上述状态机入口对应的状态Init和事件2-WayReceived相关的操作。

摩伊（Moy）  标准轨迹  [第92页]

RFC 2328  OSPF第2版  1998年4月

状态：ExStart或更高

事件：AdjOK？

新状态：取决于操作例程。

行动：判断邻居路由器是否仍应保持邻接关系。如果是，则无需更改状态，也不需要采取进一步行动。

否则，可能部分形成的邻接关系必须被破坏。邻居状态转变为双向（2-Way）。链路状态重传列表、数据库摘要列表和链路状态请求列表中的LSA（链路状态广告）将被清空。

状态：Exchange或更高

事件：SeqNumberMismatch（序列号不匹配）

新状态：ExStart

行动：拆除（可能部分形成的）邻接关系，然后尝试重新建立。邻居状态首先转变为ExStart。链路状态重传列表、数据库摘要列表和链路状态请求列表中的LSA将被清空。然后，路由器在邻居数据结构中递增DD序列号，声明自己为主（设置主/从位为主），并开始发送数据库描述包（Database Description Packets），其中设置初始化（I）、更多（M）和主（MS）位。此数据库描述包应为空（详见第10.8节）。

状态：Exchange或更高

事件：BadLSReq（不良链路状态请求）

新状态：ExStart

行动：对事件BadLSReq的处理与邻居事件SeqNumberMismatch完全相同。拆除（可能部分形成的）邻接关系，然后尝试重新建立。更多信息请参见在状态为Exchange或更高时生成事件SeqNumberMismatch时调用的邻居状态机入口。

状态：任何状态

事件：KillNbr

新状态：下线（Down）

操作：清除链路状态重传列表、数据库摘要列表和链路状态请求列表中的LSA。同时，禁用非活动计时器。

适用状态：任何状态

事件：链路状态变为下线（LLDown）

新状态：下线（Down）

操作：清除链路状态重传列表、数据库摘要列表和链路状态请求列表中的LSA。同时，禁用非活动计时器。

适用状态：任何状态

事件：非活动计时器（Inactivity Timer）触发

新状态：下线（Down）

操作：清除链路状态重传列表、数据库摘要列表和链路状态请求列表中的LSA。

适用状态：2路（2-Way）或更高

事件：收到单向通信（1-WayReceived）

新状态：初始化（Init）

操作：清除链路状态重传列表、数据库摘要列表和链路状态请求列表中的LSA。

适用状态：2路或更高

事件：收到双向通信（2-WayReceived）

新状态：无状态变化（No state change）

操作：无需操作。

适用状态：初始化（Init）

事件：收到单向通信（1-WayReceived）

新状态：无状态变化（No state change）

操作：无需操作。

第10.4节 是否建立邻接关系

邻接关系是在路由器的某些邻居之间建立的。通过点对点网络、点对多点网络和虚拟链路连接的路由器总是会建立邻接关系。在广播和非广播多点接入（NBMA）网络中，所有路由器都将与指定路由器（Designated Router）和备份指定路由器（Backup Designated Router）建立邻接关系。

形成邻接关系的决策在邻居状态机中有两个时机：一是在最初建立双向通信时，二是在附属网络的（备份）指定路由器身份发生变化时。如果决定不建立邻接关系，邻居通信状态将停留在2路。

当满足以下至少一项条件时，应与双向邻居建立邻接关系：

- 基础网络类型为点对点（point-to-point）
- 基础网络类型为点对多点（Point-to-MultiPoint）
- 基础网络类型为虚拟链路（virtual link）
- 本路由器是指定路由器（Designated Router）
- 本路由器是备份指定路由器（Backup Designated Router）
- 邻居路由器是指定路由器（Designated Router）

10.5 接收Hello包

本节详细说明了接收Hello包的处理过程。（请参见第A.3.2节了解Hello包的格式。）OSPF包的通用输入处理会先验证IP头和OSPF包头的有效性。接下来，必须检查接收到的Hello包中的网络掩码（Network Mask）、Hello间隔（HelloInterval）和邻居失效时间（RouterDeadInterval）字段的值是否与配置在接收接口上的值一致。任何不匹配都将导致处理停止并丢弃该包。换句话说，上述字段实际上描述的是所连接网络的配置。然而，有一个例外：在点对点网络和虚拟链路上，应忽略接收Hello包中的网络掩码。

接收接口连接到单一的OSPF区域（这可能是骨干区）。在Hello包的Options字段中找到的E位（ExternalRoutingCapability）必须与该区域的设置相匹配。如果区域内没有泛洪AS外部链路状态广告（即该区域是“stub”区域），则接收的Hello包中的E位必须清除，否则必须设置。任何不匹配都将导致处理停止并丢弃该包。其余Options字段中的位的设置应被忽略。

此时，系统会尝试将Hello包的源地址与接收接口的邻居进行匹配。如果接收接口连接的是广播、多点（Point-to-MultiPoint）或非广播多点（NBMA）网络，则源地址由Hello包中的IP源地址识别；如果连接的是点对点链路或虚拟链路，则由Hello包头中的Router ID识别。接口的当前邻居列表存储在接口的数据结构中。如果找不到匹配的邻居结构（即首次检测到该邻居），则会创建一个新的邻居结构。新邻居的初始状态设置为“Down”。

当在广播、点对多点或非广播多点（NBMA）网络上接收到来自邻居的Hello包时，应将邻居结构中的邻居ID设置为在该包的OSPF头部中找到的路由器ID。对于这些网络类型，还应将邻居结构中的路由器优先级字段、指定路由器字段以及备用指定路由器字段设置为与接收到的Hello包中相应字段相同；这些字段的变化应被注意，以备后续步骤中使用。当在点对点网络（但非虚拟链路）上接收到Hello包时，应将邻居结构中的邻居IP地址设置为包的源IP地址。

接下来，检查Hello包的其余部分，生成事件以传递给邻居和接口状态机。这些状态机被规定为要么立即执行，要么调度执行（参见第4.4节）。例如，通过在下面指定邻居状态机立即执行，可以通过单个接收的Hello包引发多个邻居状态转换：

- 每个Hello包都会触发邻居状态机的执行，事件为HelloReceived。

- 然后检查Hello包中包含的邻居列表。如果该路由器本身出现在此列表中，则应以事件2-WayReceived执行邻居状态机。否则，应以事件1-WayReceived执行邻居状态机，包的处理到此结束。

- 接着，如果注意到邻居的路由器优先级字段发生了变化，则应以事件NeighborChange调度接收接口的状态机。

- 如果邻居同时声明自己为指定路由器（Hello包中的Designated Router字段等于邻居的IP地址）且包中的备用指定路由器字段为0.0.0.0，并且接收接口处于等待状态，则应以事件BackupSeen调度接收接口的状态机。否则，如果邻居声明自己为指定路由器，而之前未如此声明，或者之前声明为指定路由器但现在不再如此，则应以事件NeighborChange调度接收接口的状态机。

如果邻居声明自己是备份指定路由器（Hello包中的备份指定路由器字段=邻居IP地址），且接收接口处于等待状态，则接收接口的状态机会被调度处理事件BackupSeen。否则，如果邻居声明自己是备份指定路由器，但之前没有如此声明，或者之前声明过但现在不再声明，则接收接口的状态机会被调度处理事件NeighborChange。

在非对等网络（NBMA）中，收到Hello包后，可能会响应性地向邻居发送一个Hello包。有关详细信息，请参见第9.5.1节。

---

Moy  标准轨迹  [第98页]

RFC 2328  OSPF版本2  1998年4月

10.6 接收数据库描述包

本节详细说明接收数据库描述包的处理过程。收到的数据库描述包已通过第8.2节中的通用输入包处理程序与邻居和接收接口关联。是否接受该数据库描述包，以及接受后应如何进一步处理，取决于邻居的状态。

如果接受数据库描述包，应将以下字段保存到对应邻居数据结构中的“最后接收的数据库描述包”部分：包的初始化（I）、更多（M）和主（MS）位，Options字段，以及DD序列号。如果连续收到两个来自邻居的数据库描述包，这些字段在两个包中设置得完全相同，则第二个包被视为“重复”。

如果数据库描述包中的接口MTU字段指示的IP数据报大小大于路由器在接收接口上能接受而无需分片的大小，则拒绝该数据库描述包。否则，邻居状态为：

- Down（关闭）
  应拒绝该包。

- Attempt（尝试）
  应拒绝该包。

- Init（初始化）
  应以事件2-WayReceived执行邻居状态机。这会立即将状态转换为2-Way或ExStart状态。如果新状态为ExStart，则应继续在该新状态下处理当前包，方法是继续执行下面的ExStart部分。

RFC 2328                     OSPF 版本 2                   1998年4月

2-路
    应忽略该数据包。数据库描述包（Database Description Packets）仅用于建立邻接关系的目的。[7]

ExStart
    如果接收到的数据包符合以下情况之一，则应执行邻居状态机，事件为 NegotiationDone（导致状态转变为 Exchange），同时应将该数据包的 Options 字段记录在邻居结构的 Neighbor Options 字段中，并将该数据包视为下一序列的包，进行进一步处理（见下文）。否则，应忽略该数据包。

    o   初始化（I）、更多（M）和主（MS）位都被设置，数据包内容为空，且邻居的路由器ID大于本路由器的ID。在这种情况下，路由器成为从属（Slave）。将主/从（Master/Slave）位设置为从属，并将邻居数据结构中的 DD 序列号设置为由主节点指定的值。

    o   初始化（I）和主（MS）位都未被设置，数据包的 DD 序列号等于邻居数据结构中的 DD 序列号（表示确认），且邻居的路由器ID小于本路由器的ID。在这种情况下，路由器成为主（Master）。

Exchange
    重复的数据库描述包（Database Description packets）由主节点丢弃，并导致从节点重传其最后发送的数据库描述包。否则（数据包不是重复的）：

    o   如果 MS 位的状态与连接的主从状态不一致，则生成邻居事件 SeqNumberMismatch，并停止处理该数据包。

    o   如果设置了初始化（I）位，则生成邻居事件 SeqNumberMismatch，并停止处理该数据包。

    o   如果数据包的 Options 字段显示的可选 OSPF 功能集与之前从邻居处接收的不同（记录在邻居结构的 Neighbor Options 字段中），则生成邻居事件 SeqNumberMismatch，并停止处理该数据包。

数据库描述包必须按序处理，序列由包中的DD序列号指示。如果路由器是主机，接收到的下一个包的DD序列号应等于邻居数据结构中的DD序列号；如果路由器是从机，接收到的包的DD序列号应比邻居数据结构中的DD序列号大一。在任何情况下，如果包是按序的，应接受该包并按照下述规定处理其内容。

否则，应生成邻居事件SeqNumberMismatch并停止处理该包。

加载或完整状态
在此状态下，路由器已发送并接收了完整的数据库描述包序列。唯一应接收的包应为重复包（见上文）。特别是，包的Options字段应与邻居之前指示的可选OSPF能力集相匹配（存储在邻居结构的Neighbor Options字段中）。任何其他接收的包，包括设置了Initialize(I)位的包，都应生成邻居事件SeqNumberMismatch。[8] 主机应丢弃重复包。从机应通过重复其已发送的最后一个数据库描述包来响应重复包。

当路由器将接收的数据库描述包视为序列中的下一个包并接受时，应按以下方式处理包内容。对于列出的每个LSA，应检查该LSA的LS类型是否有效。如果LS类型未知（例如，不是本规范定义的1-5类型之一），或如果这是一个AS外部LSA（LS类型=5）且邻居属于一个存根区域，则应生成邻居事件SeqNumberMismatch并停止处理该包。否则，路由器会在其数据库中查找该LSA，确认是否也存在该LSA的实例。如果不存在，或数据库中的副本较旧（参见第13.1节），则将该LSA放入链路状态请求列表，以便在链路状态请求包中请求（立即或稍后）获取。

当路由器接受一个作为序列中下一个包的数据库描述包时，还会根据其是主机还是从机执行以下操作：

主机
    在邻居数据结构中递增数据库描述（DD）序列号。如果路由器已经发送完全部的数据库描述包，并且刚刚接收的包中的“更多”位（M）被设置为0，则会生成邻居事件ExchangeDone。否则，应向从机发送新的数据库描述。

从机
    将邻居数据结构中的DD序列号设置为接收到的包中的DD序列号。从机必须回复一个数据库描述包。如果接收的包中的“更多”位（M）被设置为0，并且从机将要发送的包中的M位也将设置为0，则会生成邻居事件ExchangeDone。注意，从机总是在主机之前生成此事件。

10.7. 接收链路状态请求包

本节详细说明接收链路状态请求包的处理过程。接收的链路状态请求包指定邻居希望接收的LSA（链路状态广告）列表。当邻居处于交换（Exchange）、加载（Loading）或完全（Full）状态时，应接受链路状态请求包。在所有其他状态下，应忽略链路状态请求包。

每个在链路状态请求包中指定的LSA都应在路由器的数据库中找到，并复制到链路状态更新包中，以便传送给邻居。这些LSA不应放入邻居的链路状态重传列表中。如果在数据库中找不到某个LSA，说明数据库交换过程出现了问题，应生成邻居事件BadLSReq。

10.8. 发送数据库描述包

本节描述如何向邻居发送数据库描述包。数据库描述包的接口MTU字段应设置为能在不分段的情况下，从发送接口发送的最大IP数据报的大小。互联网中常用的MTU可以在[Ref22]的表7-1中找到。在通过虚拟链路发送的数据库描述包中，接口MTU应设置为0。

路由器的可选OSPF功能（见第4.5节）会在数据库描述包的Options字段中传送给邻居。路由器应在整个数据库交换和泛洪过程中保持相同的可选功能集。如果由于某种原因，路由器的可选功能发生变化，应通过返回到邻居状态ExStart来重新启动数据库交换过程。本文档定义了一项可选功能（见第4.5节和附录A.2）。当且仅当所连接的网络属于非存根区时，应设置E位。在Options字段中未识别的位应设置为零。

数据库描述包的发送依赖于邻居的状态。在ExStart状态下，路由器会发送空的数据库描述包，设置初始化（I）、更多（M）和主（MS）位。这些包每隔RxmtInterval秒重传一次。

在Exchange状态下，数据库描述包实际上包含了路由器数据库中链路状态信息的摘要。邻居在进入Exchange状态时，区域内每个LSA（链路状态广告）都列在邻居的数据库摘要列表中。每个新的数据库描述包会从邻居的数据结构中复制其DD序列号，然后描述当前数据库摘要列表的顶部内容。当前一个包被确认后，相关条目会从摘要列表中移除。

在Exchange状态下，何时发送数据库描述包的决定取决于路由器是主（Master）还是从（Slave）：

主路由器
- 当从路由器通过回显DD序列号确认之前的数据库描述包，或者在没有确认的情况下经过RxmtInterval秒后，主路由器会发送数据库描述包，重新传输之前的包。

从路由器
- 仅在响应从主路由器收到的数据库描述包时发送。如果从主路由器收到的数据库描述包是新的，则会发送新的数据库描述包；否则，会重发之前的数据库描述包。

在“加载中”和“完整”状态下，从站必须对从主机接收到的重复的数据库描述包重新发送其最后一次的数据库描述包。因此，从站必须等待RouterDeadInterval秒后，才能释放最后的数据库描述包。在此间隔之后，从主机发来的数据库描述包将会引发SeqNumberMismatch邻居事件。

10.9  发送链路状态请求包

在邻居状态为“交换”或“加载”时，链路状态请求列表包含需要从邻居获取的那些LSA（链路状态广告）。为了请求这些LSA，路由器会将链路状态请求列表的开头部分打包成链路状态请求包，发送给邻居。

当邻居用适当的链路状态更新包响应这些请求时，链路状态请求列表会被截断，并且会发送新的链路状态请求包。这个过程会持续进行，直到链路状态请求列表变为空。那些已请求但尚未收到的LSA会被打包成链路状态请求包，以RxmtInterval的间隔进行重传。在任何时刻，最多只能有一个链路状态请求包处于未完成状态。

当链路状态请求列表为空，并且邻居状态为“加载中”（即已向邻居发送并接收完完整的数据库描述包序列）时，会生成“加载完成”邻居事件。

10.10  一个示例

图14展示了邻接关系形成的一个示例。路由器RT1和RT2都连接在一个广播网络上。假设RT2是该网络的指定路由器（Designated Router），并且RT2的路由器ID高于RT1。

每个路由器实现的邻居状态变化列在图的两侧。

在图14的开始阶段，RT1的接口开始正常工作。它开始发送Hello包，虽然还不知道指定路由器或其他邻居路由器的身份。RT2听到这个Hello（将邻居状态转为“初始化”），并在其下一次Hello包中表明自己是指定路由器，并且已收到RT1的Hello包。这反过来促使RT1进入“开始”状态，开始建立邻接关系。

RT1首先宣布自己为主（master）。当它发现RT2确实是主（因为RT2的路由器ID更高）时，RT1就会转变为从（slave）状态，并采用其邻居的数据库描述（DD）序列号。随后，双方会交换数据库描述包，主（RT2）发起轮询（poll），从（RT1）则作出响应。这一系列的数据库描述交换过程如下图所示。

Moy                         标准轨迹                   [第105页]

RFC 2328                     OSPF版本2                   1998年4月

+---+                                         +---+
|RT1|                                         |RT2|
+---+                                         +---+

下线                                          下线
                        Hello（DR=0，seen=0）
                   ------------------------------>
                     Hello（DR=RT2，seen=RT1，...）      初始化
                   <------------------------------
            ExStart        D-D（序列号=x，I，M，主）
                   ------------------------------>
                       D-D（序列号=y，I，M，主）        ExStart
                   <------------------------------
            交换       D-D（序列号=y，M，从）
                   ------------------------------>
                       D-D（序列号=y+1，M，主）        交换
                   <------------------------------
                       D-D（序列号=y+1，M，从）
                   ------------------------------>
                                 ...
                                 ...
                                 ...
                       D-D（序列号=y+n，主）
                   <------------------------------
                       D-D（序列号=y+n，从）
加载   ------------------------------>
                         LS请求                完整
                   ------------------------------>
                         LS更新
                   <------------------------------
                         LS请求
                   ------------------------------>
                         LS更新
                   <------------------------------
             完整

Moy                         标准轨迹                   [第106页]

RFC 2328                     OSPF版本2                   1998年4月

图14：邻接建立示例

当轮询（poll）和对应的响应都关闭了M位（Master bit）后，包的交换结束。

在这个例子中，假设RT2拥有一份完全最新的数据库。在这种情况下，RT2会立即进入完全状态（Full）。RT1在更新其数据库的必要部分后，也会进入完全状态。这一过程通过发送链路状态请求包（Link State Request Packets）并接收链路状态更新包（Link State Update Packets）来完成。需要注意的是，虽然RT1在发送任何链路状态请求包之前，等待从RT2接收完整的数据库描述包（Database Description Packets），但实际上并不一定非得如此。RT1也可以在接收数据库描述包的同时，交错地发送链路状态请求包。

11. 路由表结构

路由表的数据结构包含了将IP数据包转发到目的地所需的所有信息。每个路由表项描述了到某一特定目的地的最佳路径集合。在转发IP数据包时，会找到与数据包的IP目的地最匹配的路由表项。然后，该匹配的路由表项会提供通向目的地的下一跳信息。OSPF还支持存在默认路由（目的地ID=DefaultDestination，地址掩码=0x00000000）。当存在默认路由时，它会匹配所有IP目的地（尽管其他任何匹配项都可能是更优的匹配）。关于如何找到最匹配IP目的地的路由表项，详见第11.1节。

每个路由器中只有一张路由表。第11.2节和第11.3节将介绍两个示例路由表。路由表的构建过程在第16节中讨论。

本节其余部分定义了路由表项中的字段。第一组字段描述了路由表项的目的地。

目的地类型
目的地类型可以是“网络”或“路由器”。在转发IP数据流量时，只有网络条目会被实际使用。路由器路由表条目仅作为在构建路由表过程中的中间步骤。

网络是IP地址的范围，IP数据流量可以被转发到该范围内。这包括IP网络（A类、B类或C类）、IP子网、IP超网以及单一IP主机。默认路由也属于此类别。

路由条目用于区域边界路由器和自治系统（AS）边界路由器。当计算区域间路由（参见第16.2节）以及维护配置的虚拟链路（参见第15节）时，区域边界路由器的路由表条目会被使用。自治系统边界路由器的路由表条目则用于计算自治系统外部路由（参见第16.4节）。

目标ID
    目标的标识符或名称。这取决于目标类型。对于网络，标识符是其相关联的IP地址；对于路由器，标识符是OSPF路由器ID。[9]

地址掩码
    仅对网络定义。网络的IP地址结合其地址掩码定义了一个IP地址范围。对于IP子网，地址掩码被称为子网掩码。对于主机路由，掩码为“全1”（0xffffffff）。

可选能力
    当目标是路由器时，此字段指示目标路由器支持的可选OSPF能力。此规范定义的唯一可选能力是处理AS外部链路状态公告（LSA）的能力。关于OSPF可选能力的进一步讨论，请参见第4.5节。

到某个目标的路径集合可能会根据所属的OSPF区域而不同。这意味着，对于同一目标，可能会有多个路由表条目，具体取决于“下一跳”字段的值。

区域
    此字段指示导致路由表条目中路径集合的链路状态信息所属的区域。这被称为条目的关联区域。对于AS外部路径集，此字段未定义。对于“路由器”类型的目标，可能会有与每个区域相关联的不同路径集（因此也有不同的路由表条目）。例如，当两个区域边界路由器共享多个公共区域时，就会出现这种情况。对于“网络”类型的目标，只会保留与最佳区域（提供首选路径的区域）相关联的路径集。

路由表条目的其余部分描述到目标的路径集合。以下字段涉及整个路径集。换句话说，路由表条目中包含的每一条路径都具有相同的路径类型和成本（详见下文）。

路径类型
    有四种可能的路径类型用于将流量路由到目的地，按偏好程度递减列出：
    区域内路径、区域间路径、类型1外部路径或类型2外部路径。
    区域内路径表示目的地属于路由器所连接的某个区域。区域间路径是指通往其他OSPF区域的目的地的路径。这些路径通过检查接收到的摘要LSA（链路状态公告）来发现。AS外部路径是指通往AS（自治系统）外部目的地的路径。这些路径通过检查接收到的AS外部LSA来检测。

成本
    到目的地路径的链路状态成本。除类型2外部路径外，所有路径的成本描述整个路径的成本。对于类型2外部路径，该字段描述路径内部部分的成本。该成本是通过将路径中各个链路的成本相加得出的。

类型2成本
    仅对类型2外部路径有效。对于这些路径，该字段表示路径外部部分的成本。此成本由边界路由器广告，是总路径成本中最重要的部分。例如，一个类型2外部路径的类型2成本为5，总是优先于类型2成本为10的路径，无论这两条路径内部部分的成本如何。

链路状态起源
    仅对区域内路径有效，该字段指示直接引用目的地的LSA（路由器LSA或网络LSA）。例如，如果目的地是中转网络，则此字段为中转网络的网络LSA；如果目的地是虚拟网络，则为连接路由器的路由器LSA。在最短路径树计算过程中（参见第16.1节）会发现该LSA。可能有多个LSA引用同一目的地，但通过打破平局的方案，总会将选择缩减为单一的LSA。链路状态起源字段并不被OSPF协议使用，但在OSPF的多播路由扩展（MOSPF）中的路由表计算中会用到。

当存在多个路径具有相同的路径类型和成本（在其他地方称为“等价成本”路径）时，它们会存储在单一的路由表项中。每个“等价成本”路径通过以下字段区分：

下一跳
    转发流量到目的地时使用的出口路由器接口。在广播、点对多点和非广播多点接入（NBMA）网络中，下一跳还包括通向目的地路径中下一台路由器（如果有的话）的IP地址。

广告路由器
仅对区域间路径和自治系统外部路径有效。该字段指示广告该汇总链路状态广告（LSA）或自治系统外部链路状态广告（AS-external-LSA）的路由器的路由器ID。

Moy                         标准轨迹                   [第110页]

RFC 2328                     OSPF版本2                   1998年4月

11.1. 路由表查找

当接收到一个IP数据包时，OSPF路由器会找到与该数据包目标地址最匹配的路由表项。然后，该路由表项提供用于转发该数据包的出接口和下一跳路由器。本文描述了查找最佳匹配路由表项的过程。

在开始查找之前，应在路由表中插入“丢弃”路由表项，覆盖路由器所有活动区域地址范围（见第3.5节）。(如果一个区域范围包含一个或多个可通过区域内路径到达的网络，则该区域范围被视为“活动”的。)“丢弃”路由表项的目标地址是由其关联的活动区域地址范围描述的地址集合，每个“丢弃”路由表项的路径类型都设置为“区域间”。

可能有多个路由表项与目标地址匹配。在这种情况下，“最佳匹配”是提供最具体（最长）匹配的路由表项。换句话说，就是选择范围最窄的IP地址段的条目。例如，地址/掩码对（128.185.1.0，0xffffff00）的条目比（128.185.0.0，0xffff0000）的条目更具体。默认路由是最不具体的匹配，因为它匹配所有目的地。（注意，对于任何单一的路由表项，可能存在多条路径。在这些情况下，第16.1节、第16.2节和第16.4节中的计算总是会得出具有最优先路径类型的路径，如第11节所述。）

如果没有匹配的路由表项，或者最佳匹配的路由表项是上述“丢弃”路由表项之一，则认为该数据包的IP目标地址不可达。此时，数据包不应被转发，而应被丢弃，并向数据包源返回一个ICMP目的地不可达消息。

11.2. 无区域的示例路由表

考虑图2所示的自治系统（AS）。尚未配置任何OSPF区域。每个路由表项显示一个度量值。

关于出接口。路由器RT6的路由表的计算过程如第2.2节所述。最终的路由表显示在表12中。目的地类型用简写表示：网络为“N”，路由器为“R”。

在本例中，没有出现多个等成本的最短路径的情况。此外，由于没有区域，因此也不存在区域间路径。

路由器RT5和RT7是自治系统（AS）边界路由器。已计算出指向RT5和RT7的区域内路径。这允许计算到由RT5和RT7广告的目的地的外部路径（即网络N12、N13、N14和N15）。假设RT5和RT7发出的所有AS外部链路状态广告（LSA）都在宣传类型1的外部度量值。这导致为目的地N12至N15计算出类型1的外部路径。

11.3  带有区域的示例路由表

考虑前面的例子，这次将其划分为多个OSPF区域。图6展示了一个OSPF区域配置。本文将描述RT4在此区域配置中的路由表。RT4连接到区域1和骨干区域。这使得RT4将整个AS视为图7和图8所示的两个图的拼接。最终的路由表显示在表13中。

同样，RT5和RT7是AS边界路由器。RT3、RT4、RT7、RT10和RT11是区域边界路由器。注意，区域边界路由器RT3有两个路由条目，因为它与RT4共有两个区域（区域1和骨干区域）。

已计算到所有区域边界路由器的骨干路径。这些路径在确定区域间路径时会被使用。请注意，所有的区域间路径都与骨干区域相关联；当计算路由的路由器本身也是区域边界路由器时，情况总是如此。路由信息在区域边界处被压缩。在本例中，假设已定义区域3，使得网络N9-N11和到H1的主机路径都在该区域内。

类型   目的地   区域   路径  类型    成本   下一跳     广告
                                                跳数   路由器
____________________________________________________________
N      N1     0      区域内    10     RT3      *
N      N2     0      区域内    10     RT3      *
N      N3     0      区域内    7      RT3      *
N      N4     0      区域内    8      RT3      *
N      Ib     0      区域内    7      *        *
N      Ia     0      区域内    12     RT10     *
N      N6     0      区域内    8      RT10     *
N      N7     0      区域内    12     RT10     *
N      N8     0      区域内    10     RT10     *
N      N9     0      区域内    11     RT10     *
N      N10    0      区域内    13     RT10     *
N      N11    0      区域内    14     RT10     *
N      H1     0      区域内    21     RT10     *
R      RT5    0      区域内    6      RT5      *
R      RT7    0      区域内    8      RT10     *
____________________________________________________________
N      N12    *      类型1扩展   10     RT10     RT7
N      N13    *      类型1扩展   14     RT5      RT5
N      N14    *      类型1扩展   14     RT5      RT5
N      N15    *      类型1扩展   17     RT10     RT7


表12：路由器RT6的路由表
（未配置区域）

当广告到骨干网时（由路由器RT11），所有这些都被合并为一条路由。请注意，这条路由的成本是其各个组成部分成本的最大值。

在RT10和RT11之间配置了一个虚拟链路。如果没有这个配置的虚拟链路，RT11将无法向骨干网广告网络N9-N11和主机H1的路由，也不会在RT4的路由表中为这些网络添加条目。

在此示例中，网络N12有两条等成本路径。然而，它们都使用相同的下一跳（路由器RT5）。

如果在RT4和RT3之间再配置一条虚拟链路，RT4的路由表将得到改善（即，某些路径会变得更短）。这条新虚拟链路将与表13中第一个关于区域边界路由器RT3的条目相关联（通过区域1的区域内路径）。这将使虚拟链路的成本为1。由添加这条虚拟链路引起的路由表条目的变化如下：

以下是英文内容的中文翻译：

```

   类型   目的地        区域   路径  类型    成本   下一跳      广告
                                                  跳数(s)   路由器
   __________________________________________________________________
   N      N1          1      区域内    4      RT1       *
   N      N2          1      区域内    4      RT2       *
   N      N3          1      区域内    1      *         *
   N      N4          1      区域内    3      RT3       *
   R      RT3         1      区域内    1      *         *
   __________________________________________________________________
   N      Ib          0      区域内    22     RT5       *
   N      Ia          0      区域内    27     RT5       *
   R      RT3         0      区域内    21     RT5       *
   R      RT5         0      区域内    8      *         *
   R      RT7         0      区域内    14     RT5       *
   R      RT10        0      区域内    22     RT5       *
   R      RT11        0      区域内    25     RT5       *
   __________________________________________________________________
   N      N6          0      跨区域    15     RT5       RT7
   N      N7          0      跨区域    19     RT5       RT7
   N      N8          0      跨区域    18     RT5       RT7
   N      N9-N11,H1   0      跨区域    36     RT5       RT11
   __________________________________________________________________
   N      N12         *      类型1扩展   16     RT5       RT5,RT7
   N      N13         *      类型1扩展   16     RT5       RT5
   N      N14         *      类型1扩展   16     RT5       RT5
   N      N15         *      类型1扩展   23     RT5       RT7


                  表13：在存在区域的情况下，路由器RT4的路由表。

Moy                         标准追踪                   [第114页]

RFC 2328                     OSPF版本2                   1998年4月

        在表14中。



12.  链路状态广告（LSAs）

    自治系统中的每个路由器都会产生一个或多个链路状态广告（LSAs）。本备忘录定义了五种不同类型的LSAs，它们在第4.3节中描述。LSA的集合形成链路状态数据库。每种不同类型的LSA具有不同的功能。路由器LSA和网络LSA描述了区域内路由器和网络的互联方式。摘要LSA提供了一种压缩区域内路由信息的方法。自治系统外部LSA则提供了一种透明地在整个自治系统中广告外部路由信息的方式。

    每个LSA都以一个标准的20字节头部开始。以下将讨论此LSA头部。
```

以下是英文内容的中文翻译：

```
    类型   目的地        区域   路径  类型   成本   下一跳     广告路由器
                                                  跳数   路由器
    ________________________________________________________________
    N      Ib          0      区域内   16     RT3      *
    N      Ia          0      区域内   21     RT3      *
    R      RT3         0      区域内   1      *        *
    R      RT10        0      区域内   16     RT3      *
    R      RT11        0      区域内   19     RT3      *
    ________________________________________________________________
    N      N9-N11,H1   0      区域间   30     RT3      RT11


                  表14：由额外虚拟链路引起的变化





Moy                         标准轨迹                   [第115页]


RFC 2328                     OSPF 版本2                   1998年4月


    12.1.  LSA头部

        LSA头部包含LS类型、链路状态ID和广告路由器字段。这三个字段的组合唯一标识一个LSA。

        在自治系统中可能存在多个LSA实例，同时存在。必须确定哪个实例是最新的。这个判断通过检查LS序列号、LS校验和和LS年龄字段来完成。这些字段也包含在20字节的LSA头部中。

        多种OSPF数据包类型会列出LSA。当实例不重要时，LSA通过其LS类型、链路状态ID和广告路由器（参见链路状态请求包）来引用。否则，还必须参考LS序列号、LS年龄和LS校验和字段。

        下面将详细说明LSA头部所包含字段。

        12.1.1.  LS年龄

            该字段表示LSA的年龄（以秒为单位）。应作为无符号16位整数处理。当LSA被创建时，年龄设置为0。在每次洪泛过程中，每经过一跳，年龄应增加InfTransDelay。LSA在每个路由器的数据库中也会随时间变老。

            LSA的年龄绝不会超过MaxAge。年龄为MaxAge的LSA不会被用在路由表计算中。当LSA的年龄首次达到MaxAge时，会重新洪泛。年龄为MaxAge的LSA最终会从数据库中清除，以确保数据库同步。关于LSA老化的更多信息，请参阅第14节。

            当路由器收到两个具有相同LS序列号和LS校验和的LSA实例时，会检查LS年龄字段。如果某个实例的年龄为MaxAge，则
```

RFC 2328                     OSPF 版本2                   1998年4月

总是被接受为最新的；这允许旧的LSA（链路状态广告）能够迅速从路由域中清除。否则，如果两个LSA的年龄差超过MaxAgeDiff，则年龄较小的LSA会被视为最新的。[12] 详细信息请参见第13.1节。

12.1.2. 选项（Options）

LSA头中的Options字段指示与该LSA相关联的可选功能。OSPF的可选功能在第4.5节中描述。该规范定义了一个可选功能，由Options字段中的E位表示。Options字段中未识别的位应设置为零。

E位代表OSPF的外部路由能力（ExternalRoutingCapability）。该位应在所有与骨干区域相关的LSA中设置，以及在所有非Stub区域相关的LSA中设置（参见第3.6节）。它还应在所有AS外部LSA中设置。在所有与Stub区域相关的路由器LSA、网络LSA和汇总LSA中应重置该位。对于所有LSA，E位的设置仅用于信息传递；它不影响路由表的计算。

12.1.3. 链路状态类型（LS type）

LS类型字段决定了LSA的格式和功能。不同类型的LSA具有不同的名称（例如，路由器LSA或网络LSA）。本备忘录定义的所有LSA类型，除了AS外部LSA（LS类型=5），都只在单一区域内泛洪。AS外部LSA则在整个自治系统内泛洪，但不包括Stub区域（参见第3.6节）。每种不同的LSA类型在下表15中简要描述。

12.1.4. 链路状态ID（Link State ID）

该字段标识由LSA描述的路由域的某一部分。根据LSA的LS类型，链路状态ID的取值如下表所示。

LS 类型  LSA 描述
_______________________________________________
1         这些是路由器LSA。
          它们描述了路由器接口的收集状态。更多信息请参见第12.4.1节。
_______________________________________________
2         这些是网络LSA。
          它们描述了连接到网络的路由器集合。更多信息请参见第12.4.2节。
_______________________________________________
3或4     这些是汇总LSA。
          它们描述区域间路由，并实现区域边界的路由信息汇总。由区域边界路由器生成，类型3汇总LSA描述到网络的路由，而类型4汇总LSA描述到自治系统边界路由器的路由。
_______________________________________________
5         这些是自治系统外部LSA。
          由自治系统边界路由器生成，描述通往自治系统外部目的地的路由。自治系统的默认路由也可以通过外部LSA进行描述。

表15：OSPF链路状态广告（LSA）。

实际上，对于类型3汇总LSA（LS类型=3）和类型5外部LSA（LS类型=5），链路状态ID可能是

LS类型  链路状态ID
_______________________________________________
1         生成该LSA的路由器ID。
2         网络的指定路由器的IP接口地址。
3         目标网络的IP地址。
4         描述的自治系统边界路由器的路由器ID。
5         目标网络的IP地址。

表16：LSA的链路状态ID。

此外，还可以设置目标网络的一个或多个“主机”位。例如，当为网络10.0.0.0（掩码为255.0.0.0）发起一个AS-外部LSA时，链路状态ID可以设置为10.0.0.0到10.255.255.255范围内的任何值（但应尽可能使用10.0.0.0）。允许设置某些主机位的自由度，使得路由器可以为具有相同地址但不同掩码的两个网络发起不同的LSA。详细信息请参见附录E。

当LSA描述一个网络（LS类型为2、3或5）时，可以通过用LSA正文中的网络/子网掩码对链路状态ID进行掩码操作，轻松得出该网络的IP地址。当LSA描述一个路由器（LS类型为1或4）时，链路状态ID始终是被描述路由器的OSPF路由器ID。

当一个AS-外部LSA（LS类型为5）描述默认路由时，其链路状态ID设置为DefaultDestination（0.0.0.0）。

12.1.5. 广告路由器

该字段指定LSA的发起者的OSPF路由器ID。对于路由器LSA，该字段与链路状态ID字段相同。网络LSA由网络的指定路由器发起。汇总LSA由区域边界路由器发起。AS-外部LSA由AS边界路由器发起。

12.1.6. LS序列号

序列号字段是一个有符号的32位整数，用于检测旧的和重复的LSA。序列号的空间是线性有序的。比较两个序列号时，较大的序列号（作为有符号32位整数比较）表示该LSA更新更为新近。为了更精确地描述序列号空间，下文中的N指的是常数2^31。

序列号 -N（0x80000000）是保留的（未使用）。这意味着 -N + 1（0x80000001）是最小的（也是最旧的）序列号；这个序列号被称为常数 InitialSequenceNumber。路由器在首次生成任何LSA（链路状态广告）时会使用 InitialSequenceNumber。之后，每当路由器生成一个新的LSA实例时，LSA的序列号就会递增。当尝试将序列号递增到超过最大值N - 1（0x7fffffff，也称为 MaxSequenceNumber）时，必须先将当前的LSA实例从路由域中清除。这可以通过提前老化该LSA（参见第14.1节）并重新泛洪来实现。一旦所有邻居确认了这次泛洪，就可以用序列号为InitialSequenceNumber的新实例来生成。

当在泛洪过程中意外收到更新的、更近期的LSA实例时，路由器可能被迫提升其某个LSA的序列号。这种情况应当很少发生。这可能表明，存在一个由路由器在上次重启/重新加载之前生成的过期LSA，仍然在自治系统中存在。有关更多信息，请参见第13.4节。

---

Moy  规范追踪  [第120页]

RFC 2328  OSPF第2版  1998年4月

12.1.7.  LS校验和

该字段是LSA全部内容（不包括LS年龄字段）的校验和。之所以排除LS年龄字段，是为了在不更新校验和的情况下增加LSA的年龄。所用的校验和与ISO无连接数据报所用的相同，通常称为Fletcher校验和。它在[Ref6]的附录B中有详细描述。LSA头部还包含LSA的长度（以字节为单位）；减去LS年龄字段（两个字节）的大小，即为需要进行校验的数据量。

校验和用于检测LSA的数据是否被破坏。这种破坏可能在LSA被泛洪时发生，也可能在LSA存放在路由器内存中时发生。LSA的校验和字段不能为零；出现零值应视为校验和失败。换句话说，计算校验和不是可选的。

LSA（链路状态广告）校验和在以下两种情况下会被验证：a）当它在链路状态更新包中被接收时；b）在链路状态数据库老化的过程中。检测到校验和失败会导致在每种情况下采取不同的措施。有关详细信息，请参见第13和第14节。

每当LS序列号字段显示两个LSA实例相同时，会检查LS校验和字段。如果两者不同，则具有较大LS校验和的实例被视为最新的[13]。有关更多细节，请参见第13.1节。

12.2 链路状态数据库

每个路由器为其所属的每个区域都拥有一个独立的链路状态数据库。属于同一区域的所有路由器都拥有相同的区域链路状态数据库。

每个区域的数据库始终单独处理。每个区域的最短路径计算也是单独进行的（参见第16节）。区域链路状态数据库的组成部分仅在整个区域内进行泛洪。最后，当建立邻接关系（属于区域A）时，只有区域A的数据库在两个路由器之间进行同步。

区域数据库由路由器LSA、网络LSA和摘要LSA（都列在区域数据结构中）组成。此外，外部路由（AS外部LSA）也包含在所有非存根区域的数据库中（参见第3.6节）。

OSPF的实现必须能够访问区域数据库的各个部分。此查找功能基于LSA的LS类型、链路状态ID和广告路由器[14]。数据库中每个LSA只有一个实例（最新的）。数据库查找功能在LSA泛洪过程（第13节）和路由表计算（第16节）期间被调用。此外，路由器还可以通过此查找功能确定自己是否曾经发起过某个特定的LSA，以及该LSA的LS序列号是多少。

当路由器的数据库中添加LSA时，情况有两种：a）在泛洪过程中（第13节）收到该LSA；b）由路由器自身发起（第12.4节）。当LSA被删除时，也有几种情况：a）在泛洪过程中被更新的更近期实例覆盖；b）路由器自己发起了更新的自有LSA实例（第12.4节）；c）LSA过期并从路由域中清除（第14节）。每当LSA从数据库中删除时，也必须将其从所有邻居的链路状态重传列表中移除（参见第10节）。

12.3. TOS的表示

为了与之前版本的OSPF规范（[Ref9]）保持向后兼容，TOS相关信息可以包含在路由器LSA、汇总LSA和AS外部LSA中。OSPF中LSA中TOS的编码方式在表17中规定。该表将OSPF的编码与IP数据包头中的TOS字段（定义在[Ref12]）对应起来。OSPF的编码以十进制整数表示，而IP数据包头的TOS字段则用[Ref12]中使用的二进制TOS值表示。

| OSPF编码 | RFC 1349 TOS值             |
| -------- | -------------------------- |
| 0        | 0000 正常服务             |
| 2        | 0001 最小化金钱成本       |
| 4        | 0010 最大化可靠性         |
| 6        | 0011                        |
| 8        | 0100 最大化吞吐量         |
| 10       | 0101                        |
| 12       | 0110                        |
| 14       | 0111                        |
| 16       | 1000 最小化延迟           |
| 18       | 1001                        |
| 20       | 1010                        |
| 22       | 1011                        |
| 24       | 1100                        |
| 26       | 1101                        |
| 28       | 1110                        |
| 30       | 1111                        |

表17：在OSPF中表示TOS。

12.4. LSAs的发起

在任何给定的OSPF区域内，路由器会发起多个LSAs。每个路由器都会发起一个路由器LSA。如果该路由器还是该区域网络的指定路由器（Designated Router），它还会为这些网络发起网络LSA。

区域边界路由器为每个已知的区域间目的地生成一条汇总LSA。自治系统（AS）边界路由器为每个已知的AS外部目的地生成一条AS外部LSA。目的地会逐一进行广告，以便单个路由的变化可以被泛洪，而无需重新泛洪整个路由集合。在泛洪过程中，许多LSA可以被单个链路状态更新包携带。

以图6中的RT4路由器为例。它是一个区域边界路由器，连接到区域1和骨干网。RT4在骨干网中生成了5个不同的LSA（一个路由器LSA，以及针对网络N1-N4的每个汇总LSA）。RT4还在区域1中生成了8个不同的LSA（一个路由器LSA和七个汇总LSA，如图7所示）。如果RT4被选为网络N3的指定路由器（Designated Router），它还会为N3在区域1中生成一条网络LSA。

在同一图中，RT5将生成3个不同的AS外部LSA（每个对应网络N12-N14）。这些LSA将在整个AS中进行泛洪，前提是没有区域被配置为存根区（stub area）。然而，如果区域3被配置为存根区，则网络N12-N14的AS外部LSA不会被泛洪到区域3（见第3.6节）。相反，RT11会生成一条默认的汇总LSA，并在区域3中进行泛洪（见第12.4.3节）。这指示区域3的所有内部路由器将其AS外部流量发送到RT11。

每当生成一个新的LSA实例时，其LS序列号会递增，LS年龄被设置为0，LS校验和会被计算，然后LSA会被加入链路状态数据库，并通过适当的接口进行泛洪。关于LSA在链路状态数据库中的安装，详见第13.2节；关于新生成LSA的泛洪，详见第13.3节。

引发新LSA实例的十个事件包括：

(1) 当路由器自发的链路状态广告（LSA）的LS年龄字段达到LSRefreshTime值时，即会生成一个新的LSA实例，尽管除了LSA头部之外，LSA的内容保持不变。这确保了所有LSA的周期性生成。这种对LSA的周期性更新增强了链路状态算法的鲁棒性。仅描述不可达目的地的LSA不应被刷新，而应从路由域中清除（详见第14.1节）。

当LSA所描述的内容发生变化时，会生成一个新的LSA实例。然而，在最小LS间隔（MinLSInterval）时间内，不得生成两个相同的LSA实例。这可能意味着下一次实例的生成需要延迟最多到MinLSInterval。以下事件可能导致LSA内容发生变化，只有在新LSA的内容不同的情况下，才应触发新的生成：

(2) 接口状态发生变化（详见第9.1节），这可能意味着需要生成新的路由器LSA。

(3) 连接网络的指定路由器发生变化。应生成新的网络LSA。此外，如果路由器本身成为了指定路由器，则应生成新的网络LSA。如果路由器不再是指定路由器，则应将其为该网络生成的任何网络LSA从路由域中清除（详见第14.1节）。

(4) 相邻路由器状态变为或从FULL状态变化。这可能意味着需要生成新的路由器LSA。此外，如果该路由器本身是连接网络的指定路由器，则应生成新的网络LSA。

以下四个事件仅涉及区域边界路由器：

(5) 区域内路由表中添加、删除或修改了某条路由。这可能导致在每个连接的区域（可能包括骨干区域）中生成该路由的摘要LSA的新实例。

(6) 区域间路由表中添加、删除或修改了某条路由。这可能导致在每个连接的区域中生成该路由的摘要LSA的新实例（但绝不在骨干区域中）。

（7）当路由器新加入某个区域时，必须为该路由器的路由表中所有相关的区域内路由和区域间路由，在新加入的区域内生成摘要链路状态广告（summary-LSA）。有关详细信息，请参见第12.4.3节。

（8）当路由器配置的虚拟链路的状态发生变化时，可能需要在虚拟链路的中转区域（请参见第12.4.1节中关于路由器-LSA的V位的讨论）中生成新的路由器-LSA，以及在骨干区域中生成新的路由器-LSA。

最后两个事件仅涉及自治系统（AS）边界路由器（以及曾经是AS边界路由器的情况）：

（9）通过与外部路由协议（如BGP）直接交互获得的外部路由发生变化时，AS边界路由器将生成一个新的AS外部链路状态广告（AS-external-LSA）。

（10）当某个路由器不再是AS边界路由器，可能是在重启之后。在这种情况下，该路由器应清除之前生成的所有AS外部LSA。这些LSA可以通过第14.1节中规定的提前老化程序进行清除。

每种类型的LSA的构造方法将在下文详细说明。一般而言，这些章节描述了LSA正文（即20字节LSA头部之后部分）的内容。关于LSA头部的构建信息，请参见第12.1节。

12.4.1. 路由器-LSA

每个路由器为其所属的每个区域生成一个路由器-LSA。此类LSA描述了该路由器与该区域内各链路的状态。该LSA会在该区域内被泛洪（Flooded），且不会在其他区域中传播。

以下是英文内容的中文翻译：

```
                  ....................................
                  . 192.1.2                   区域1 .
                  .     +                            .
                  .     |                            .
                  .     | 3+---+1                    .
                  .  N1 |--|RT1|-----+               .
                  .     |  +---+      \              .
                  .     |              \  _______N3  .
                  .     +               \/       \   .  1+---+
                  .                     * 192.1.1 *------|RT4|
                  .     +               /\_______/   .   +---+
                  .     |              /     |       .
                  .     | 3+---+1     /      |       .
                  .  N2 |--|RT2|-----+      1|       .
                  .     |  +---+           +---+8    .         6+---+
                  .     |                  |RT3|----------------|RT6|
                  .     +                  +---+     .          +---+
                  . 192.1.3                  |2      .   18.10.0.6|7
                  .                          |       .            |
                  .                   +------------+ .
                  .                     192.1.4 (N4) .
                  ....................................

                    图15：显示IP地址的区域1

            路由器LSA的格式见附录A（第A.4.2节）。LSA的前20个字节由在第12.1节中讨论的通用LSA头部组成。
            路由器LSA的LS类型为1。

            路由器还通过在其路由器LSA中设置相应的位（位B和位E，分别代表区域边界路由器和AS边界路由器）来指示其是否为区域边界路由器或AS边界路由器。这使得到这些类型路由器的路径可以被保存到路由表中，以便后续处理汇总LSA和AS外部LSA。
            无论路由器是否当前连接到OSPF骨干区域，只要路由器积极连接到两个或更多区域，位B都应被设置。对于虚拟链路的端点，只有在该虚拟链路完全邻接且区域为A时，路由器才应在其路由器LSA中设置位V。设置位V使得区域A中的其他路由器能够发现该区域是否支持中转流量（参见第6节中的TransitCapability）。
```

路由器-LSA随后描述了该路由器与该区域的工作连接（即接口或链路）。每个链路根据所连接网络的类型进行分类。每个链路还会标记其链路ID。该链路ID为链路另一端的实体命名。表18总结了用于Type和Link ID字段的取值。

| 链路类型 | 描述 | 链路ID |
| -------- | ---- | ------- |
| 1        | 点对点链路 | 邻居路由器ID |
| 2        | 连接中转网络的链路 | 设计ated路由器的接口地址 |
| 3        | 连接虚拟链路的链路 | IP网络编号 |
| 4        | 虚拟链路 | 邻居路由器ID |

表18：路由器-LSA中的链路描述。

此外，每个链路还指定了链路数据字段。该字段为链路提供32位的额外信息。对于连接中转网络、编号点对点链路和虚拟链路的链路，该字段指定相关路由器接口的IP地址（这是路由表计算所必需的，详见第16.1.1节）。对于连接虚拟网络的链路，该字段指定虚拟网络的IP地址掩码。对于未编号的点对点链路，链路数据字段应设置为未编号接口的MIB-II [Ref8]中的ifIndex值。

最后，指定了使用该链路进行输出的成本。链路的输出成本是可配置的。除了连接虚拟网络的链路外，输出成本必须始终为非零值。

为了进一步描述构建链路描述列表的过程，假设一个路由器希望为区域A构建一个路由器-LSA。该路由器会检查其接口数据结构的集合。对每个接口，采取以下步骤：

- 如果所连接的网络不属于区域A，则不在LSA中添加链路，接着检查下一个接口。
- 如果接口的状态为Down，则不添加任何链路。

如果接口的状态是环回（Loopback），只要该接口不是连接到未编号点对点网络的接口，就应添加一个类型3的链路（存根网络）。此链路的ID应设置为该IP接口地址，链路数据应设置为掩码0xffffffff（表示主机路由），成本设置为0。

否则，添加到路由器LSA中的链路描述将取决于OSPF接口类型。用于点对点接口的链路描述在第12.4.1.1节中规定，虚拟链路在第12.4.1.2节中，广播和非广播多点接口在第12.4.1.3节中，点对多点接口在第12.4.1.4节中。

在考虑所有路由器接口后，通过检查属于区域A的附属主机列表，将主机链路添加到路由器LSA中。主机路由表示为类型3的链路（存根网络），其链路ID为主机的IP地址，链路数据为全1掩码（0xffffffff），成本为主机配置的成本（详见第C.7节）。

---

**12.4.1.1. 描述点对点接口**

对于点对点接口，向路由器LSA中添加一个或多个链路描述，具体如下：

- 如果邻居路由器完全邻接，应添加一个类型1的链路（点对点）。此链路的ID应设置为邻居路由器的路由器ID。对于编号的点对点网络，链路数据应指定IP接口地址；对于未编号的点对点网络，链路数据应指定接口的MIB-II [Ref8] ifIndex值。成本应设置为点对点接口的输出成本。

- 此外，只要接口状态为“点对点”（且不论邻居路由器的状态如何），还应添加一个类型3的链路（存根网络）。这种存根链路可以有两种形式：

  选项1：假设已知邻居路由器的IP地址，将类型3链路的链路ID设置为邻居的IP地址，链路数据设置为掩码0xffffffff（表示主机路由），成本设置为接口的配置输出成本。[15]

选项2
如果已为点对点链路分配了子网，则将类型3链路的链路ID设置为子网的IP地址，将链路数据设置为子网的掩码，并将成本设置为接口的配置输出成本。[16]

12.4.1.2 描述广播和NBMA接口

对于正常运行的广播和NBMA接口，向路由器LSA中添加单个链路描述，具体如下：

- 如果接口状态为等待（Waiting），则添加一个类型3链路（存根网络），链路ID设置为连接网络的IP网络号，链路数据设置为连接网络的地址掩码，成本设置为接口的配置输出成本。

- 否则，已为连接网络选举出一个指定路由器（Designated Router）。如果路由器与指定路由器完全邻接，或者如果该路由器本身是指定路由器且与至少一个其他路由器完全邻接，则添加一个类型2链路（中继网络），链路ID设置为连接网络的指定路由器的IP接口地址（可能是该路由器自己），链路数据设置为路由器自身的IP接口地址，成本为接口的配置输出成本。否则，按照接口处于等待状态（见上文）添加链路。

12.4.1.3 描述虚拟链路

对于虚拟链路，只有在虚拟邻居完全邻接时，才在路由器LSA中添加链路描述。在这种情况下，添加一个类型4链路（虚拟链路），链路ID设置为虚拟邻居的路由器ID，链路数据设置为与虚拟链路相关联的IP接口地址，成本设置为在路由表计算过程中为虚拟链路计算得出的成本（见第15节）。

12.4.1.4 描述点对多点接口

对于正常运行的点对多点接口，向路由器LSA中添加一个或多个链路描述，具体如下：

以下是英文内容的中文翻译：

```
                o   添加一个单一的类型3链路（存根网络），
                    其链路ID设置为路由器自身的IP接口地址，
                    链路数据设置为掩码0xffffffff（表示主机路由），
                    成本设置为0。

莫伊                         标准追踪                   [第131页]

RFC 2328                     OSPF版本2                   1998年4月

                o   对于与接口相关的每个完全邻接的邻居，添加一个额外的类型1链路（点对点），
                    链路ID设置为邻居路由器的路由器ID，
                    链路数据设置为IP接口地址，
                    成本等于接口配置的输出成本。

            12.4.1.5.  路由器LSA的示例

                考虑由路由器RT3生成的路由器LSA，如图6所示。
                包含RT3的区域（区域1）已在图15中重新绘制，显示实际网络地址。
                假设RT3所有接口地址的最后一个字节都是3，赋予其接口地址为192.1.1.3和192.1.4.3，
                其他路由器也采用类似的地址方案。此外，假设所有链路都正常工作，
                并且路由器ID被分配为最小的IP接口地址。

                RT3在区域1和骨干网中各生成一个路由器LSA。
                假设已选择RT4作为网络192.1.1.0的指定路由器。
                RT3在区域1的路由器LSA如下所示。它表明RT3与区域1有两个连接，
                第一个是到中转网络192.1.1.0的链路，第二个是到存根网络192.1.4.0的链路。
                注意，中转网络由其指定路由器的IP接口标识（即链路ID=192.1.1.4，
                这是RT4作为指定路由器在192.1.1.0上的IP接口）。还要注意，RT3已表明
                它是一个区域边界路由器。

        ; RT3的区域1路由器LSA

        LS age = 0                     ;在生成时总是为真
        选项 = (E位)                  ;
        LS类型 = 1                    ;表示路由器LSA
        链路状态ID = 192.1.1.3      ;RT3的路由器ID
        广告路由器 = 192.1.1.3        ;RT3的路由器ID
        E位 = 0                      ;不是AS边界路由器
```

以下是英文内容的中文翻译：

```

        位 B = 1                      ; 区域边界路由器
        #链路数 = 2
               链路ID = 192.1.1.4     ;设计路由器的IP地址
               链路数据 = 192.1.1.3   ;RT3到网络的IP接口
               类型 = 2                ;连接到中转网络
               # TOS指标 = 0
               指标 = 1

               链路ID = 192.1.4.0     ;网络编号
               链路数据 = 0xffffff00  ;网络掩码
               类型 = 3                ;连接到支路网络
               # TOS指标 = 0
               指标 = 2

                    接下来显示的是RT3的骨干网路由LSA。它
                    表明RT3只有一个连接到骨干网的连接。
                    这个连接是通过一个未编号的点对点链路连接到路由器RT6。RT3再次
                    表明它是一个区域边界路由器。

        ; RT3的骨干网路由LSA

        LS年龄 = 0                     ;在生成时总是为真
        选项 = (E位)                  ;
        LS类型 = 1                     ;表示路由器LSA
        链路状态ID = 192.1.1.3       ;RT3的路由器ID
        广告路由器 = 192.1.1.3        ;RT3的路由器ID
        位 E = 0                      ;不是AS边界路由器
        位 B = 1                      ;区域边界路由器
        #链路 = 1
               链路ID = 18.10.0.6     ;邻居的路由器ID
               链路数据 = 0.0.0.3     ;MIB-II的接口索引（ifIndex）
               类型 = 1                ;连接到路由器
               # TOS指标 = 0
               指标 = 8

        12.4.2.  网络-LSA

            每个中转广播或NBMA网络都会生成一个网络LSA。（中转网络是指连接两个或更多路由器的网络）。网络LSA描述所有连接到该网络的路由器。

            该网络的指定路由器（Designated Router）生成LSA。
            只有当该指定路由器与网络上的至少一个其他路由器完全邻接时，它才会生成LSA。网络LSA会在包含该中转网络的区域内泛洪，且不会超出该区域。网络LSA列出所有与指定路由器完全邻接的路由器；每个完全邻接的路由器由其OSPF路由器ID标识。指定路由器会将自己包含在此列表中。

            网络LSA的链路状态ID是指定路由器的IP接口地址。这个值与网络的地址掩码（也包含在网络LSA中）相结合，得出网络的IP地址。
```

曾经担任某个网络的指定路由器（Designated Router），但现已不再担任的路由器，应当清除其之前发出的网络链路状态广告（network-LSA）。该LSA不再用于路由表的计算。清除方法是提前将该LSA的年龄（age）设置为最大值（MaxAge）并重新泛洪（reflood）（详见第14.1节）。此外，在极少数情况下，如果路由器的路由ID发生了变化，所有由该路由器之前的路由ID发出的网络LSA也必须被清除。由于路由器可能不知道其之前的路由ID是什么，这些网络LSA可以通过其链路状态ID（Link State ID）等于路由器某个IP接口地址，以及其广告路由器（Advertising Router）字段的值不同于当前路由ID来识别（详见第13.4节）。

12.4.2.1 网络LSA的示例

再次考虑图6中的区域配置。在区域1中为网络N3发出网络LSA，区域2中的网络N6和N8，以及区域3中的网络N9也会发出网络LSA。假设RT4已被选为网络N3的指定路由器（Designated Router），RT4代表网络N3生成的网络LSA如下（地址分配见图15）：

；网络N3的网络LSA

LS年龄 = 0                     ;在发出时总是为0
选项 = (E位)                  ;
LS类型 = 2                    ;表示网络LSA
链路状态ID = 192.1.1.4        ;指定路由器的IP地址
广告路由器 = 192.1.1.4          ;RT4的路由ID
网络掩码 = 0xffffff00
    附加路由器 = 192.1.1.4     ;路由器ID
    附加路由器 = 192.1.1.1     ;路由器ID
    附加路由器 = 192.1.1.2     ;路由器ID
    附加路由器 = 192.1.1.3     ;路由器ID

12.4.3 综述-LSAs

由综述-LSA描述的目的地可以是一个IP网络、一个自治系统（AS）边界路由器，或一段IP地址范围。综述-LSAs仅在单一区域内泛洪。所描述的目的地是区域外的，但仍属于同一自治系统的内容。

总结——LSA由区域边界路由器生成。用于在某个区域中广告的精确汇总路由是通过检查路由表结构（参见第11节）并按照下面描述的算法确定的。注意，只有区域内的路由会被广告到骨干区域，而区域内和区域间的路由都会被广告到其他区域。

为了确定哪些路由应被广告到附属区域A中，逐个处理每个路由表条目。请记住，每个路由表条目描述了一组到特定目的地的等成本最佳路径：

- 仅在汇总LSA中广告目的地类型为网络和AS边界路由器的路由。如果路由表条目的目的地类型是区域边界路由器，则检查下一个路由表条目。

- 不会在汇总LSA中广告AS外部路由。如果路由表条目的路径类型为类型1外部或类型2外部，则检查下一个路由表条目。

- 否则，如果与这组路径相关联的区域是区域A本身，则不为该路由生成汇总LSA。

- 否则，如果与这组路径相关联的下一跳属于区域A本身，则不为该路由生成汇总LSA。这在逻辑上等同于距离矢量协议中的分割视界（split horizon）逻辑。

- 否则，如果路由表中的代价等于或超过LSInfinity值，则无法为该路由生成汇总LSA。

- 否则，如果该路由的目的地是一个AS边界路由器，只有在路由表条目描述到该AS边界路由器的首选路径时，才应生成汇总LSA（参见第16.4节第3步）。如果符合条件，则为该目的地生成类型4的汇总LSA，其链路状态ID等于AS边界路由器的路由器ID，度量值等于路由表条目的代价。注意：如果区域A被配置为存根区域，则不应生成这些LSA。

否则，目标类型为网络。如果这是一个区域间路由，则为该目标生成一个类型3的汇总LSA，其链路状态ID等于该网络的地址（如有必要，链路状态ID也可以设置为网络的一个或多个主机位；详细信息请参见附录E），度量值等于路由表中的成本。

剩下的唯一情况是指向某个网络的区域内路由。这意味着该网络包含在路由器直接连接的某个区域内。通常，在出现在汇总LSA中之前，必须对这些信息进行压缩。请记住，一个区域有一份配置的地址范围列表，每个范围由一个[地址，掩码]对和一个状态指示（“广告”或“不广告”）组成。每个范围最多只会生成一个类型3的汇总LSA。当范围的状态为“广告”时，会生成一个类型3的汇总LSA，其链路状态ID等于该范围的地址（如有必要，链路状态ID也可以设置为范围的“主机”位；详细信息请参见附录E）以及等于该范围内所有网络中最大成本的度量值。当范围的状态为“不广告”时，类型3的汇总LSA会被抑制，组成该范围的网络将对其他区域保持隐藏。

默认情况下，如果某个网络不包含在任何明确配置的地址范围内，则会生成一个类型3的汇总LSA，其链路状态ID等于该网络的地址（如有必要，链路状态ID也可以设置为网络的一个或多个主机位；详细信息请参见附录E），度量值等于该网络的路由表成本。

如果某个区域能够承载中转流量（即其TransitCapability设置为TRUE），则关于骨干网络的路由信息不应在汇总到该区域之前进行压缩，也不应抑制骨干网络在中转区域中的广告。换句话说，在向中转区域发出汇总LSA时，应忽略骨干网络的配置范围。

如果一个路由器为某个目的地广告了一个汇总LSA，而该目的地随后变得无法到达，那么该路由器必须通过将其年龄设置为MaxAge并重新泛洪（参见第14.1节）来从路由域中清除该LSA。此外，如果该目的地仍然可达，但根据上述程序已不再能进行广告（例如，它现在是一个区域间路由，而之前是与某个非骨干区域相关联的区域内路由；因此，不能再向骨干区域广告），也应将该LSA从路由域中清除。

12.4.3.1. 在存根区域中生成汇总LSA

当区域A是OSPF存根区域时，第12.4.3节中的算法是可选的。连接到存根区域的区域边界路由器可以根据第12.4.3节的算法在该区域中生成汇总LSA，或者也可以选择只生成部分汇总LSA，可能由配置控制。生成的LSA越少，存根区域的链路状态数据库越小，从而进一步减轻其路由器的资源负担。然而，省略某些LSA也可能导致次优的区域间路由，尽管路由仍能正常工作。

根据第12.4.3节的规定，类型4汇总LSA（ASBR汇总LSA）绝不会在存根区域中生成。

在存根区域中，区域边界路由器不导入外部路由，而是为该区域生成一个“默认汇总LSA”。该默认汇总LSA的链路状态ID设置为DefaultDestination，度量值设置为（每个区域可配置的参数）StubDefaultCost。注意，StubDefaultCost在所有存根区域的区域边界路由器中不必配置成相同的值。

12.4.3.2. 汇总LSA的示例

请再次考虑图6中的区域配置。路由器RT3、RT4、RT7、RT10和RT11都是区域边界路由器，因此它们会生成汇总链路状态广告（summary-LSA）。特别是考虑路由器RT4。其路由表的计算方式如第11.3节的示例所示。RT4在骨干区域和区域1中都生成了汇总LSA。

在骨干区域，RT4为每个网络N1至N4生成了单独的LSA。在区域1中，RT4为网络N6至N8以及自治系统边界路由器RT5和RT7生成了单独的LSA。它还将主机路由Ia和Ib合并成一个汇总LSA。最后，指向网络N9、N10、N11和主机H1的路由由一个汇总LSA进行广告。这种合并最初由路由器RT11完成。

这些LSA在图7和图8中以图形方式展示。以下是由RT4生成的两个汇总LSA的示例。相关网络和路由器的实际IP地址已在图15中标注。

- 针对网络N1的汇总LSA，由RT4在骨干区域中生成：
  
  ```
  LS age = 0                  ; 在生成时总是为0
  Options = (E-bit)           ;
  LS type = 3                 ; 类型3，汇总链路状态广告
  Link State ID = 192.1.2.0   ; N1网络的IP地址
  Advertising Router = 192.1.1.4       ; RT4的ID
  metric = 4
  ```

- 针对自治系统边界路由器RT7的汇总LSA，由RT4在区域1中生成：
  
  ```
  LS age = 0                  ; 在生成时总是为0
  Options = (E-bit)           ;
  LS type = 4                 ; 类型4，自治系统边界路由器的汇总LSA
  Link State ID = RT7的ID
  Advertising Router = 192.1.1.4       ; RT4的ID
  metric = 14
  ```

第12.4.4节介绍了自治系统外部链路状态广告（AS-external-LSAs）。

AS-external-LSA 描述通往自治系统外部目的地的路由。大多数 AS-external-LSA 描述指向特定外部目的地的路由；在这些情况下，LSA 的链路状态ID被设置为目标网络的IP地址（如有必要，链路状态ID还可以设置为该网络的一个或多个“主机”位，详见附录E）。然而，自治系统的默认路由可以通过在AS-external-LSA中将LSA的链路状态ID设置为DefaultDestination（0.0.0.0）来描述。AS-external-LSA由AS边界路由器发起。每个边界路由器为其学到的每个外部路由（无论是通过其他路由协议如BGP，还是通过配置）发起一个单独的AS-external-LSA。

Moy  规范追踪  [第139页]

RFC 2328  OSPF第2版  1998年4月

AS-external-LSA是唯一在整个自治系统内泛洪的LSA类型；所有其他类型的LSA仅在单一区域内有效。然而，AS-external-LSA不会被泛洪到/穿过存根区域（详见第3.6节）。这有助于减少存根区域内部路由器的链路状态数据库的大小。

外部路由所广告的度量值可以是两种类型之一。类型1的度量值类似于链路状态度量。类型2的度量值被假定为大于任何自治系统内路径的成本。

如果某个路由器为一个变得不可达的目的地广告了AS-external-LSA，则该路由器必须通过将其年龄设置为MaxAge并重新泛洪（详见第14.1节）来从路由域中清除该LSA。

12.4.4.1. AS-external-LSA的示例

再次考虑图6所示的AS。该AS有两个边界路由器：RT5和RT7。RT5为网络N12-N14发起了三个AS-external-LSA。RT7为网络N12和N15发起了两个AS-external-LSA。假设RT7通过BGP学到了到N12的路由，并希望向AS广告一个类型2的度量值。RT7将为N12发起以下LSA：

；网络N12的AS-external-LSA，由路由器RT7发起

以下是英文内容的中文翻译：

```
        LS age = 0                  ;在原始生成时总是为0
        选项 = (E位)               ;
        LS类型 = 5                 ;自治系统外部链路状态广告（AS-external-LSA）
        链路状态ID = N12的IP网络编号
        广告路由器 = RT7路由器的ID
        E位 = 1                   ;类型2度量
        度量 = 2
        转发地址 = 0.0.0.0





Moy                         标准轨迹                   [第140页]


RFC 2328                     OSPF版本2                   1998年4月


                    在上述示例中，转发地址字段被设置为0.0.0.0，表示针对外部目的地的包应转发到广告该OSPF路由器（RT7）。这并不总是理想的。考虑图16中的示例。有三台OSPF路由器（RTA、RTB和RTC）连接到一个公共网络。只有其中一台路由器RTA与非OSPF路由器RTX交换BGP信息。RTA必须为从RTX学到的那些目的地生成AS外部链路状态广告（LSA）。通过使用AS外部LSA的转发地址字段，RTA可以指定将这些目的地的包直接转发到RTX。如果没有这个功能，RTB和RTC路由器在到达这些目的地时会多跳一次。

                    注意，当转发地址字段非零时，它应指向属于另一个自治系统的路由器。

                    也可以为默认路由指定转发地址。例如，在图16中，RTA可能希望指定所有外部目的的包默认转发到其BGP对等体RTX。生成的AS外部LSA如下所示。注意，链路状态ID被设置为DefaultDestination。

        ; 默认路由，由路由器RTA生成
        ; 包通过RTX转发

        LS age = 0                  ;在原始生成时总是为0
        选项 = (E位)               ;
        LS类型 = 5                 ;AS外部链路状态广告（AS-external-LSA）
        链路状态ID = DefaultDestination  ; 默认路由
        广告路由器 = 路由器RTA的ID
        E位 = 1                   ;类型2度量
        度量 = 1
        转发地址 = RTX的IP地址

                    在图16中，假设RTA和RTB都与RTX交换BGP信息。在这种情况下，



Moy                         标准轨迹                   [第141页]


RFC 2328                     OSPF版本2                   1998年4月
```

RTA 和 RTB 将产生相同集的 AS-外部 LSAs。这些 LSAs 如果指定了相同的度量值，则在功能上是等价的，因为它们会指定相同的目的地和转发地址（RTX）。这会导致明显的重复工作。如果只有 RTA 或 RTB 之一产生这组 AS-外部 LSAs，路由信息将保持不变，链路状态数据库的大小也会减小。然而，必须明确规定由哪个路由器产生这些 LSAs（否则可能都不产生，或者产生者的身份可能会波动）。因此，建立了以下规则：如果两个路由器（彼此可达）都产生功能上等价的 AS-外部 LSAs（即相同的目的地、成本和非零的转发地址），则由具有较高 OSPF 路由器ID的路由器产生的 LSAs 被采用。拥有较低 OSPF 路由器ID的路由器可以随后清除其产生的 LSAs。清除 LSA 的操作将在第14.1节中讨论。

图16：转发地址示例

```
                    +
                    |
          +---+.....|.BGP
          |RTA|-----|.....+---+
          +---+     |-----|RTX|
                    |     +---+
          +---+     |
          |RTB|-----|
          +---+     |
                    |
          +---+     |
          |RTC|-----|
          +---+     |
                    |
                    +
```

第16图：转发地址示例

Moy  规范追踪  [第142页]

RFC 2328  版本2的OSPF  1998年4月

13.  泛洪程序

链路状态更新包提供了泛洪 LSAs 的机制。一个链路状态更新包可以包含多个不同的 LSAs，并将每个 LSA 向其产生点的下一跳进行泛洪。为了使泛洪过程可靠，每个 LSA 必须单独得到确认。确认信息通过链路状态确认包进行传输。许多确认可以被组合成一个包一起发送。

当收到一份链路状态更新（Link State Update）数据包时，泛洪程序开始执行。在将数据包交给泛洪程序之前，已经对收到的数据包进行了多项一致性检查（参见第8.2节）。特别地，链路状态更新包已与特定的邻居和特定的区域相关联。如果邻居的状态低于交换（Exchange）状态，则应直接丢弃该数据包，无需进一步处理。

除AS外部链路状态广告（AS-external-LSA）之外，所有类型的LSA都与特定区域相关联。然而，LSA本身不包含区域字段。必须通过链路状态更新包头部推断出LSA所属的区域。

对于每个包含在链路状态更新包中的LSA，采取以下步骤：

1. 验证该LSA的链路状态（LS）校验和。如果校验和无效，则丢弃该LSA，并处理包中的下一个LSA。

2. 检查LSA的LS类型。如果LS类型未知，则丢弃该LSA，并处理包中的下一个LSA。该规范定义了LS类型1-5（见第4.3节）。

3. 如果这是一个AS-external-LSA（LS类型=5），且该区域已被配置为存根区域，则丢弃该LSA，并处理包中的下一个LSA。AS-external-LSA不会在存根区域内泛洪（见第3.6节）。

4. 如果该LSA的年龄（LS age）等于最大年龄（MaxAge），且路由器的链路状态数据库中目前没有该LSA的实例，且路由器的邻居中没有处于交换（Exchange）或加载（Loading）状态的邻居，则采取以下措施：a）向发送邻居发送链路状态确认（Link State Acknowledgment）包以确认已收到该LSA（见第13.5节）；b）丢弃该LSA，并检查链路状态更新包中列出的下一个LSA（如果有的话）。

5. 否则，找到当前存储在路由器链路状态数据库中的该LSA实例。如果没有数据库副本，或者收到的LSA比数据库中的副本更新（具体判断哪个更近期，见第13.1节），则必须执行以下步骤：

   (a) 如果已有数据库副本，并且该副本是通过泛洪获得且在少于MinLSArrival秒前安装的，则丢弃新接收的LSA（不发送确认），并处理包中的下一个LSA（如果有的话）。

（b）否则，立即将新的LSA泛洪到路由器接口的某个子集（参见第13.3节）。在某些情况下（例如，接收接口的状态为DR，并且LSA是从除备用DR之外的其他路由器接收的），LSA将会从接收接口重新泛洪出去。此类情况应被记录，以便后续的确认过程（第13.5节）使用。

（c）从所有邻居的链路状态重传列表中移除当前数据库副本。

（d）将新的LSA安装到链路状态数据库中（替换当前的数据库副本）。这可能会触发路由表的重新计算。此外，用当前时间（即接收时间）为新LSA打上时间戳。在最小LSA到达时间（MinLSArrival）秒数未过之前，泛洪过程不能覆盖新安装的LSA。关于LSA安装过程的详细内容，请参见第13.2节。

（e）可能通过向接收接口发送链路状态确认包，确认已收到该LSA。具体内容将在第13.5节中详细说明。

（f）如果该新LSA表明它是由接收路由器自己生成的（即，属于自发LSA），则路由器必须采取特殊措施，可能包括更新该LSA或在某些情况下将其从路由域中清除。关于如何检测和处理自发LSA的详细信息，请参见第13.4节。

（6）否则，如果在发送邻居的链路状态请求列表中存在该LSA的实例，说明数据库交换过程中发生了错误。在这种情况下，应通过生成邻居事件BadLSReq，重新启动邻居的数据库交换过程，并停止处理链路状态更新包。

（7）否则，如果接收到的LSA与数据库中的副本是相同的实例（即，两者都不是更新的），应执行以下两个步骤：

（a）如果该LSA在接收邻接的链路状态重传列表中，则路由器正期待对此LSA的确认。路由器应将接收到的LSA视为确认，将其从链路状态重传列表中移除。这被称为“隐含确认”。此类情况应被记录，以便后续的确认过程（第13.5节）使用。

（b）可能通过向接收接口发送链路状态确认包（Link State Acknowledgment packet）来确认已收到LSA。这在下面的第13.5节中有详细说明。

（8）否则，数据库副本较新。如果数据库副本的LS年龄（LS age）等于MaxAge，且LS序列号（LS sequence number）等于MaxSequenceNumber，则只需丢弃接收到的LSA而不进行确认。（在这种情况下，LSA的LS序列号已达到最大值并开始环绕，必须完全清除MaxSequenceNumber的LSA后，才能引入新的LSA实例。）否则，只要数据库副本在最近的MinLSArrival秒内没有作为链路状态更新（Link State Update）被发送出去，就应将数据库副本作为链路状态更新包（Link State Update Packet）的一部分，发回给发送方邻居。该链路状态更新包应直接发送给邻居。在此过程中，不要将该数据库副本放入邻居的链路状态重传列表，也不要对较旧的（接收的）LSA实例进行确认。

13.1 确定哪个LSA更新

当路由器遇到两个相同的LSA实例时，必须判断哪个更为新近。这在前面比较接收的LSA与其数据库副本时已提及。在邻接建立过程中进行的数据库交换（Database Exchange）中，也需要进行此比较。

LSA由其LS类型（LS type）、链路状态ID（Link State ID）和广告路由器（Advertising Router）共同标识。对于两个相同的LSA实例，使用LS序列号（LS sequence number）、LS年龄（LS age）和LS校验和（LS checksum）字段来判断哪个实例更为新近：

- 拥有较新LS序列号的LSA更为新近。关于LS序列号空间的详细说明请参见第12.1.6节。如果两个实例的LS序列号相同，则：

- 如果两个实例的LS校验和不同，则LS校验和较大的（作为16位无符号整数）实例被视为更为新近。

- 否则，如果只有其中一个实例的LS年龄字段设置为MaxAge，则LS年龄为MaxAge的实例被视为更为新近。

- 否则，如果两个实例的LS年龄相差超过MaxAgeDiff，则LS年龄较小（较年轻）的实例被视为更为新近。

- 否则，两个实例被视为相同。

13.2 在数据库中安装LSA

在数据库中安装新的LSA，无论是由于泛洪还是新自发生成的LSA，都可能导致OSPF路由表结构重新计算。应将新LSA的内容与旧实例（如果存在）进行比较。如果没有差异，则无需重新计算路由表。在比较LSA与其先前实例时，以下情况都被视为内容不同：

- LSA的Options字段发生了变化。
- 其中一个LSA实例的LS年龄设置为MaxAge，而另一个没有。
- LSA头部中的长度字段发生了变化。
- LSA的主体（即20字节LSA头部之外的部分）发生了变化。注意，这不包括LS序列号和LS校验和的变化。

如果内容不同，则必须根据新LSA的LS类型字段，重新计算路由表的以下部分：

路由器LSAs和网络LSAs
- 必须重新计算整个路由表，从每个区域的最短路径计算开始（不仅仅是发生变化的链路状态数据库所在的区域）。不能只限制在单一变化的区域进行最短路径计算的原因在于，自治系统边界路由器可能属于多个区域。当前提供最佳路径的区域发生变化，可能会导致路由器使用由不同区域提供的区域内路径。

摘要LSAs
- 必须重新计算到由摘要LSA描述的目的地的最佳路径（参见第16.5节）。如果该目的地是自治系统边界路由器，还可能需要重新检查所有的自治系统外部LSAs。

自治系统外部LSAs
- 必须重新计算到由AS外部LSA描述的目的地的最佳路径（参见第16.6节）。

此外，在安装新LSA时，必须从数据库中删除所有旧实例。这个旧实例也必须从所有邻居的链路状态重传列表中移除（参见第10节）。

13.3 泛洪过程的下一步

当接收到一个新的（且较新的）LSA时，必须将其泛洪到路由器的某些接口上。本节描述了泛洪过程的第二部分（第一部分是第13节中所述的处理过程），即选择出接口并将LSA添加到相应邻居的链路状态重传列表中。此外，本节还包括维护邻居的链路状态请求列表的内容。

本节同样适用于由路由器自己生成的LSA的泛洪（参见第12.4节）。对于这些LSA，本节提供了完整的泛洪流程（即不执行第13节中的处理，因为例如该LSA未从邻居处接收，因此无需确认）。

根据LSA的链路状态类型，LSA可能只会在某些特定的接口上进行泛洪。这些接口由以下定义，称为“符合条件的接口”：

- 区域外部LSA（LS类型=5）
  区域外部LSA会在整个自治系统（AS）中进行泛洪，但不包括存根区域（参见第3.6节）。符合条件的接口是所有路由器的接口，但不包括虚拟链路和连接到存根区域的接口。

- 其他所有LS类型
  其他类型的LSA仅在单一区域（区域A）内进行泛洪。符合条件的接口是所有连接到区域A的接口。如果区域A是骨干区域，则还包括所有虚拟链路。

链路状态数据库必须在所有与上述符合条件接口相关的邻接点上保持同步。这通过在每个符合条件的接口上执行以下步骤来实现。需要注意的是，该过程可能会决定不将LSA泛洪到某个特定接口，如果很可能连接的邻居已经接收了该LSA。然而，在这些情况下，泛洪过程必须确保邻居最终都能收到该LSA，因此仍会将LSA添加到每个邻接点的链路状态重传列表中。对于每个符合条件的接口，执行以下操作：

(1) 检查连接到该接口的每个邻居，以确定它们是否必须接收新的LSA。对每个邻居执行以下步骤：

(a) 如果邻居的状态低于交换（Exchange）状态，则它不参与泛洪，接下来应检查下一个邻居。

（b）否则，如果邻接尚未满（邻居状态为交换或加载），则检查与此邻接相关联的链路状态请求列表。如果列表中存在新LSA的实例，说明邻居路由器已经拥有该LSA的实例。将新LSA与邻居的副本进行比较：

- 如果新LSA不如邻居的副本新，则检查下一个邻居。

- 如果两者是相同的实例，则从链路状态请求列表中删除该LSA，并检查下一个邻居。

- 否则，说明新LSA更为新鲜。从链路状态请求列表中删除该LSA。

（c）如果新LSA是从该邻居接收的，则检查下一个邻居。

（d）此时，我们还不能确定邻居是否拥有该新LSA的最新实例。应将新LSA添加到该邻接的链路状态重传列表中。这确保了泛洪过程的可靠性；该LSA将会在一定间隔内被重新传输，直到收到邻居的确认。

（2）路由器现在必须决定是否通过该接口泛洪新LSA。如果在前面的步骤中，LSA没有被添加到任何链路状态重传列表中，则无需通过该接口泛洪该LSA，应检查下一个接口。

（3）如果在该接口上接收到新LSA，并且是从指定路由器（Designated Router）或备用指定路由器（Backup Designated Router）接收的，很可能所有邻居都已接收该LSA。因此，应检查下一个接口。

（4）如果在该接口上接收到新LSA，并且该接口状态为备用（即路由器本身是备用指定路由器），则应检查下一个接口。指定路由器将在此接口上进行泛洪。然而，如果指定路由器失效（即备用指定路由器），则由该路由器（备用指定路由器）负责重新传输更新。

（5）如果到达了此步骤，必须将该LSA通过接口进行泛洪。向该接口发送一份链路状态更新包（其中包含新的LSA内容）。在将LSA复制到即将发送的链路状态更新包中时，LSA的LS年龄（LS age）必须增加InfTransDelay（该值必须大于0），直到LS年龄字段达到最大值MaxAge。

在广播网络中，链路状态更新包采用多播方式。链路状态更新包的目标IP地址取决于接口的状态。如果接口状态为DR（指定路由器）或备份（Backup），应使用AllSPFRouters地址。否则，应使用AllDRouters地址。

在非广播网络中，必须以单播方式向每个相邻邻居（即状态为Exchange或更高的邻居）单独发送链路状态更新包。这些包的目标IP地址是邻居的IP地址。

13.4 接收自我生成的LSA

路由器通过泛洪过程接收自我生成的LSA是常见的情况。当检测到一份LSA是自我生成的，通常有两种情况：1）该LSA的广告路由器（Advertising Router）等于路由器自己的Router ID；或2）该LSA是网络LSA（network-LSA），且其链路状态ID（Link State ID）等于路由器自己某个IP接口的地址。

然而，如果接收到的自我生成LSA比路由器上次实际生成的LSA更新得更为新鲜，路由器必须采取特殊措施。接收此类LSA表明在路由域中存在由该路由器在上次重启之前生成的LSA。在大多数情况下，路由器应将该LSA的LS序列号（LS sequence number）提前一位（即比接收到的LS序列号大1），并生成一份新的LSA实例。

可能的情况是，路由器不再希望发出接收到的LSA（链路状态广告）。一些可能的例子包括：1）该LSA是一个摘要LSA或AS外部LSA，而路由器不再拥有（可广告的）到目的地的路由；2）该LSA是一个网络LSA，但路由器不再是该网络的指定路由器；3）该LSA是一个网络LSA，其链路状态ID是路由器自身的某个IP接口地址，但其广告路由器（Advertising Router）并不等于路由器自己的路由器ID（这种情况较少，意味着自从发出该LSA后，路由器的路由器ID发生了变化）。在所有这些情况下，路由器不应更新该LSA，而应通过将接收的LSA的LS年龄（LS age）设置为最大年龄（MaxAge）并重新泛洪（reflood）来将其从路由域中清除（详见第14.1节）。

---

Moy                         标准轨迹                   [第151页]

RFC 2328                     OSPF第2版                   1998年4月

13.5. 发送链路状态确认包

每个新接收的LSA都必须得到确认。通常通过发送链路状态确认包（Link State Acknowledgment packets）来完成。然而，也可以通过发送链路状态更新包（Link State Update packets）（参见第13节第7a步）隐式地进行确认。

多个确认可以组合成一个链路状态确认包，并通过接收LSA的接口发出。该包可以通过两种方式之一发送：延迟后定期发送，或直接发送给特定的邻居。具体采用哪种确认策略，取决于接收LSA的具体情况。

延迟确认的好处包括：1）便于将多个确认打包在一个链路状态确认包中；2）允许单个链路状态确认包同时确认多个邻居（通过多播）；3）随机化由连接到同一网络的不同路由器发送的链路状态确认包。路由器的延迟传输间隔必须较短（小于重传间隔RxmtInterval），否则会导致不必要的重传。

直接确认则是在收到重复的LSA时，立即直接发给特定邻居。多点接入网络中，这些确认会直接发到邻居的IP地址。

关于发送链路状态确认包的具体流程，详见表19。左栏列出了收到LSA（链路状态广告）的相关情况，右侧的两个栏目之一列出了相应的确认操作。该操作取决于相关接口的状态；处于备用（Backup）状态的接口与其他状态的接口表现不同。延迟确认必须传送给所有与该接口相连的邻居路由器。在广播网络中，这通过以多播方式发送延迟链路状态确认包来实现。所用的目标IP地址取决于具体情况。

| 情况 | 备用状态下的操作 | 其他状态下的操作 |
| --- | --- | --- |
| LSA已在接收接口（见第13节第5b步）中被泛洪出去 | 不发送确认 | 不发送确认 |
| LSA比数据库中的副本更新，但未在接收接口处被泛洪出去 | 发送延迟确认（如果广告来自指定路由器），否则不操作 | 发送延迟确认（如果广告来自指定路由器），否则不操作 |
| LSA是重复的，并且被视为隐含确认（见第13节第7a步） | 发送延迟确认（如果广告来自指定路由器），否则不操作 | 发送延迟确认（如果广告来自指定路由器），否则不操作 |
| LSA是重复的，且未被视为隐含确认 | 直接发送确认 | 直接发送确认 |
| LSA的寿命（LSAge）等于MaxAge，且链路状态数据库中没有当前的LSA实例，且邻居中没有处于Exchange或Loading状态（见第13节第4步） | 直接发送确认 | 直接发送确认 |

（以上内容摘自RFC 2328第19页，标题为“发送链路状态确认”的表19。）

关于界面状态的说明。如果界面状态为DR（指定路由器）或备份DR，则使用目标“AllSPFRouters”。在其他所有状态下，使用目标“AllDRouters”。在非广播网络上，延迟的链路状态确认包必须通过每个邻接（即状态≥Exchange的邻居）单独进行单播。

将上述确认包作为多播发送的原因，最好通过一个示例来说明。考虑图15所示的网络配置。假设RT4已被选为指定路由器，RT3为网络N3的备份指定路由器。当RT4向网络N3泛洪一条新的LSA时，RT1、RT2和RT3都会收到。这些路由器不会将LSA再次泛洪到N3网络上，但它们仍需确保其链路状态数据库与邻接的邻居保持同步。因此，RT1、RT2和RT4都在等待RT3的确认。同样，RT4和RT3都在等待RT1和RT2的确认。这一过程通过多播确认包的方式实现效果最佳。

备份DR的确认逻辑略有不同，原因在于它们在LSA泛洪过程中表现不同（详见第13.3节第4步）。

---

13.6. 重新传输LSA

通过邻接泛洪出去的LSA会被放入邻接的链路状态重传列表中。为了确保泛洪的可靠性，这些LSA会被不断重传，直到收到确认。重传的时间间隔由每个接口的可配置值RxmtInterval控制。如果设置得太低，会导致不必要的重传；如果设置得太高，在丢包情况下，泛洪速度可能受到影响。

多个重传的LSA可以被打包到一个链路状态更新包中。当需要重传LSA时，只应发送能容纳在单个链路状态更新包中的数量。随着部分LSA被确认，可以再次发送另一包重传，或者在下一次重传定时器触发时进行。

携带重传的链路状态更新包总是直接发送给邻居。在多访问网络中，这意味着重传包直接发到邻居的IP地址。每个LSA的LS年龄在复制到发出的链路状态更新包时，必须增加InfTransDelay（该值必须大于0），直到LS年龄字段达到最大值MaxAge。

如果相邻的路由器宕机，重传可能会持续发生，直到通过OSPF的Hello协议破坏邻接关系。当邻接关系被破坏时，链路状态重传列表将被清空。

13.7 接收链路状态确认

在将接收到的链路状态确认包交给泛洪程序之前，已对其进行了多项一致性检查。特别是，该确认包已与某个特定邻居关联。如果该邻居的状态低于交换（Exchange）状态，则该链路状态确认包将被丢弃。

否则，对于链路状态确认包中的每个确认项，执行以下步骤：

- 被确认的LSA是否在该邻居的链路状态重传列表中？如果没有，检查下一个确认项。否则：

- 如果确认的LSA是列表中对应的实例，则将该项从列表中移除，并检查下一个确认项。否则：

- 记录该可疑的确认信息，并检查下一个确认项。

14. 链路状态数据库的老化

每个LSA（链路状态广告）都包含一个LS年龄字段，表示其存活时间，单位为秒。当LSA存放在路由器的数据库中时，其LS年龄会递增。此外，当LSA被复制到链路状态更新包中以通过特定接口进行泛洪时，LSA的LS年龄会增加InfTransDelay。

LSA的LS年龄不会超过最大年龄（MaxAge）值。年龄为MaxAge的LSA不会被用于路由表的计算。当路由器对其链路状态数据库进行老化时，LSA的LS年龄可能会达到MaxAge。此时，路由器必须尝试将该LSA从路由域中清除。这一操作通过重新泛洪MaxAge的LSA实现，就像新生成的LSA一样（参见第13.3节）。

在为新建立的邻接关系创建数据库摘要列表时，数据库中存在的MaxAge LSAs会被加入到邻居的链路状态重传列表中，而不是加入邻居的数据库摘要列表中。详细信息请参见第10.3节。

一旦满足以下两个条件，MaxAge LSA必须立即从路由器的链路状态数据库中移除：a）它不再包含在任何邻居的链路状态重传列表中；b）没有任何邻居处于交换（Exchange）或加载（Loading）状态。

在对链路状态数据库进行老化的过程中，当某个LSA的LS年龄达到CheckAge的倍数时，应验证其LS校验和。如果LS校验和不正确，说明检测到程序或内存错误，至少应重启路由器本身。

Moy                         标准追踪                   [第156页]

RFC 2328                     OSPF第2版                   1998年4月

14.1  LSA的提前老化

可以通过将LSA的LS年龄设置为MaxAge，同时保持其LS序列号不变，然后重新泛洪该LSA，从而将其从路由域中冲刷出去。此过程与自然达到MaxAge值的LSA被冲刷的过程相同（参见第14节）。特别地，当满足以下条件时，MaxAge LSA会从路由器的链路状态数据库中移除：a) 它不再包含在任何邻居的链路状态重传列表中，且b) 其所有邻居都不处于Exchange或Loading状态。我们将将LSA的LS年龄设置为MaxAge的操作称为“提前老化”。

提前老化在以下情况下使用：当自发LSA的序列号字段需要环绕时。例如，当前的LSA实例（序列号为MaxSequenceNumber）必须提前老化并从路由域中冲刷出去，才能发出一个序列号为InitialSequenceNumber的新实例。更多信息请参见第12.1.6节。

此外，提前老化还可用于当路由器之前广告的某个外部路由变得不可达时。在这种情况下，路由器可以通过提前老化将其AS外部LSA从路由域中冲刷出去。这一操作优于另一种方案，即为目的地发出一个新的LSA，并将度量值设为LSInfinity。当在泛洪过程中意外收到自己发出的LSA时，也会使用提前老化（参见第13.4节）。

路由器只能提前老化自己发出的LSA，不能提前老化由其他路由器发出的LSA。当LSA满足以下条件之一时，视为自发LSA：1）LSA的广告路由器等于路由器的自身ID；或2）该LSA是网络LSA，且其链路状态ID等于路由器的某个IP接口地址。

Moy                         标准追踪                   [第157页]

RFC 2328                     OSPF第2版                   1998年4月

15.  虚拟链路

单一的骨干区域（区域ID = 0.0.0.0）不能被断开，否则自治系统的某些区域将变得无法到达。为了建立和维护骨干的连通性，可以通过非骨干区域配置虚拟链路。虚拟链路的作用是连接物理上分离的骨干部分。虚拟链路的两个端点是区域边界路由器。虚拟链路必须在两个路由器上都进行配置。每个路由器中的配置信息包括另一个虚拟端点（即另一区域边界路由器）以及两个路由器共有的非骨干区域（称为中转区域）。虚拟链路不能通过存根区域配置（详见第3.6节）。

虚拟链路被视为一条未编号的点对点网络，属于骨干区域，并连接两个区域边界路由器。系统会尝试在虚拟链路上建立邻接关系。一旦邻接关系建立，虚拟链路将包含在骨干路由器的链路状态广告（LSA）中，且与骨干区域相关的OSPF数据包将通过该邻接关系传输。此类邻接关系在本文档中称为“虚拟邻接”。

在每个端点路由器中，虚拟链路的代价和可行性通过检查另一端点路由器的路由表项来确定（该路由表项所关联的区域必须是配置的中转区域）。这被称为虚拟链路的对应路由表项。当其对应的路由表项变得可达时，就会发生接口上线事件（InterfaceUp）；反之，当路由表项变得不可达时，则会发生接口下线事件（InterfaceDown）。换句话说，虚拟链路的可行性取决于两个端点之间通过中转区域存在一条区域内路径。请注意，底层路径的成本如果大于十六进制的0xffff（即路由器LSA中接口成本的最大值），则应视为不可操作（即与路径不存在的情况相同）。

关于虚拟链路的其他细节如下：

- AS外部LSA绝不通过虚拟邻接关系进行泛洪。这是因为在中转区域内已经对相同的AS外部LSA进行了泛洪，重复泛洪会造成资源浪费。
- 在数据库交换过程中，AS外部LSA也不会通过虚拟邻接关系进行摘要（总结）。

- 虚拟链路的成本未被配置。它被定义为两个定义该区域边界路由器之间的区域内路径的成本。该成本显示在虚拟链路对应的路由表项中。当虚拟链路的成本发生变化时，应生成一个新的路由器LSA，用于骨干区域。

- 就像虚拟链路的成本和可行性由路由表构建过程（通过为另一端点构建路由表项）决定一样，虚拟接口的IP地址和虚拟邻居的IP地址也是如此。这些信息在通过虚拟链路发送OSPF协议包时使用。请注意，当虚拟链路的一个（或两个）端点通过未编号的点对点链路连接到中继区域时，可能无法计算出虚拟接口的IP地址和/或虚拟邻居的IP地址，从而导致虚拟链路失效。

- 在每个骨干区域端点的路由器LSA中，虚拟链路被表示为类型4链路，其链路ID设置为虚拟邻居的OSPF路由器ID，链路数据设置为虚拟接口的IP地址。有关更多信息，请参见第12.4.1节。

- 非骨干区域只有在作为一个或多个完全相邻的虚拟链路的中继区域时，才可以承载中继数据流量（即被视为“中继区域”）（参见第6节和第16.1节中的TransitCapability）。这样的区域在将骨干网络汇总到该区域时需要特殊处理（参见第12.4.3节），以及在路由计算过程中（参见第16.3节）。

- 虚拟链路的链路状态重传间隔时间（RxmtInterval）是为虚拟链路配置的。这个时间应远大于两个路由器之间的预期往返延迟。对于虚拟链路来说，这可能很难估算；最好偏向于设置得过大一些。

16. 路由表的计算

本节详细介绍OSPF路由表的计算过程。路由器以其附属区域的链路状态数据库作为输入，运行以下算法，逐步构建其路由表。在每一步中，路由器必须访问链路状态数据库的各个部分（例如，由某个路由器发起的路由器LSA）。这种访问由第12.2节讨论的查找函数完成。查找过程可能返回一个LS年龄等于MaxAge的LSA。这样的LSA不应在路由表计算中使用，应视为查找失败。

OSPF路由表的组织结构在第11节中进行了说明。
在第11.2节和第11.3节中提供了两个路由表构建过程的示例。
该过程可以分为以下几个步骤：

（1）使当前的路由表失效。重新从头构建路由表。旧的路由表会被保存，以便识别路由表条目的变化。

（2）通过为每个连接的区域构建最短路径树，计算区域内的路由。特别是，在此步骤中会计算所有目标类型为“区域边界路由器”的路由表条目。此步骤分为两个部分：首先，只考虑路由器之间和中继网络之间的链路，构建树；然后，将虚接网络（stub networks）加入到树中。在区域的最短路径树计算过程中，还会计算该区域的TransitCapability，以便在第4步中使用。

（3）通过检查汇总链路状态广告（summary-LSAs）来计算区域间路由。如果路由器连接多个区域（即为区域边界路由器），则只检查骨干区域的汇总-LSAs。

（4）在连接一个或多个中继区域（Transit Areas，即非骨干区域且其TransitCapability被设置为TRUE）的区域边界路由器中，检查中继区域的汇总-LSAs，以判断是否存在比步骤2-3中找到的更优路径。

（5）通过检查自治系统外部链路状态广告（AS-external-LSAs）来计算到外部目的地的路由。自治系统边界路由器（产生AS-external-LSAs的位置）已在步骤2-4中确定。

步骤2至5的详细内容将在下文中进一步说明。

由于这些计算引起的路由表条目的变化，可能会促使OSPF协议采取进一步的行动。例如，对区域内路由的更改会导致区域边界路由器生成新的汇总-LSAs（参见第12.4节）。有关因路由表变化而引发的OSPF协议行动的完整列表，请参见第16.7节。

16.1节：为某个区域计算最短路径树

该计算产生与某一区域（以下简称区域A）相关联的区域内路由集合。路由器使用自己作为根节点，计算出最短路径树。[22] 最短路径树的形成在这里分为两个阶段。在第一阶段，只考虑路由器与中继网络之间的链路。利用Dijkstra算法，从这一部分链路状态数据库中形成一棵树。在第二阶段，通过考虑到边界网络的链路，将叶子节点加入到树中。

该过程将使用第2节中介绍的图论术语进行说明。区域的链路状态数据库被表示为一个有向图。图的顶点包括路由器、中继网络和边界网络。在该过程的第一阶段，仅涉及中继顶点（路由器和中继网络）及其连接的链路。在整个最短路径计算过程中，每个中继顶点还关联以下数据：

- 顶点（节点）ID
  一个32位数字，结合顶点类型（路由器或网络）唯一标识该顶点。对于路由器顶点，顶点ID是该路由器的OSPF路由器ID；对于网络顶点，则是该网络的指定路由器的IP地址。

- LSA（链路状态广告）
  每个中继顶点都关联有一个LSA。对于路由器顶点，这是一个路由器LSA；对于中继网络，则是网络LSA（实际上由该网络的指定路由器发出）。无论是哪种情况，LSA的链路状态ID始终等于上述的顶点ID。

- 下一跳列表
  从根节点到该顶点的当前一组最短路径的下一跳列表。由于具有等成本多路径能力，可能存在多条最短路径。每个下一跳指示在转发到目的地时应使用的出口路由器接口。在广播、点对多点和非广播多接入（NBMA）网络中，下一跳还包括通向目的地路径中下一台路由器的IP地址（如果有的话）。

- 从根节点的距离
  从根节点到该顶点的当前一组最短路径的链路状态成本。路径的链路状态成本是由路径中各个链路的成本（在路由器LSA和网络LSA中广告的值）相加得出。如果一条路径的链路状态成本比另一条路径小，则前者被认为“更短”。

以下是英文内容的中文翻译：

---

该程序的第一阶段（即迪杰斯特拉算法）可以总结如下：在算法的每次迭代中，都会有一个候选顶点列表。已找到从根到这些顶点的路径，但不一定是最短路径。然而，距离根最近的候选顶点的路径保证是最短的；该顶点会被加入到最短路径树中，从候选列表中移除，并且会检查其相邻顶点，是否可以加入或修改候选列表。然后，算法再次迭代。当候选列表变为空时，算法终止。

以下步骤详细描述了该算法。请记住，我们正在为区域A计算最短路径树。所有关于链路状态数据库查找的引用，均来自区域A的数据库。

（1）初始化算法的数据结构。清空候选顶点列表。将最短路径树初始化为仅包含根节点（即进行计算的路由器）。将区域A的TransitCapability设置为FALSE。

（2）将刚加入树中的顶点称为顶点V。检查与顶点V相关联的LSA（链路状态广告）。这是在区域A的链路状态数据库中根据顶点ID进行的查找。如果这是一个路由器LSA，并且路由器LSA的位V（见第A.4.2节）被设置，则将区域A的TransitCapability设置为TRUE。无论如何，LSA中描述的每个链路都提供到相邻顶点的代价。对于每个描述的链路（假设它连接顶点V和顶点W）：

(a) 如果这是通向一个盲点网络的链路，则检查V的LSA中的下一条链路。通向盲点网络的链路将在最短路径计算的第二阶段考虑。

(b) 否则，W是一个中转顶点（路由器或中转网络）。在区域A的链路状态数据库中查找顶点W的LSA（路由器LSA或网络LSA）。如果LSA不存在，或其LS年龄等于MaxAge，或它没有指向顶点V的链路，则检查V的LSA中的下一条链路。

(c) 如果顶点W已经在最短路径树上，则检查LSA中的下一条链路。

(d) 计算从根到顶点W的路径的链路状态代价D。D等于已计算的到顶点V的最短路径的链路状态代价与顶点V和W之间链路的广告代价之和。如果D满足以下条件：

莫伊  标准轨道  [第163页]

RFC 2328  OSPF 版本2  1998年4月

                o   如果该值大于候选列表中顶点W已出现的值，则继续检查下一个链路。

                o   如果该值等于候选列表中顶点W已出现的值，则计算使用广告链路后得到的下一跳集合。该计算的输入是目标（W）及其父节点（V）。此计算详见第16.1.1节。该集合的下一跳应添加到候选列表中W对应的下一跳值中。

                o   如果该值小于候选列表中顶点W已出现的值，或者W尚未出现在候选列表中，则将候选列表中W的条目设置为距离根节点的距离D。同时，计算使用广告链路后得到的下一跳列表，并相应地设置W的下一跳值。下一跳的计算方法详见第16.1.1节；其输入是目标（W）及其父节点（V）。

        (3) 如果在此步骤中候选列表为空，则最短路径树（传输顶点）已完全构建完毕，本阶段的过程结束。否则，选择候选列表中距离根节点最近的顶点，并将其加入最短路径树（在此过程中将其从候选列表中移除）。注意，当存在多个距离根节点相同的顶点时，必须优先选择网络顶点而非路由器顶点，以确保找到所有等成本路径。这与OSPF多播路由扩展（MOSPF）中使用的修改版Dijkstra算法引入的平局规则一致。

        (4) 可能需要修改路由表。对于被修改的路由表项，相关区域将被设置为区域A，路径类型将被设置为区域内路径，路径代价将被设置为新发现的最短路径的计算距离。

莫伊  标准轨道  [第164页]

RFC 2328  OSPF 版本2  1998年4月

如果新添加的顶点是区域边界路由器或自治系统边界路由器，则会在路由表中添加一条目的，其目标类型为“路由器”。与之相关的路由器LSA中的Options字段会被复制到该路由表条目的可选能力字段中。将新添加的顶点称为路由器X。如果路由器X是某个计算路由器的虚拟链路的端点，并且该虚拟链路使用区域A作为中转区：则虚拟链路被声明为已连接，虚拟接口的IP地址设置为上面为路由器X计算的出接口的IP地址，虚拟邻居的IP地址设置为指向最短路径树根的路由器X接口地址（包含在路由器X的路由器LSA中）；等同于指向最短路径树中路由器X父顶点的接口（类似于第16.1.1节中的计算方式）。

如果新添加的顶点是一个中继网络，则会找到该网络的路由表条目。该条目的目标ID为IP网络号，可以通过将顶点ID（链路状态ID）与其相关的子网掩码（在对应的网络LSA的正文中找到）进行掩码操作获得。如果路由表中已经存在该条目（即已经在路由表中安装了到该目的地的区域内路由），则多个顶点映射到同一IP网络。例如，当建立新的指定路由器时可能会发生这种情况。在这种情况下，只有当新发现的路径与现有路径一样短，并且当前路由表条目的链路状态起源的链路状态ID比新添加的顶点的LSA的链路状态ID更小时，才应覆盖当前的路由表条目。

如果没有该网络的路由表条目（这是常见情况），则应添加一条指向该IP网络的路由表条目。该路由表条目的链路状态起源应设置为新添加的顶点的LSA。

（5）通过返回步骤2，迭代执行该算法。

在程序的第二阶段，将虚拟网络（stub networks）添加到树中。在这一阶段，所有的路由器顶点将再次被检查。那些在上述第一阶段中已被判定为无法到达的顶点将被丢弃。对于每个可达的路由器顶点（记为V），在链路状态数据库中找到与之关联的路由器LSA。然后，检查LSA中出现的每个虚拟网络链路，并执行以下步骤：

（1）计算虚拟网络到根的距离D。D等于从根到该路由器顶点的距离（在第一阶段中已计算）加上虚拟网络链路的广告成本。将此距离与当前到该虚拟网络的最佳路由成本进行比较。这可以通过查找虚拟网络当前的路由表项实现。如果计算出的距离D大于当前的成本，则继续检查LSA中的下一个虚拟网络链路。

（2）如果到达此步骤，说明需要更新虚拟网络的路由表项。计算使用该虚拟网络链路后可能的下一跳集合。此计算详见第16.1.1节；输入参数为目标（虚拟网络）和父顶点（路由器顶点）。如果距离D与当前路由表中的成本相同，则只需将此下一跳集合添加到路由表项的下一跳列表中。在这种情况下，路由表已经有一个链路状态源（Link State Origin）。如果该链路状态源是一个路由器LSA，且其链路状态ID小于V的路由器ID，则将链路状态源重置为V的路由器LSA。

否则，距离D小于当前路由表中的成本。应覆盖当前的路由表项，将其成本设置为D，并将下一跳列表更新为新计算的集合。将路由表项的链路状态源设置为V的路由器LSA。然后继续检查下一个虚拟网络链路。

对于在第二阶段中添加或修改的所有路由表项，相关区域将被设置为区域A，路径类型将被设置为区域内（intra-area）。当所有可达的路由器LSA列表都已检查完毕后，第二阶段结束。此时，所有与区域A相关的区域内路由已被确定。

该规范并不要求必须采用上述两阶段方法来计算最短路径树。然而，如果使用其他算法，也必须生成相同的树。因此，必须注意，连接中转顶点的链路必须是双向的，才能包含在上述树中。同时，还应提及，存在更高效的算法用于计算该树，例如[Ref1]中描述的增量式SPF算法。

16.1.1. 下一跳的计算

本节说明如何计算用于到达某个目的地的当前下一跳集合。每个下一跳由用于转发数据包到目的地的出口接口以及下一跳路由器的IP地址（如果有的话）组成。每当发现到该目的地的更短路径时，就会调用下一跳的计算。这可能发生在最短路径树计算的任一阶段（见第16.1节）。在第一阶段，当目的地被加入候选列表或当目的地在候选列表中的条目被修改时（阶段1的步骤2d），就会找到一条更短的路径。在第二阶段，每当目的地的路由表条目被修改时（阶段2的步骤2），也会发现一条更短的路径。

在最短路径树的计算过程中，可能会多次重新计算目的地的下一跳集合，以反映不断发现的更短路径。最终，目的地的路由表条目将始终反映由绝对最短路径（或路径）所确定的下一跳。

下一跳的计算输入包括：a）目的地，b）在当前最短路径（由计算路由器到目的地）中其父节点。父节点始终是一个中转顶点（即，始终是一个路由器或中转网络）。

如果在当前最短路径中，目标与根之间至少有一个中间路由器，那么目标节点会直接继承父节点的下一跳集合。否则，情况分为两种：第一种情况，父节点是根（即计算路由器本身）。这意味着目标是一个直接连接的网络或直接连接的路由器。在这种情况下，出接口就是连接到目标网络或路由器的OSPF接口。如果目标是通过点对多点网络连接到计算路由器的路由器，可以通过检查目标的路由器LSA来确定目标的下一跳IP地址：每个指向计算路由器且具有属于点对多点网络的链路数据字段的链路，都提供了下一跳路由器的IP地址。如果目标是一个直接连接的网络，或者通过点对点接口连接到计算路由器的路由器，则不需要下一跳IP地址。如果目标是通过虚拟链路连接到计算路由器的路由器，则下一跳的设置应推迟到第16.3节中的计算完成后再进行。

第二种情况，父节点是一个直接连接计算路由器和目标路由器的网络。此时，下一跳列表通过检查目标的路由器LSA来确定。对于每个指向父网络的链路，链路的链路数据字段提供了下一跳路由器的IP地址。可以根据下一跳IP地址推导出应使用的出接口（也可以从父网络继承）。

16.2. 计算区域间路由

区域间路由通过检查汇总LSA来计算。如果路由器连接到多个区域，则只检查骨干区域的汇总LSA。连接到单一区域的路由器则检查该区域的汇总LSA。无论哪种情况，下面所述的汇总LSA都属于某一单一区域的链路状态数据库（称之为A区）。

总结——LSA（链路状态广告）由区域边界路由器生成。对区域A中的每个summary-LSA（摘要LSA）依次进行处理。请记住，summary-LSA所描述的目的地要么是一个网络（Type 3摘要LSA），要么是一个自治系统（AS）边界路由器（Type 4摘要LSA）。对于每个summary-LSA：

（1）如果LSA中指定的代价为LSInfinity，或者该LSA的LS年龄等于MaxAge，则跳过该LSA，处理下一个。

（2）如果该LSA由计算路由器本身生成，则跳过，处理下一个。

（3）如果是Type 3摘要LSA，并且该摘要LSA描述的目的地集合等于路由器配置的某个区域地址范围（见第3.5节），且该区域地址范围处于激活状态，则应忽略该摘要LSA。“激活”意味着该区域范围内存在一个或多个可达（通过区域内路径）网络。

（4）否则，调用LSA所描述的目的地N（对于Type 3摘要LSA，N的地址通过将LSA的链路状态ID与LSA正文中包含的网络/子网掩码进行掩码得到），以及生成该LSA的区域边界BR。查找路由表中与区域A相关联的BR的条目。如果不存在这样的条目（即BR在区域A中不可达），则对该LSA不做任何处理，继续处理列表中的下一个。否则，该LSA描述了一条到目的地N的区域间路径，其代价为到BR的距离加上LSA中指定的代价。将此区域间路径的代价记为IAC。

（5）接下来，查找目的地N的路由表条目。（如果N是一个AS边界路由器，则查找与区域A相关联的“路由器”路由表条目。）如果没有N的条目，或者该条目的路径类型为“类型1外部”或“类型2外部”，则安装到N的区域间路径，区域为区域A，代价为IAC，下一跳为到BR的下一跳列表，广告路由器为BR。

（6）否则，如果路由表中存在的路径都是区域内路径，则对该LSA不做任何操作（因为区域内路径总是优先的）。

（7）否则，路由表中存在的路径也是区域间路径。如果通过BR的路径成本更低，则用新路径替换路由表中的路径；如果新路径的成本相同，则将其加入到路由表条目中已存在路径的列表中。

16.3  检查中转区域的摘要LSA

此步骤仅由连接到一个或多个非骨干区域、能够承载中转流量的区域边界路由器执行（即“中转区域”或在Dijkstra算法第2步中将TransitCapability参数设置为TRUE的区域，详见第16.1节）。

以下计算的目的是检查中转区域，判断它们是否提供比第16.1节和第16.2节中先前计算的路径更优（更短）的路径。任何比之前发现的路径更优或相等的路径都将被安装到路由表中。

该计算还确定那些在第16.1节和第16.2节中将下一跳虚拟链路计算为虚拟链路的目的地的实际下一跳。在完成以下计算后，任何在第16.1节和第16.2节中计算出的仍未解决虚拟下一跳的路径都应被丢弃。

计算过程如下：逐一检查所有中转区域的摘要LSA。每个摘要LSA描述通过某个中转区域A到网络N的路径（N的地址通过用LSA正文中的链路状态ID与网络/子网掩码进行掩码得到），或者在类型4摘要LSA的情况下，到一个自治系统边界路由器N。假设该摘要LSA由区域边界路由器BR发起。

（1）如果摘要LSA中广告的成本为LSInfinity，或LSA的链路状态年龄等于MaxAge，则检查下一份LSA。

（2）如果摘要LSA由计算路由器本身发起，则检查下一份LSA。

（3）查找目标N的路由表项。（如果N是自治系统边界路由器，则查找与骨干区域相关联的“路由器”路由表项）。如果不存在，或路由类型不是区域内路由或区域间路由，或与该路由表项相关联的区域不是骨干区域，则检查下一份LSA。换句话说，此计算仅更新在第16.1节中找到的骨干区域内路由和第16.2节中找到的区域间路由。

（4）查找与区域A相关联的广告路由器BR的路由表项。如果不可达，则检查下一份LSA。否则，目的地N的成本为BR在区域A中的路由表项中的成本与LSA中广告的成本之和，记为IAC。

（5）如果该成本低于N的路由表条目中发生的成本，则用BR所用的下一跳列表覆盖N的下一跳列表，并将N的路由表成本设置为IAC。否则，如果IAC与N当前的成本相同，则将BR的下一跳列表添加到N的下一跳列表中。无论哪种情况，与N的路由表条目相关联的区域必须保持为骨干区域，并且路径类型（内部区域或区域间）也必须保持不变。

需要注意的是，上述计算绝不会使不可达的目的地变得可达，而只是可能找到到已可达目的地的更优路径。该计算会将找到的任何更低的成本安装到路由表条目中，然后可以通过摘要链路状态公告（summary-LSAs）向其他区域重新宣传。

作为该计算的一个示例，考虑图17所示的自治系统。系统中有一个非骨干区域（区域1），它在物理上将骨干区域分成两个部分。为了保持骨干的连通性，在RT1和RT4之间配置了一个虚拟链路。在图的右侧，网络N1属于骨干区域。虚线表示在区域1内存在一条更短的路径。

（此处省略部分图示描述）

从RT5到网络N1的骨干路径（成本20）比从RT4到网络N1的路径（成本100）更短。RT4和RT5都将为网络N1注入摘要链路状态公告（summary-LSAs）到区域1。

在第16.1节中为骨干网络计算出最短路径树后，路由器RT1（虚拟链路的左端）将为所有目的地为网络N1的数据流计算一条通过RT4的路径。然而，由于RT5距离网络N1更近，区域1内的所有路由器（例如RT2和RT3）都会将它们的网络N1流量转发给RT5，而不是RT4。实际上，在通过上述计算检查区域1的摘要链路状态广告（LSA）后，RT1也会将网络N1的流量转发给RT5。请注意，在这个例子中，虚拟链路使中转数据流可以通过区域1转发，但中转数据流实际经过的路径并不一定沿着虚拟链路。换句话说，虚拟链路允许中转流量通过某个区域，但并不规定流量的具体路径。

Moy                         标准轨迹                   [第172页]

RFC 2328                     OSPF版本2                   1998年4月

16.4. 计算AS外部路由

AS外部路由是通过检查AS外部链路状态广告（AS-external-LSA）来计算的。每个AS-external-LSA会依次考虑。大多数AS-external-LSA描述到特定IP目的地的路由。一个AS-external-LSA也可以描述自治系统的默认路由（目标ID=DefaultDestination，网络/子网掩码=0x00000000）。对于每个AS-external-LSA：

(1) 如果LSA中指定的代价为LSInfinity，或者LSA的链路状态年龄等于MaxAge，则检查下一个LSA。

(2) 如果该LSA由计算路由器自己发起，则检查下一个LSA。

(3) 将LSA描述的目的地记为N。N的地址通过将LSA的链路状态ID与LSA正文中包含的网络/子网掩码进行掩码操作获得。查找路由表中与发起该LSA的自治系统边界路由器（ASBR）相关的条目（每个附属区域可能有一个条目）。如果没有找到对应的ASBR路由器条目（即ASBR不可达），则对该LSA不做任何处理，继续考虑下一个。

否则，该LSA描述了到目的地N的AS外部路径。检查AS-external-LSA中指定的转发地址。这表明应将目的地的包转发到的IP地址。

如果转发地址被设置为0.0.0.0，则应将数据包发送到ASBR本身。在ASBR的多个路由表条目中，按如下方式选择优先条目。如果RFC1583Compatibility设置为“禁用”，则按照第16.4.1节所述修剪ASBR的路由表条目。在任何情况下，在剩余的路由表条目中，选择代价最小的路由表条目；当存在多个最小代价的路由表条目时，选择其关联区域具有最大OSPF区域ID（作为无符号32位整数考虑）的条目。

如果转发地址非零，则在路由表中查找该转发地址。[24] 匹配的路由表条目必须指定区域内或区域间路径；如果不存在这样的路径，则对该LSA不采取任何操作，并考虑列表中的下一个。

(4) 令X为ASBR/转发地址的首选路由表条目中指定的代价，Y为LSA中指定的代价。X是以链路状态度量为单位，Y是类型1或类型2的外部度量。

(5) 查找目的地N的路由表条目。如果不存在N的条目，则安装到N的AS外部路径，下一跳等于到转发地址的下一跳列表，广告路由器为ASBR。如果外部度量类型为1，则路径类型设置为类型1外部，代价为X+Y。如果外部度量类型为2，则路径类型设置为类型2外部，路由的链路状态组成部分的代价为X，类型2的代价为Y。

(6) 将LSA描述的AS外部路径与N的路由表条目中现有路径进行比较，具体如下。如果新路径更优，则替换N的路由表条目中的现有路径；如果新路径的优先级相等，则将其添加到N的路由表条目的路径列表中。

(a) 区域内路径和区域间路径始终优先于AS外部路径。

(b) 类型1外部路径始终优先于类型2外部路径。当所有路径都是类型2外部路径时，广告的类型2度量值最小的路径始终优先。

(c) 如果新的AS外部路径仍然无法与N的路由表条目中的当前路径区分开来，并且RFC1583兼容性设置为“禁用”，则根据第16.4.1节中规定的内容，基于到ASBR/转发地址的AS内路径选择首选路径。

Moy                         标准轨迹                   [第174页]

RFC 2328                     OSPF第2版                   1998年4月

(d) 如果新的AS外部路径仍然无法与N的路由表条目中的当前路径区分开来，则根据最小成本比较选择首选路径。类型1外部路径通过比较到转发地址的距离与广告的类型1度量（X+Y）之和来进行比较。广告的类型2外部路径在广告的类型2度量相等的情况下，通过比较到转发地址的距离来进行比较。

16.4.1.  外部路径偏好

当有多条AS内路径可达ASBR/转发地址时，以下规则指示哪些路径是首选的。这些规则适用于通过多个区域可达同一ASBR的情况，或在决定多个AS外部LSA中应优先使用哪一条路径时。在前者情况下，所有路径都终止于同一ASBR；在后者情况下，路径终止于不同的ASBR/转发地址。无论哪种情况，每条路径都由第11节定义的单独路由表条目表示。

本节仅在RFC1583兼容性设置为“禁用”时适用。

路径偏好规则，从最高偏好到最低偏好如下。请注意，根据这些规则，可能仍然存在多个最高偏好的路径。在这种情况下，必须根据成本选择要使用的路径，如第16.4节所述。

- 使用非骨干区域的区域内路径始终是最优先的。

- 其他路径，即区域内骨干路径和区域间路径，偏好等级相等。

16.5.  增量更新——摘要LSA

当接收到新的摘要LSA时，无需重新计算整个路由表。只需调用目标路径的相关处理即可。

以下是英文内容的中文翻译：

```
由摘要-LSA N描述（N的地址是通过用LSA正文中包含的网络/子网掩码对LSA的链路状态ID进行掩码得到的），并且让区域A为属于该LSA的区域。然后有两种不同的情况：

情况1：区域A是骨干区域，且/或路由器不是区域边界路由器。
在这种情况下，必须执行以下计算。
首先，如果当前存在到目的地N的区域间路由，则应使N的路由表条目失效，并将该条目的值保存以供后续比较。然后，重新运行第16.2节中的计算，针对单一目的地N。在此计算中，将检查所有描述到N的路径的区域A的摘要LSA。此外，如果路由器是连接到一个或多个中转区域的区域边界路由器，则必须再次运行第16.3节中的计算，针对单一目的地。如果这些计算的结果改变了到AS边界路由器（如第4类摘要LSA的情况）或任何转发地址的成本/路径，则必须重新运行第16.4节中的计算，重新检查所有AS外部LSA。否则，如果N现在变得无法到达，则必须为单一目的地N重新运行第16.4节中的计算，以防存在到N的备用外部路由。

情况2：区域A是中转区域，且路由器是区域边界路由器。
在这种情况下，必须执行以下计算。
首先，如果N的路由表条目中目前包含一条或多条利用区域A作为中转区域的区域间路径，则应将这些路径从路由表中删除。如果删除后所有路径都被移除，则应使该路由表条目失效。应将该条目的旧值保存以供后续比较。接着，重新运行第16.3节中的计算，针对单一目的地N。如果此计算的结果导致到N的成本增加，则必须从第16.1节中规定的Dijkstra算法开始，重新执行完整的路由表计算。否则，如果到AS边界路由器（如第4类摘要LSA的情况）或任何转发地址的成本/路径发生变化，则所有的AS外部LSA都需要重新检查。
```

必须通过重新运行第16.4节中的计算来重新检查这些内容。否则，如果N现在变得无法到达，则必须对单一目的地N重新运行第16.4节中的计算，以防存在通往N的备用外部路由。

16.6  增量更新——AS外部LSA

当收到新的AS外部LSA时，无需重新计算整个路由表。将该LSA描述的目的地称为N。N的地址通过用LSA正文中的网络/子网掩码对LSA的链路状态ID进行掩码获得。如果已经存在到该目的地的区域内或区域间路由，则无需重新计算（内部路由具有优先权）。

否则，必须执行第16.4节中的程序，但仅针对目的地为N的那些AS外部LSA。在执行此程序之前，应使当前关于N的路由表项失效。

16.7  由路由表变化引发的事件

路由表条目的更改有时会导致OSPF区域边界路由器采取额外的措施。这些路由器需要对以下路由表的变化做出反应：

- 路由表条目的代价或路径类型发生了变化。如果该条目描述的目的地是网络或AS边界路由器，并且这不仅仅是外部AS路由的变化，可能需要生成新的汇总LSA（每个附属区域，包括骨干区域都可能需要一份）。详见第12.4.3节。如果之前广告的条目被删除，或不再能向某个区域广告，则必须通过将LSA的年龄设置为MaxAge并重新泛洪（参见第14.1节）来从路由域中清除该LSA。

- 与配置的虚拟链路相关的路由表条目发生了变化。此类路由表条目的目的地是区域边界路由器。变化表明虚拟链路的代价或可用性发生了修改。

如果条目显示区域边界路由器变得可以新到达，则相应的虚拟链路现在已正常工作。应为虚拟链路生成InterfaceUp事件，这将导致虚拟邻接开始形成（参见第10.3节）。此时，还会计算虚拟链路的IP接口地址和虚拟邻居的邻居IP地址。

如果条目显示区域边界路由器不再可达，则应销毁虚拟链路及其相关的邻接关系。这意味着应为相关的虚拟链路生成一个InterfaceDown事件。

如果条目的成本发生了变化，并且存在完全建立的虚拟邻接关系，则必须生成一个新的骨干路由器LSA。这可能会引发进一步的路由表变化。

16.8. 等成本多路径

OSPF协议会维护到所有目的地的多条等成本路由。这可以在前面用来计算路由表的步骤中看到，也可以在路由表结构的定义中体现。

每一条多路径都具有相同的类型（区域内、区域间、类型1外部或类型2外部）、成本，并且都属于相同的区域。然而，每条路径可能指定不同的下一跳和广告路由器。

运行OSPF的路由器没有必要跟踪到某一目的地的所有可能的等成本路径。实现可以选择只保存到某一目的地的固定数量的路径。这不会影响本规范中提出的任何算法。

---

Moy                         标准轨迹                   [第178页]

RFC 2328                     OSPF第2版                   1998年4月

脚注

[1] 图中的顶点代表路由器、转发网络或 stub 网络。由于路由器可能属于多个区域，因此不可能为图的顶点着色。

[2] 可能所有路由器的接口都是无编号的点对点链路。在这种情况下，必须为路由器分配一个IP地址。该地址随后将在路由器的router-LSA中作为主机路由进行广告。

[3] 注意，在这些情况下，非虚拟接口和虚拟接口都将具有相同的IP地址。

[4] 注意，不会为无编号点对点网络的接口生成主机路由，也不能将IP数据包定向到这些接口。无论这些接口的状态如何，均如此。

[5] 观察网络的指定路由器（Designated Router）崩溃时会发生什么是很有启发性的。假设该网络的指定路由器为RT1，备用指定路由器为RT2。如果RT1崩溃（或其与网络的接口出现故障），网络中的其他路由器将在RouterDeadInterval秒内检测到RT1的缺失。并非所有路由器会在完全相同的时间检测到这一点；先检测到RT1缺失的路由器将在一段时间内将RT2同时选为指定路由器和备用指定路由器。当RT2检测到RT1已不存在时，它会将自己提升为指定路由器。在此时，具有最高路由器优先级的剩余路由器将被选为备用指定路由器。

[6] 在点对点网络中，底层协议会指示邻居是否已启动并正常运行。同样，虚拟链路上的邻居存在情况由路由表计算所指示。然而，在这两种情况下，仍然使用Hello协议。这确保邻居之间的通信是双向的，并且每个邻居都具有正常工作的路由协议层。

[7] 当指定路由器的身份发生变化时，邻居在此状态下很可能会向路由器发送数据库描述包（Database Description packet）；这意味着在指定路由器的身份上存在一些短暂的不一致。

[8] 注意，路由器可以通过将邻接状态重置为ExStart，从而重新同步任何已完全建立的邻接关系。这会导致邻接的另一端处理SeqNumberMismatch事件，因此也会返回到ExStart状态。

[9] IP网络的地址空间与OSPF路由器ID的地址空间可能会重叠。也就是说，一个网络可能拥有一个IP地址（作为一个32位数字）与某个路由器的路由器ID完全相同。

[10] “Discard”条目是必要的，以确保在区域边界进行路由汇总时不会引起数据包循环。

[11] 假设对于两个不同的地址范围匹配目的地，其中一个范围比另一个更具体。非连续子网掩码可能被配置成违反这一假设。这种子网掩码配置无法被OSPF协议处理。

[12] MaxAgeDiff 是一个架构常数。它表示在整个路由域中，单个LSA实例在洪泛过程中可能出现的最大年龄差（以秒为单位）。如果两个LSA的年龄差超过此值，则假定它们是同一LSA的不同实例。当路由器重启并且丢失了LSA的先前LS序列号时，可能会发生这种情况。有关更多细节，请参见第13.4节。

[13]当两个LSA的LS校验和不同，它们被假定为不同的实例。这种情况也可能发生在路由器重启时，路由器丢失了LSA的先前LS序列号。如果两个LSA具有相同的LS序列号，则无法确定哪个LSA实际上更新。尽管如此，如果错误的LSA被接受为更新的，源路由器只会生成另一个实例。更多细节请参见第13.4节。

[14]有一种情况必须基于部分信息进行查找，即在路由表计算过程中，必须根据Link State ID找到对应的网络LSA。在这种情况下的查找仍然是定义明确的，因为没有两个网络LSA可以具有相同的Link State ID。

[15]这是RFC 1583规定的点对点表示方法。它有三个优点：a）不需要为点对点链路分配子网；b）倾向于偏向路由，使得目的地为点对点接口的数据包实际上会通过该接口接收（这对于诊断非常有用）；c）允许邻居的网络引导，而不需要引导程序包含OSPF实现。

[16]这是由RIP等协议采用的更传统的点对点表示方法。

[17]本条款涵盖以下情况：区域间路由不进行汇总到骨干区域。这是因为区域间路由总是与骨干区域相关联。

[18]只有当非骨干区域A支持中转数据流量（即，设置了TransitCapability为TRUE）时，才会调用此条款。例如，在图6的区域配置中，由于在路由器RT10和RT11之间配置了虚拟链路，区域2可以支持中转流量。因此，路由器RT11只需在区域2中生成一个汇总LSA（目标为N9-N11，H1的折叠），因为RT11的其他所有符合条件的路由的下一跳都属于区域2本身（因此只需由其他区域边界路由器如RT10和RT7进行广告）。

[19] 通过在路由表中保存更多信息，实施方案可以仅重新计算单个区域的最短路径树。实际上，有一些增量算法允许实施方案只重新计算单个区域的部分最短路径树[Ref1]。然而，这些算法超出了本规范的范围。

[20] 这就是链路状态请求列表被清空的方式，最终导致邻居状态转变为“Full”。更多细节请参见第10.9节。

[21] 以这种方式使LSA的LS年龄达到MaxAge的情况应当相对少见。通常，在LSA过期之前，会被更新的更近期的实例所取代。

[22] 严格来说，由于存在等成本多路径，算法并不创建一棵树。我们仍然使用“树”这一术语，因为这是在现有文献中最常见的描述。

[23] 注意，任何指向V的链路的存在都已足够；不必是从V到W的考虑链路的匹配半边。这足以确保在两个邻居路由器之间进行数据流之前，它们的链路状态数据库将被同步。

[24] 当转发地址非零时，它应指向属于另一个自治系统的路由器。更多细节请参见第12.4.4节。

参考文献

[Ref1]  McQuillan, J.，Richer, I. 和 Rosen, E.，“ARPANET路由算法改进”，BBN技术报告3803，1978年4月。

[Ref2]  Digital Equipment Corporation，“信息处理系统——数据通信——中间系统到中间系统的内部域路由协议”，1987年10月。

[Ref3]  McQuillan, J. 等，“ARPANET的新路由算法”，IEEE通信学报，1980年5月。

[Ref4]  Perlman, R.，“容错广播路由信息”，计算机网络，1983年12月。

[Ref5]  Postel, J.，“互联网协议”，STD 5，RFC 791，1981年9月。

[Ref6]  McKenzie, A.，“ISO传输协议规范ISO DP 8073”，RFC 905，1984年4月。

[Ref7]  Deering, S.，“IP多播的主机扩展”，STD 5，RFC 1112，1988年5月。

[Ref8]  McCloghrie, K. 和 Rose, M.，“基于TCP/IP互联网的网络管理信息库：MIB-II”，STD 17，RFC 1213，1991年3月。

[Ref9]  Moy, J.，“OSPF版本2”，RFC 1583，1994年3月。

[参考文献10] Fuller, V., T. Li, J. Yu, 和 K. Varadhan，“无类别域间路由（CIDR）：一种地址分配与聚合策略”，RFC1519，1993年9月。

[参考文献11] Reynolds, J., 和 J. Postel，“已分配号码”，STD 2，RFC 1700，1994年10月。

[参考文献12] Almquist, P.，“互联网协议套件中的服务类型”，RFC 1349，1992年7月。

Moy                         标准轨道                   [第183页]

RFC 2328                     OSPF第2版                   1998年4月

[参考文献13] Leiner, B. 等，“DARPA互联网协议套件”，DDN协议手册，1985年4月。

[参考文献14] Bradley, T.， 和 C. Brown，“逆地址解析协议”，RFC 1293，1992年1月。

[参考文献15] deSouza, O.， 和 M. Rodrigues，“在帧中继网络上运行OSPF的指南”，RFC 1586，1994年3月。

[参考文献16] Bellovin, S.，“TCP/IP协议套件中的安全问题”，ACM计算机通信评论，第19卷，第2期，第32-38页，1989年4月。

[参考文献17] Rivest, R.，“MD5消息摘要算法”，RFC 1321，1992年4月。

[参考文献18] Moy, J.，“OSPF的多播扩展”，RFC 1584，1994年3月。

[参考文献19] Coltun, R.， 和 V. Fuller，“OSPF NSSA选项”，RFC 1587，1994年3月。

[参考文献20] Ferguson, D.，“OSPF外部属性LSA”，正在进行中的工作。

[参考文献21] Moy, J.，“扩展OSPF以支持需求电路”，RFC 1793，1995年4月。

[参考文献22] Mogul, J.， 和 S. Deering，“路径MTU发现”，RFC 1191，1990年11月。

[参考文献23] Rekhter, Y.， 和 T. Li，“边界网关协议第4版（BGP-4）”，RFC 1771，1995年3月。

[参考文献24] Hinden, R.，“互联网路由协议标准化标准”，BBN，1991年10月。

[参考文献25] Moy, J.，“OSPF第2版”，RFC 2178，1997年7月。

[参考文献26] Rosen, E.，“网络控制协议的漏洞：一个例子”，计算机通信评论，1981年7月。

Moy                         标准轨道                   [第184页]

RFC 2328                     OSPF第2版                   1998年4月

A. OSPF数据格式

本附录描述了OSPF协议包和OSPF LSAs的格式。OSPF协议直接在IP网络层之上运行。在描述任何数据格式之前，首先说明OSPF封装的细节。

接下来描述OSPF选项字段。该字段描述了OSPF路由域中可能支持或不支持的各种功能。OSPF选项字段包含在OSPF Hello包、数据库描述包和OSPF LSAs中。

OSPF包格式详见第A.3节。OSPF LSAs的描述见第A.4节。

A.1 OSPF包的封装

OSPF直接在互联网协议的网络层上运行。因此，OSPF数据包仅由IP和本地数据链路头进行封装。

OSPF没有定义其协议数据包的分片方式，在传输大于网络MTU的包时，依赖IP的分片机制。如果有必要，OSPF数据包的长度可以达到65,535字节（包括IP头部）。那些可能较大的OSPF数据包类型（数据库描述包、链路状态请求、链路状态更新和链路状态确认包）通常可以拆分成多个单独的协议包，而不会影响功能。建议如此；应尽量避免IP分片。基于此，应尝试将通过虚拟链路发送的OSPF数据包的大小限制在576字节，除非进行路径MTU发现（参见[Ref22]）。

OSPF IP封装的其他重要特性包括：

- 使用IP多播。在广播网络上传输时，某些OSPF消息采用多播方式。使用两个不同的IP多播地址。发送到这些多播地址的包不应被转发；它们只应在单跳内传递。为了确保这些包不会经过多跳，其IP TTL必须设置为1。

  Moy                         标准轨迹                   [第185页]

  RFC 2328                     OSPF第2版                   1998年4月

  - AllSPFRouters
    该多播地址已被分配为224.0.0.5。所有运行OSPF的路由器都应准备好接收发往此地址的包。Hello包总是发往此地址。此外，在洪泛过程中，某些OSPF协议包也会发往此地址。

  - AllDRouters
    该多播地址已被分配为224.0.0.6。设计ated Router（DR）和Backup Designated Router（BDR）都应准备好接收发往此地址的包。在洪泛过程中，某些OSPF协议包也会发往此地址。

- OSPF是IP协议编号89。该编号已在网络信息中心注册。IP协议编号的分配详见[Ref11]。

- 所有OSPF路由协议包都使用[Ref12]中定义的二进制值为0000的普通服务类型（TOS）值进行发送。

- 路由协议包的IP优先级设置为“互联网控制”。在发送和接收时，OSPF协议包应优先于普通IP数据流。将IP头中的优先级字段设置为“互联网控制”[Ref5]，有助于实现这一目标。

莫伊  标准轨道  [第186页]

RFC 2328  OSPF 版本2  1998年4月

A.2 选项字段

    OSPF的选项字段存在于Hello包、数据库描述包以及所有的LSA中。选项字段使得OSPF路由器能够支持（或不支持）可选功能，并向其他OSPF路由器传达其能力水平。通过这一机制，不同能力的路由器可以在一个OSPF路由域内混合使用。

    在Hello包中使用时，选项字段允许路由器因为能力不匹配而拒绝邻居。或者，在数据库描述包中交换能力时，路由器可以选择不转发某些LSA给邻居，以反映其功能的限制。最后，在LSA中列出能力，可以让路由器绕过功能受限的路由器转发流量，通过在部分路由表计算中排除它们。

    已分配了五个位用于OSPF的选项字段，尽管本备忘录只完整描述了其中一个（E位）。每个位的简要说明如下。当路由器发送Hello包、数据库描述包或生成LSA时，应重置（即清除）未识别的选项位。相反，接收方在收到Hello包、数据库描述包或LSA时遇到未识别的选项位，应忽略该能力，并正常处理该包或LSA。

                       +------------------------------------+
                       | * | * | DC | EA | N/P | MC | E | * |
                       +------------------------------------+

                             选项字段

    E位
        描述AS外部LSA的泛洪方式，详见本备忘录第3.6节、第9.5节、第10.8节和第12.1.2节。

    MC位
        描述是否根据[Ref18]中的规范转发IP多播数据报。

    N/P位
        描述对Type-7 LSA的处理方式，详见[Ref19]。

    EA位
        描述路由器是否愿意接收和转发外部属性LSA，详见[Ref20]。

    DC位
        描述路由器对需求电路的处理方式，详见[Ref21]。

A.3  OSPF包格式

有五种不同的OSPF数据包类型。所有的OSPF数据包类型都以一个标准的24字节头部开始。首先对这个头部进行描述。然后在后续的章节中对每种数据包类型进行详细说明。在这些章节中，会显示每个数据包被划分成的字段，并列出每个字段的定义。

除去OSPF Hello包之外，所有的OSPF数据包类型都涉及LSA（链路状态广告）列表。例如，链路状态更新包（Link State Update）实现了LSA在整个OSPF路由域内的泛洪。由于如此，除非理解LSA的格式，否则无法解析OSPF协议数据包。LSA的格式在A.4节中进行了描述。

OSPF数据包的接收处理详见第8.2节。OSPF数据包的发送过程在第8.1节中进行说明。

---

Moy                         标准轨迹                   [第189页]

RFC 2328                     OSPF版本2                   1998年4月

A.3.1 OSPF数据包头部

每个OSPF数据包都以一个标准的24字节头部开始。这个头部包含了判断该数据包是否应被接受以进行后续处理的所有必要信息。这个判断过程在规范的第8.2节中描述。

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   版本号      |     类型      |         数据包长度            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                          路由器ID                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                           区域ID                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           校验和            |             AuType            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       认证信息                                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       认证信息                                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

版本号
    OSPF的版本号。本规范描述的是协议的第2版。

类型
    OSPF数据包的类型如下。详细信息请参见A.3.2至A.3.6节。

类型  描述
_______________________________
1     Hello
2     数据库描述
3     链路状态请求
4     链路状态更新
5     链路状态确认

包长度
    指OSPF协议包的字节数。该长度包括标准的OSPF头部。

路由器ID
    包的源路由器的ID。

区域ID
    一个32位数字，用于标识该包所属的区域。所有OSPF包都关联到单一区域。大多数包只经过一个跳转。通过虚拟链路传输的包，其标签为主干区域ID，值为0.0.0.0。

校验和
    整个包内容（从OSPF包头开始，但不包括64位的认证字段）的标准IP校验和。该校验和是所有16位字的补码和的反码（即16位的反码和的补码）。如果包的长度不是16位字的整数倍，则在校验前用一个零字节进行填充。校验和被视为包认证过程的一部分；对于某些认证类型，校验和的计算会被省略。

认证类型
    用于指示包所采用的认证方式。认证的详细内容在规范的附录D中。请参阅附录D以获取当前定义的认证类型列表。

认证字段
    一个64位字段，用于认证方案的使用。详细信息请参见附录D。

A.3.2 Hello包

Hello包是OSPF的包类型1。这些包定期在所有接口（包括虚拟链路）上发送，以建立和维护邻居关系。此外，在具有多播或广播能力的物理网络上，Hello包会进行多播，从而实现邻居路由器的动态发现。

所有连接到同一网络的路由器必须在某些参数（网络掩码、Hello间隔和RouterDeadInterval）上达成一致。这些参数包含在Hello包中，以便参数差异可以阻止邻居关系的建立。关于Hello包的接收处理的详细说明在第10.5节中。Hello包的发送则在第9.5节中介绍。

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   版本号      |       1       |         包长度                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                          路由器ID                            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                           区域ID                             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           校验和            |             AuType            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       认证信息                                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       认证信息                                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                        网络掩码                                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Hello间隔             |    选项    |    路由器优先级    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     RouterDeadInterval                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                      指定路由器                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                   备用指定路由器                            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Moy                         标准追踪                        [第193页]

RFC 2328                     OSPF第2版                     1998年4月

   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                          邻居                                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                              ...                              |

网络掩码
    与此接口相关联的网络掩码。例如，如果接口连接到一个第B类网络，其第三个字节用于子网划分，则网络掩码为0xffffff00。

选项
    由路由器支持的可选功能，详见第A.2节的文档。

你好间隔
    该路由器发送Hello包的时间间隔（秒数）。

路由器优先级
    该路由器的路由器优先级，用于（备份）指定路由器的选举。如果设置为0，该路由器将无法成为（备份）指定路由器。

路由器失效间隔
    在宣布一个静默路由器失效之前的秒数。

指定路由器
    在发送路由器的视角中，该网络的指定路由器的身份。指定路由器通过其在网络上的IP接口地址进行标识。如果没有指定路由器，则设置为0.0.0.0。

备份指定路由器
    在发送路由器的视角中，该网络的备份指定路由器的身份。备份指定路由器通过其在网络上的IP接口地址进行标识。如果没有备份指定路由器，则设置为0.0.0.0。

邻居
    最近在网络上看到的每个路由器的路由器ID，指的是在最近的RouterDeadInterval秒内收到的有效Hello包的路由器ID。

Moy                         标准轨迹                   [第194页]

RFC 2328                     OSPF第2版                   1998年4月

A.3.3 数据库描述包

    数据库描述包是OSPF的包类型2。这些包在邻接关系初始化时交换。它们描述链路状态数据库的内容。可以用多个包来描述数据库。为此，采用轮询-应答的程序。一台路由器被指定为主机，另一台为从机。主机发送数据库描述包（轮询），从机通过数据库描述包（应答）确认。应答包通过包的DD序列号与轮询包关联。

以下是英文内容的中文翻译：

```
        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   版本号      |       2       |         数据包长度             |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                          路由器ID                              |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                           区域ID                              |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |           校验和            |             认证类型            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                       认证信息                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                       认证信息                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |         接口MTU             |    选项    |0|0|0|0|0|I|M|MS
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                     DD序列号                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                                                               |
       +-                                                             -+
       |                                                               |
       +-                      LSA头部                                -+
       |                                                               |
       +-                                                             -+
       |                                                               |
       +-                                                             -+
       |                                                               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                              ...                              |



Moy                         标准追踪                        [第195页]


RFC 2328                     OSPF版本2                     1998年4月


    数据库描述包的格式与链路状态请求包和链路状态确认包非常相似。
    三者的主要部分都是一份条目列表，每个条目描述链路状态数据库的一部分。 发送数据库描述包的详细过程见第10.8节。 接收数据库描述包的过程见第10.6节。
```

接口MTU
    指定可以通过相关接口发送的最大IP数据报的字节大小，且不进行分片。常见互联网链路类型的MTU值可在[Ref22]的表7-1中查到。在通过虚拟链路发送的数据库描述包中，接口MTU应设置为0。

选项
    由路由器支持的可选功能，详见第A.2节。

I位
    初始化位。当设置为1时，表示该数据包是数据库描述序列中的第一个包。

M位
    更多位。当设置为1时，表示后续还会有更多的数据库描述包。

MS位
    主/从位。当设置为1时，表示该路由器在数据库交换过程中是主机；否则为从机。

DD序列号
    用于对数据库描述包的集合进行排序。初始值（由I位设置表示）应是唯一的。之后，DD序列号会递增，直到完整的数据库描述被发送完毕。

其余部分
    包含链路状态数据库中部分（可能是部分的）条目的列表。数据库中的每个LSA由其LSA头部描述。LSA头部在第A.4.1节中有详细说明。它包含了识别LSA及其当前实例所需的所有信息。

Moy                         标准轨迹                   [第196页]

RFC 2328                     OSPF第2版                   1998年4月

A.3.4 链路状态请求包

链路状态请求包是OSPF的第3类包。在与邻居路由器交换完数据库描述包后，路由器可能会发现其链路状态数据库的某些部分已过时。链路状态请求包用于请求邻居数据库中更为最新的部分。可能需要使用多个链路状态请求包。

发送链路状态请求包的路由器会明确知道自己请求的数据库片段的具体实例。每个实例由其LS序列号、LS校验和和LS年龄定义，尽管这些字段在链路状态请求包中未具体说明。路由器还可能收到更为最新的实例作为响应。

链路状态请求包的发送详见第10.9节。链路状态请求包的接收详见第10.7节。

以下是英文内容的中文翻译：

```
        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   版本号      |       3       |         数据包长度             |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                          路由器ID                              |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                           区域ID                              |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |           校验和            |             认证类型            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                       认证信息                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                       认证信息                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                          LS类型                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                       链路状态ID                              |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                     广告路由器                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                              ...                              |



Moy                         标准轨迹                   [第197页]


RFC 2328                     OSPF版本2                   1998年4月


    每个请求的LSA由其LS类型、链路状态ID和广告路由器指定。这唯一标识了该LSA，但不代表其实例。链路状态请求包被理解为请求最新的实例（无论是哪一个）。









































Moy                         标准轨迹                   [第198页]


RFC 2328                     OSPF版本2                   1998年4月


A.3.5 链路状态更新包

    链路状态更新包是OSPF的第4类包。这些包实现了LSA的泛洪。每个链路状态更新包携带一组LSA，距离其起点再向前一跳。一个包中可以包含多个LSA。

    链路状态更新包在支持多播/广播的物理网络上进行多播。为了确保泛洪过程的可靠性，泛洪的LSA会在链路状态确认包中得到确认。如果需要重传某些LSA，重传的LSA总是直接发送给邻居。关于LSA可靠泛洪的更多信息，请参阅第13节。
```

```
        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   版本号      |       4       |         包长度                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                          路由器ID                            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                           区域ID                              |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |           校验和            |             认证类型          |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                       认证信息                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                       认证信息                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                            LSAs数量                            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                                                               |
       +-                                                            +-+
       |                             LSAs                              |
       +-                                                            +-+
       |                              ...                              |








Moy                         标准轨迹                        [第199页]


RFC 2328                     OSPF 版本2                     1998年4月


    # LSAs
        本次更新中包含的LSA数量。


    链路状态更新包的主体由一系列LSA组成。
    每个LSA以一个20字节的通用头部开始，详见第A.4.1节。
    不同类型LSA的详细格式在第A.4节中描述。





































Moy                         标准轨迹                        [第200页]


RFC 2328                     OSPF 版本2                     1998年4月


A.3.6 链路状态确认包

    链路状态确认包是OSPF的第5类包。为了确保LSA的泛洪可靠， 
    被泛洪的LSA会被明确确认。此确认通过发送和接收链路状态确认包实现。
    一个链路状态确认包可以确认多个LSA。
```

根据发送接口的状态以及相应链路状态更新包的发送者，链路状态确认包会被发送到多播地址AllSPFRouters、AllDRouters，或者作为单播包发送。链路状态确认包的发送方式在第13.5节中有详细说明。链路状态确认包的接收也在第13.7节中进行了描述。

该包的格式类似于数据描述包。两个包的主体都是一份LSA头部的列表。

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   版本号      |       5       |         包长度                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                          路由器ID                            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                           区域ID                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           校验和            |             AuType            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       认证信息                                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       认证信息                                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +-                                                             -+
   |                                                               |
   +-                         一个LSA头部                          -+
   |                                                               |
   +-                                                             -+



Moy                         标准轨迹                   [第201页]


RFC 2328                     OSPF第2版                   1998年4月


   |                                                               |
   +-                                                             -+
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                              ...                              |


每个被确认的LSA由其LSA头部描述。LSA头部在第A.4.1节中有详细说明。它包含了识别该LSA及其当前实例所需的所有信息。
```

RFC 2328                     OSPF 版本2                   1998年4月

A.4 LSA 格式

    本备忘录定义了五种不同类型的LSA。每个LSA都以一个标准的20字节LSA头部开始。该头部在A.4.1节中进行说明。随后各节将展示不同类型的LSA结构。

    每个LSA描述了OSPF路由域中的一部分。每个路由器都会生成一个路由器LSA。此外，当路由器被选为指定路由器（Designated Router）时，它还会生成一个网络LSA。其他类型的LSA也可能被生成（参见第12.4节）。所有LSA随后会在整个OSPF路由域中进行泛洪。泛洪算法是可靠的，确保所有路由器拥有相同的LSA集合。（关于泛洪算法的更多信息，请参见第13节。）这些LSA的集合被称为链路状态数据库。

    从链路状态数据库中，每个路由器构建一棵以自己为根的最短路径树。这会生成一份路由表（参见第11节）。关于路由表构建过程的详细信息，请参见第16节。

A.4.1 LSA头部

    所有LSA都以一个共同的20字节头部开始。该头部包含足够的信息，用于唯一标识该LSA（LS类型、链路状态ID和广告路由器）。在路由域中可能同时存在多个该类型的LSA实例。此时需要判断哪个实例是最新的。这可以通过检查LS年龄（LS age）、LS序列号（LS sequence number）和LS校验和（LS checksum）字段来实现，这些字段也包含在LSA头部中。

```
        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |            LS age             |    Options    |    LS type    |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                        Link State ID                          |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                     Advertising Router                        |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                     LS sequence number                        |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |         LS checksum           |             length            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

LS年龄
    该字段表示自该LSA被生成以来经过的时间（以秒为单位）。

选项
    描述路由域中所支持的可选功能。OSPF的可选功能在A.2节中有详细说明。

LS类型
    LSA的类型。每种LSA类型都有其单独的广告格式。本备忘录中定义的LSA类型如下（详见第12.1.3节）：

Moy                         标准轨迹                   [第204页]

RFC 2328                     OSPF第2版                   1998年4月

                        LS类型   描述
                        ___________________________________
                        1        路由器-LSA
                        2        网络-LSA
                        3        汇总-LSA（IP网络）
                        4        汇总-LSA（ASBR）
                        5        AS外部-LSA

链路状态ID
    该字段标识由LSA描述的互联网环境的部分。此字段的内容取决于LSA的LS类型。例如，在网络-LSA中，链路状态ID设置为网络的指定路由器（Designated Router）的IP接口地址（可以由此推导出网络的IP地址）。关于链路状态ID的详细内容，见第12.1.4节。

广告路由器
    发出该LSA的路由器的路由器ID。例如，在网络-LSA中，该字段等于网络的指定路由器（Designated Router）的路由器ID。

LS序列号
    用于检测旧的或重复的LSA。连续的LSA实例会被赋予连续的LS序列号。更多细节请参见第12.1.6节。

LS校验和
    完整的LSA内容（包括LSA头部，但不包括LS年龄字段）的Fletcher校验和。更多细节请参见第12.1.7节。

长度
    LSA的字节长度，包括20字节的LSA头部。

Moy                         标准轨迹                   [第205页]

RFC 2328                     OSPF第2版                   1998年4月

A.4.2 路由器-LSA

    路由器-LSA是类型1的LSA。区域内的每个路由器都会生成一个路由器-LSA。该LSA描述了路由器到该区域的链路（即接口）的状态和成本。所有路由器到该区域的链路必须在一个路由器-LSA中描述。关于路由器-LSA的构建细节，详见第12.4.1节。

以下是英文内容的中文翻译：

```

        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |            LS age             |     选项      |       1       |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                        链路状态ID                            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                     广告路由器                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                     LS序列号                                   |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |         LS校验和             |             长度               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |    0    |V|E|B|        0      |            链路数             |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                          链路ID                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                         链路数据                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |     类型      |     TOS数量   |            代价               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                              ...                              |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |      TOS      |        0      |        TOS代价                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                          链路ID                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                         链路数据                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                              ...                              |






Moy                         标准追踪                   [第206页]


RFC 2328                     OSPF版本2                   1998年4月


在路由器链路状态广告（router-LSA）中，链路状态ID字段设置为路由器的OSPF路由ID。路由器链路状态广告仅在单个区域内泛洪。

bit V
    当设置时，表示该路由器是一个或多个完全邻接的虚拟链路的端点，虚拟链路的区域为中转区（V代表虚拟链路端点）。

bit E
    当设置时，表示该路由器是一个AS边界路由器（E代表外部）。

bit B
    当设置时，表示该路由器是一个区域边界路由器（B代表边界）。
```

# 链接
该LSA中描述的路由器链接（即接口）数量。这必须是指向该区域的所有路由器链接（即接口）的总数。

以下字段用于描述每个路由器链接（即接口）。每个路由器链接都有一个类型（见下文的Type字段）。Type字段指示所描述的链接类型。它可能是指向中继网络、另一台路由器或一个边界网络的链接。所有其他描述路由器链接的字段的值都依赖于该链接的Type。例如，每个链接都关联有一个32位的Link Data字段。对于指向边界网络的链接，该字段指定网络的IP地址掩码；对于其他类型的链接，Link Data字段则指定路由器接口的IP地址。

Type
    对路由器链接的简要描述。可能的值如下。注意，主机路由被归类为网络掩码为0xffffffff的边界网络链接。

| 类型 | 描述 |
|-------|--------|
| 1     | 指向另一台路由器的点对点连接 |
| 2     | 指向中继网络的连接 |
| 3     | 指向边界网络的连接 |
| 4     | 虚拟链路 |

Link ID
    标识该路由器链接连接到的对象。其值依赖于链接的Type。当连接到也会生成LSA的对象（即另一台路由器或中继网络）时，Link ID等于邻居LSA的Link State ID。这为在路由表计算过程中在链路状态数据库中查找邻居LSA提供了关键。详细信息请参见第12.2节。

| 类型 | Link ID |
|-------|---------|
| 1     | 邻居路由器的Router ID |
| 2     | 指定路由器（Designated Router）的IP地址 |
| 3     | IP网络/子网编号 |
| 4     | 邻居路由器的Router ID |

Link Data
    其值再次依赖于链接的Type字段。对于指向边界网络的连接，Link Data指定网络的IP地址掩码；对于未编号的点对点连接，它指定接口的MIB-II [Ref8]中的ifIndex值；对于其他类型的链接，它指定路由器接口的IP地址。在构建路由表、计算下一跳的IP地址时，需要用到后者信息。详细内容请参见第16.1.1节。

RFC 2328                     OSPF 版本2                   1998年4月

# TOS
    该字段表示为此链路提供的不同服务类型（TOS）指标的数量，不包括必需的链路指标（在[Ref9]中称为TOS 0指标）。例如，如果没有提供额外的TOS指标，则此字段设置为0。

metric
    使用此路由器链路的代价。

此外，还可以包含与TOS相关的其他信息，以实现与之前版本的OSPF规范的向后兼容（[Ref9]）。在每个链路中，对于每个所需的TOS，可以按如下方式编码TOS特定的链路信息：

TOS
    指此指标所对应的IP服务类型。OSPF LSAs中TOS的编码方式在第12.3节中描述。

TOS metric
    TOS特定的指标信息。

---

Moy                         标准追踪                   [第209页]

RFC 2328                     OSPF 版本2                   1998年4月

A.4.3 网络链路状态广告（Network-LSAs）

网络链路状态广告（Network-LSAs）是类型2的LSA。每个支持两个或更多路由器的广播网络和非广播多点接入网络（NBMA）网络都会生成一个网络LSA。该LSA由网络的指定路由器（Designated Router）发出。LSA描述了连接到该网络的所有路由器，包括指定路由器本身。LSA的链路状态ID字段列出指定路由器的IP接口地址。

从网络到所有连接的路由器的距离为零。这也是为什么在网络LSA中不需要指定指标字段的原因。关于网络LSA的构建细节，请参见第12.4.2节。

以下是英文内容的中文翻译：

```

        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |            LS age             |      Options  |      2        |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                        链路状态ID                            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                     广告路由器                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                     LS序列号                                   |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |         LS校验和             |             长度               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                         网络掩码                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                        附属路由器                               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                              ...                              |



    网络掩码
        网络的IP地址掩码。例如，A类网络的掩码为0xff000000。





Moy                         标准轨迹                   [第210页]


RFC 2328                     OSPF版本2                   1998年4月


    附属路由器
        连接到该网络的每个路由器的路由器ID。实际上，只有那些与指定路由器完全邻接的路由器会被列出。指定路由器会将自己包含在此列表中。包含的路由器数量可以通过LSA头部的长度字段推断得出。







































Moy                         标准轨迹                   [第211页]


RFC 2328                     OSPF版本2                   1998年4月


A.4.4 概要LSA

    概要LSA包括类型3和类型4的LSA。这些LSA由区域边界路由器生成。概要LSA描述区域间的目的地。关于概要LSA的构建细节，请参见第12.4.3节。
```

类型3摘要LSA在目标是IP网络时使用。在这种情况下，LSA的链路状态ID字段是一个IP网络编号（如果需要，链路状态ID也可以设置为网络的一个或多个“主机”位；详细信息请参见附录E）。当目标是AS边界路由器时，使用类型4摘要LSA，链路状态ID字段则是该AS边界路由器的OSPF路由器ID。（要了解为什么有必要广告每个ASBR的位置，请参阅第16.4节。）除了链路状态ID字段的不同外，类型3和类型4摘要LSA的格式是相同的。

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |            LS age             |     Options   |    3或4      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                        链路状态ID                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     广告路由器                                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     LS序列号                                    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         LS校验和             |             长度                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                         网络掩码                                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |      0        |                  metric                         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     TOS       |                TOS  metric                      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                              ...                              |

Moy                         标准轨迹                   [第212页]

RFC 2328                     OSPF第2版                   1998年4月

对于虚拟区域，类型3摘要LSA也可以用来描述（每个区域的）默认路由。默认摘要路由在虚拟区域中用来代替洪泛一组完整的外部路由。当描述默认摘要路由时，摘要LSA的链路状态ID总是设置为DefaultDestination（0.0.0.0），网络掩码设置为0.0.0.0。

网络掩码
    对于类型3摘要LSA，这表示目标网络的IP地址掩码。例如，在广告一个A类网络的位置时，会使用值0xff000000。对于类型4摘要LSA，这个字段没有实际意义，必须为零。

指标
    该路径的代价。以与路由器链路状态广告（LSA）中的接口代价相同的单位表示。

    还可以包含额外的TOS（服务类型）特定信息，以实现与之前版本的OSPF规范的向后兼容（[Ref9]）。对于每个所需的TOS，TOS特定信息的编码如下：

    TOS：此指标所指的IP服务类型。OSPF LSA中TOS的编码方式在第12.3节中描述。

    TOS指标
        TOS特定的指标信息。

















Moy                         标准追踪                   [第213页]


RFC 2328                     OSPF第2版                   1998年4月


A.4.5 AS外部链路状态广告（AS-external-LSAs）

    AS外部链路状态广告（AS-external-LSAs）是第5类LSA。这些LSA由AS边界路由器生成，用于描述AS之外的目的地。关于AS外部链路状态广告的构造细节，请参见第12.4.3节。

    AS外部链路状态广告通常描述特定的外部目的地。对于这些LSA，链路状态ID字段指定一个IP网络号（如有必要，链路状态ID也可以设置为网络的一个或多个“主机”位；详细信息请参见附录E）。AS外部链路状态广告也用于描述默认路由。当没有到达特定目的地的具体路由时，会使用默认路由。在描述默认路由时，链路状态ID总是设置为DefaultDestination（0.0.0.0），网络掩码设置为0.0.0.0。

以下是该英文内容的中文翻译：

```

        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8  9  0  1  2  3  4  5  6  7  8  9  0  1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |            LS age             |     选项      |      5        |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                        链路状态ID                            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                     广告路由器                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                     LS序列号                                   |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |         LS校验和             |             长度                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                         网络掩码                              |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |E|     0       |                  代价                          |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                      转发地址                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                      外部路由标签                              |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |E|    TOS      |                TOS 代价                        |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                      转发地址                                |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+



Moy                         标准追踪                        [第214页]


RFC 2328                     OSPF 版本2                     1998年4月


       |                      外部路由标签                              |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                              ...                              |



网络掩码
    广告目标的IP地址掩码。例如，当广告一个A类网络时，将使用掩码0xff000000。

位 E
    外部度量的类型。如果设置了E位，则指定的度量为类型2外部度量。这意味着该度量被认为大于任何链路状态路径。如果E位为零，则指定的度量为类型1外部度量。这意味着它以与链路状态度量相同的单位表示（即与接口成本相同的单位）。

度量
    该路由的成本。其解释取决于上述的外部类型指示（E位）。
```

转发地址
    广告目的地的数据信息将被转发到该地址。如果转发地址设置为0.0.0.0，则数据将被转发到LSA的发起者（即负责的AS边界路由器）。

外部路由标签
    附加在每个外部路由上的一个32位字段。OSPF协议本身不使用该字段。它可以用来在AS边界路由器之间传递信息；具体传递信息的性质超出了本规范的范围。

为了与之前版本的OSPF规范（[Ref9]）兼容，还可以包含额外的TOS（服务类型）特定信息。对于每个所需的TOS，TOS特定信息的编码如下：

TOS
    指示以下字段所关心的服务类型。OSPF LSAs中TOS的编码方式详见第12.3节。

Moy                         标准轨迹                   [第215页]

RFC 2328                     OSPF第2版                   1998年4月

E位
    用于与[Ref9]的向后兼容。

TOS指标
    TOS特定的指标信息。

转发地址
    用于与[Ref9]的向后兼容。

外部路由标签
    用于与[Ref9]的向后兼容。

---

B. 架构常数

一些OSPF协议参数具有固定的架构值。这些参数在文本中曾用如LSRefreshTime之类的名称提及。相同的命名规则也适用于可配置的协议参数，它们在附录C中定义。

每个架构常数的名称、值及其简要功能说明如下：

LSRefreshTime
    任意特定LSA的不同发起之间的最大时间间隔。如果某个由路由器自己发起的LSA的LS年龄字段达到LSRefreshTime值，则会重新发起一个新的LSA实例，即使LSA的内容（除了LSA头部）保持不变。LSRefreshTime的值设为30分钟。

MinLSInterval
    任意特定LSA的不同发起之间的最小时间间隔。MinLSInterval的值设为5秒。

MinLSArrival
    对于任何特定的LSA，在洪泛过程中接收新LSA实例之间必须经过的最小时间。频率更高接收的LSA实例将被丢弃。MinLSArrival的值设为1秒。

最大年龄（MaxAge）
    允许LSA（链路状态广告）达到的最大年龄。当LSA的LS年龄字段达到MaxAge时，会重新泛洪（reflood），试图将该LSA从路由域中清除（参见第14节）。达到MaxAge的LSA不会被用于路由表的计算。MaxAge的值设定为1小时。

检查年龄（CheckAge）
    当链路状态数据库中某个LSA的年龄达到CheckAge的倍数时，会对该LSA的校验和进行验证。此时如果校验和不正确，表明存在严重错误。CheckAge的值设定为5分钟。

最大年龄差（MaxAgeDiff）
    在整个自治系统（AS）中，LSA在泛洪过程中可能出现的最大时间差。大部分时间差是由于LSA在路由器输出队列中等待泛洪（因此未老化）所造成的。MaxAgeDiff的值设定为15分钟。

无限距离（LSInfinity）
    表示目标不可达的度量值。用于摘要LSA（summary-LSA）和自治系统外部LSA（AS-external-LSA），作为提前老化的替代（参见第14.1节）。它被定义为全部为1的24位二进制值：0xffffff。

默认目的地（DefaultDestination）
    表示默认路由的目的地ID。当找不到其他匹配的路由表项时，将使用此路由。默认目的地只能在AS外部LSA和存根区（stub area）的类型3摘要LSA中进行广告。其值为IP地址0.0.0.0，相关的网络掩码也始终为0.0.0.0。

初始序列号（InitialSequenceNumber）
    在生成任何LSA的第一个实例时使用的LS序列号的值。其值为有符号的32位整数0x80000001。

最大序列号（MaxSequenceNumber）
    LS序列号可以达到的最大值。其值为有符号的32位整数0x7fffffff。

（以下内容为第218页内容）

C. 可配置常数

    OSPF协议具有许多可配置参数。这些参数列在下面，按功能类别（区域参数、接口参数等）进行分组。部分参数提供了示例值。

    某些参数的设置需要在一组路由器之间保持一致。例如，一个区域内的所有路由器必须在该区域参数上达成一致，连接到同一网络的所有路由器也必须在该网络的IP网络号和掩码上达成一致。

一些参数可能由路由器算法在本规范之外的其他地方确定（例如，通过SLIP线路连接到路由器的主机的地址）。从OSPF的角度来看，这些项目仍然是可配置的。

C.1 全局参数

通常，为每个区域运行一个单独的OSPF协议实例。因此，大多数配置参数是按区域定义的。以下列出了少数全局配置参数。

路由器ID
这是一个32位数字，用于唯一标识自治系统中的路由器。分配路由器ID的一种算法是选择分配给该路由器的最大或最小IP地址。如果更改了路由器的OSPF路由器ID，应该在新ID生效之前重启路由器的OSPF软件。在重启以更改路由器ID之前，路由器应清除其自发的LSA（详见第14.1节）以免它们在最大存活时间（MaxAge）内持续存在。

RFC1583兼容性
控制在第16.4节中选择多个广告相同目的地的AS外部LSA时所使用的偏好规则。当设置为“启用”时，偏好规则保持RFC 1583（[Ref9]）中规定的内容。当设置为“禁用”时，偏好规则将遵循第16.4.1节中的规定，这可以防止当来自不同区域的AS外部LSA为同一目的地而产生路由环路。默认设置为“启用”。

为了最大程度减少路由环路的可能性，所有在同一OSPF路由域中的路由器应具有相同的RFC1583兼容性设置。当存在未更新为本备忘录第16.4.1节中规定功能的路由器时，所有路由器应将RFC1583兼容性设置为“启用”。否则，所有路由器应将其设置为“禁用”，以防止路由环路。

C.2 区域参数

属于某个区域的所有路由器必须在该区域的配置上达成一致。两个路由器之间的分歧将导致它们之间无法建立邻接关系，从而阻碍路由协议和数据流的正常传输。区域必须配置以下项目：

区域ID
    这是一个32位数字，用于标识该区域。ID为0.0.0.0的区域保留用于骨干区域。如果该区域代表一个子网网络，则可以使用子网网络的IP地址作为区域ID。

地址范围列表
    一个OSPF区域被定义为一组地址范围。每个地址范围由以下项目组成：

    [IP地址，掩码]
        描述该地址范围内包含的IP地址集合。网络和主机的分配取决于它们的地址是否属于该区域定义的地址范围之一。路由器被视为属于多个区域，具体取决于其连接网络的区域成员身份。

状态
    设置为“广告”或“不广告”。路由信息在区域边界处进行压缩。在区域外，对于每个地址范围，最多只会广告一条路由（通过摘要LSA）。只有当地址范围的状态设置为“广告”时，路由才会被广告。不广告的范围允许有意隐藏某些网络的存在。默认状态为“广告”。

举例来说，假设一个IP子网网络要成为其自己的OSPF区域。该区域将配置为单一的地址范围，其IP地址为子网网络的地址，掩码为自然的A、B或C类地址掩码。一个外部路由将被广告，描述整个子网网络。

外部路由能力
    是否允许AS外部LSA在整个区域内泛洪。如果排除外部LSA，则该区域被称为“存根区域”。在存根区域内部，通往外部目的地的路由将仅基于默认摘要路由。骨干区域不能配置为存根区域。此外，虚拟链路也不能通过存根区域配置。更多信息请参见第3.6节。

存根默认成本
    如果该区域被配置为存根区域，并且路由器本身是区域边界路由器，则存根默认成本表示该路由器应向该区域广告的默认摘要LSA的成本。

C.3 路由器接口参数

一些可配置的路由器接口参数（例如IP接口地址和子网掩码）实际上暗示了所连接网络的属性，因此必须在所有连接到该网络的路由器之间保持一致。必须为路由器接口配置的参数包括：

IP接口地址
    该接口的IP协议地址。它唯一标识整个互联网中的路由器。在点对点网络上不需要配置IP地址。这类点对点网络被称为“无编号网络”。

IP接口掩码
    也称为子网/网络掩码，它指示IP接口地址中用于识别所连接网络的部分。用IP接口掩码对IP接口地址进行掩码后，即得到所连接网络的IP网络号。在点对点网络和虚拟链路上，IP接口掩码未定义。在这些网络中，链路本身没有分配IP网络号，因此链路两端的地址是独立分配的（如果分配的话）。

区域ID
    所连接网络所属的OSPF区域。

接口输出代价
    在该接口上传输一个数据包的代价，以链路状态度量表示。它作为该接口在路由器的路由LSA中广告的链路代价。接口输出代价必须始终大于0。

重传间隔（RxmtInterval）
    该接口所属邻接关系中，LSA重传的时间间隔（以秒为单位）。也用于重传数据库描述包和链路状态请求包。此值应远大于任何两个路由器之间的预期往返延迟。设置此值应保守，否则会导致不必要的重传。本地网络的示例值为：5秒。

链路传输延迟（InfTransDelay）
    估算在该接口上传输一份链路状态更新包所需的秒数。更新包中的LSA在传输前必须将其年龄增加该值。此值应考虑传输和传播延迟。

接口。必须大于0。局域网的示例值：1秒。

路由器优先级
    一个8位无符号整数。当两个连接到同一网络的路由器都试图成为指定路由器时，优先级高的路由器优先。如果仍然平局，则优先级高的路由器ID优先。将路由器优先级设置为0的路由器，不能成为连接网络的指定路由器。路由器优先级仅在广播和NBMA网络的接口上配置。

Hello间隔
    路由器在接口上发送Hello包的时间间隔（秒）。该值在路由器的Hello包中通告。所有连接到同一网络的路由器必须使用相同的值。Hello间隔越小，拓扑变化的检测越快；但会产生更多的OSPF路由协议流量。X.25 PDN网络的示例值：30秒。局域网的示例值：10秒。

Router Dead Interval
    在停止收到某个路由器的Hello包后，邻居宣布该路由器失效前的秒数。该值也在路由器的Hello包中的RouterDeadInterval字段中通告。此值应为Hello间隔的某个倍数（例如4）。所有连接到同一网络的路由器必须使用相同的值。

AuType
    标识在连接网络上使用的认证方式。此值必须在所有连接到该网络的路由器上保持一致。有关定义的认证类型的讨论，请参见附录D。

认证密钥
    该配置数据用于验证通过接口接收的OSPF协议包的认证过程。例如，如果AuType指示简单密码，则认证密钥为明文64位密码。其他OSPF认证类型的密钥讨论，请参见附录D。

C.4 虚拟链路参数

虚拟链路用于恢复或增强骨干网的连通性。虚拟链路可以在任何两个具有接口连接到同一非骨干区的区域边界路由器之间配置。虚拟链路在骨干网的拓扑图中表现为一个无编号的点对点链路。虚拟链路必须在两个区域边界路由器上都进行配置。

在路由器的链路状态广告（LSA）中，虚拟链路表现得就像是连接到骨干网的一个单独的路由器接口一样。因此，它具有与路由器接口相关的所有参数（参见第C.3节）。虽然虚拟链路表现得像一个无编号的点对点链路，但它确实具有一个相关联的IP接口地址。该地址用作虚拟链路上传送的OSPF协议包的源IP地址，并在路由表构建过程中动态设置。虚拟链路的接口输出成本也会动态设置为两个路由器之间区域内路径的成本。必须配置参数RxmtInterval，并且应设置得远高于两个路由器之间的预期往返延迟。对于虚拟链路来说，估算这一延迟可能较困难；最好将其设置得偏大一些。虚拟链路上不使用路由器优先级（Router Priority）。

虚拟链路由以下两个可配置参数定义：虚拟链路另一端的路由器ID，以及虚拟链路所经过的（非骨干）区域（称为虚拟链路的中转区域）。虚拟链路不能通过存根区域配置。

C.5 NBMA网络参数

OSPF将非广播多点接入网络（NBMA）视为类似广播网络的类型。由于可能有许多路由器连接到该网络，因此会为该网络选举一个指定路由器（Designated Router，DR）。该指定路由器随后会生成一个网络LSA，列出所有连接到NBMA网络的路由器。

然而，由于缺乏广播能力，可能需要在DR的选择中使用一些配置参数。这些参数只需在那些有资格成为DR的路由器（即其在该网络上的路由器优先级非零）上配置，且仅在没有自动邻居发现机制的情况下需要配置。

所有其他连接的路由器列表
    该列表包含所有连接到NBMA网络的其他路由器。
    每个路由器都按其在网络上的IP接口地址列出。此外，对于每个列出的路由器，必须定义其成为指定路由器（Designated Router）的资格。
    当NBMA网络的接口启动时，路由器只向有资格成为指定路由器的邻居发送Hello包，直到确定出指定路由器的身份。

PollInterval（轮询间隔）
    如果某个邻居路由器变为不活动状态（在RouterDeadInterval秒内未收到Hello包），仍可能需要向该“死”邻居发送Hello包。这些Hello包将以较低的速率PollInterval发送，通常应远大于HelloInterval。例如，在PDN X.25网络中的示例值为：2分钟。

C.6 点对多点（Point-to-MultiPoint）网络参数

    在点对多点网络中，可能需要配置可以直接通过该网络到达的邻居集。每个邻居通过其在点对多点网络上的IP地址进行识别。点对多点网络上不会选举指定路由器，因此已配置邻居的指定路由器资格是未定义的。

    另外，也可以通过底层协议（如反向ARP）动态发现点对多点网络上的邻居。

Moy                         标准轨迹                     [第225页]

RFC 2328                     OSPF第2版                     1998年4月

C.7 主机路由参数

    主机路由在路由器LSA中作为掩码为0xffffffff的虚拟网络进行广告。它们表示指向点对点网络的路由器接口、环回路由器接口，或直接连接到路由器的IP主机（例如，通过SLIP线路）。对于每个直接连接到路由器的主机，必须配置以下内容：

主机IP地址
    主机的IP地址。

到主机的链路代价
    以链路状态度量衡量，向主机发送数据包的成本。然而，由于主机可能只有单一的互联网连接，实际配置的成本在许多情况下并不重要（即不会影响路由）。

区域ID
    主机所属的OSPF区域。

Moy                         标准轨迹                     [第226页]

RFC 2328                     OSPF第2版                     1998年4月

D. 认证

所有的OSPF协议交换都经过认证。OSPF数据包头（参见第A.3.1节）包含一个认证类型字段，以及用于相应认证方案（由类型字段确定）的一段64位数据。

认证类型可以在每个接口（或等同于每个网络/子网）基础上进行配置。额外的认证数据也可以在每个接口上进行配置。

本规范定义了类型0、1和2的认证方式。所有其他的认证类型由IANA（iana@ISI.EDU）保留待定义。当前的认证类型列表如下表20所示。

| AuType | 描述                     |
|---------|--------------------------|
| 0       | 空认证（Null authentication） |
| 1       | 简单密码（Simple password）   |
| 2       | 加密认证（Cryptographic authentication） |
| 其他    | 保留由IANA分配（Reserved for assignment by IANA） |

表20：OSPF认证类型

D.1 空认证

使用此认证类型意味着网络/子网之间的路由交换不进行认证。OSPF头中的64位认证字段可以包含任何内容；在接收数据包时不会对其进行检查。当采用空认证时，每个OSPF数据包（除64位认证字段外）的全部内容都将进行校验和，以检测数据是否被破坏。

D.2 简单密码认证

使用此认证类型时，在每个网络基础上配置一个64位字段。特定网络上发送的所有数据包都必须在其OSPF头中的64位认证字段中包含此配置值。这实际上充当一个“明文”64位密码。此外，每个OSPF数据包（除64位认证字段外）的全部内容也会进行校验和，以检测数据是否被破坏。

简单密码认证可以防止路由器无意中加入路由域；每个路由器在参与路由之前，必须先配置其连接网络的密码。然而，简单密码认证容易受到当前互联网中普遍存在的被动攻击（参见[Ref16]）。任何具有物理访问网络权限的人都可以获取密码，从而危及OSPF路由域的安全。

D.3 加密认证

使用这种认证类型时，在所有连接到同一网络/子网的路由器中配置一个共享的密钥。对于每个OSPF协议包，密钥用于生成或验证一个“消息摘要”，该摘要会附加在OSPF包的末尾。消息摘要是OSPF协议包和密钥的单向函数。由于密钥从未以明文形式在网络上传输，因此可以防止被动攻击。

用于生成和验证消息摘要的算法由密钥隐含指定。这一规范完全定义了在使用MD5算法时OSPF加密认证的使用方式。

此外，每个OSPF协议包中还包含一个非递减的序列号，以防止重放攻击。这提供了长期的保护；但仍有可能通过重放OSPF包直到序列号变化来进行攻击。为了实现这一功能，每个邻居数据结构中都包含一个新的字段，称为“加密序列号”。该字段初始化为零，并在邻居状态转变为“Down”时也会被重置为零。

（图示内容略）

每当邻居状态转变为“Down”时，都会重置加密序列号。每当接受到一份被认证的OSPF包时，都会将加密序列号设置为接收到的包的序列号。

本规范未提供用于加密序列号的滚动（ rollover）程序。当路由器发送的加密序列号达到最大值时，路由器应将其重置为0。完成此操作后，路由器的邻居将在一段时间内（即RouterDeadInterval）拒绝该路由器的OSPF包，然后路由器将被迫重新建立所有接口上的邻接关系。然而，预计许多实现会使用“自重启以来的秒数”（或“自1960年以来的秒数”等）作为加密序列号。这种选择实际上会阻止序列号的滚动，因为加密序列号字段长度为32位。

OSPF的加密认证选项不提供保密性。

当使用加密认证时，标准OSPF包头中的64位认证字段被重新定义，如图18所示。新的字段定义如下：

- 密钥ID（Key ID）
  该字段标识用于生成附加在OSPF包上的消息摘要的算法和密钥。密钥ID在每个接口（或等同于每个子网）中是唯一的。

- 认证数据长度（Auth Data Len）
  附加在OSPF包上的消息摘要的长度（以字节为单位）。

- 加密序列号（Cryptographic sequence number）
  一个无符号的32位递增序列号，用于防止重放攻击。

附加在OSPF包上的消息摘要实际上不被视为OSPF协议包的一部分：消息摘要不包含在OSPF头部的包长度中，但包含在包的IP头长度字段中。

每个密钥由接口和密钥ID的组合唯一标识。一个接口可以同时激活多个密钥。这允许在密钥之间平滑过渡。每个密钥都关联有四个时间常数，这些时间常数可以用时间（如时间点）或路由器的本地时钟（例如，自上次重启以来的秒数）来表示：

- KeyStartAccept（密钥开始接受）
  路由器开始接受使用该密钥创建的包的时间。

- KeyStartGenerate（密钥开始生成）
  路由器开始使用该密钥生成包的时间。

- KeyStopGenerate（密钥停止生成）
  路由器停止使用该密钥生成包的时间。

关键停止接受（KeyStopAccept）
            指路由器停止接受使用给定密钥创建的包的时间。

Moy                         标准轨迹                     [第230页]

RFC 2328                     OSPF 版本2                   1998年4月

为了实现平滑的密钥过渡，KeyStartAccept 应该小于 KeyStartGenerate，且 KeyStopGenerate 应该小于 KeyStopAccept。如果未指定 KeyStopGenerate 和 KeyStopAccept，则密钥的有效期为无限。当新密钥取代旧密钥时，新密钥的 KeyStartGenerate 时间必须早于或等于旧密钥的 KeyStopGenerate 时间。

密钥存储应在系统重启（无论是热启动还是冷启动）时持续存在，以避免操作问题。如果与接口关联的最后一个密钥过期，不允许退回到未认证状态，也不建议中断路由。因此，路由器应向网络管理器发送“最后认证密钥过期”通知，并将该密钥视为具有无限有效期，直到有效期被延长、由网络管理删除密钥，或配置了新密钥。

D.4 消息生成

在构建完一个OSPF数据包的内容后，发送接口的Autype值指示的认证程序会在数据包发送前被调用。认证程序会按如下方式修改OSPF数据包。

D.4.1 生成空认证（Null Authentication）

使用空认证时，数据包会被修改如下：

(1) 标准OSPF头中的Autype字段设置为0。

(2) 标准OSPF头中的校验和字段设置为整个数据包（从OSPF包头开始，但不包括64位的认证字段）内容的标准IP校验和。该校验和通过对所有16位字的补码和（除了认证字段）取16位的一的补码得到。如果数据包长度不是16位字的整数倍，则在校验前用一个字节的零进行填充。

D.4.2 生成简单密码认证（Simple Password Authentication）

使用简单密码认证时，数据包会被修改如下：

(1) 标准OSPF头中的Autype字段设置为1。

（2）标准OSPF头中的校验和字段被设置为整个数据包（从OSPF包头开始，但不包括64位的认证字段）内容的标准IP校验和。该校验和的计算方法是：所有16位字的“反码和”的一的补码的16位反码。如果数据包的长度不是16位字的整数倍，则在进行校验和计算之前，用一个字节的零进行填充。

（3）OSPF包头中的64位认证字段被设置为为接口配置的64位密码（即认证密钥）。

D.4.3 生成加密认证

当使用加密认证时，接口上可能配置了多个密钥。在这些密钥中，选择所有有效（即KeyStartGenerate ≤ 当前时间 < KeyStopGenerate）且KeyStartGenerate时间最接近当前时间的密钥。使用此密钥，按如下方式修改数据包：

（1）标准OSPF头中的Autype字段被设置为2。

（2）标准OSPF头中的校验和字段不进行计算，而是被设置为0。

（3）密钥ID（见图18）被设置为所选密钥的密钥ID。

（4）认证数据长度字段被设置为将附加到OSPF包中的消息摘要的字节数。当使用MD5作为认证算法时，认证数据长度为16。

（5）32位的加密序列号（见图18）被设置为一个非递减的值（即不小于上次通过接口发送的值）。在加密序列号字段中使用的具体值取决于实现，可能基于简单的计数器，也可能基于系统时钟。

（6）然后计算消息摘要，并将其附加到OSPF数据包中。用于计算摘要的认证算法由密钥本身指示。认证算法的输入包括OSPF数据包和秘密密钥。当使用MD5作为认证算法时，消息摘要的计算过程如下：

(a) 将16字节的MD5密钥附加到OSPF数据包后面。

(b) 添加尾部填充和长度字段，具体规定见[Ref17]。

(c) 对OSPF数据包、秘密密钥、填充和长度字段的连接串运行MD5认证算法，生成一个16字节的消息摘要（参见[Ref17]）。

(d) 将MD5摘要写在OSPF密钥上（即附加到原始的OSPF数据包后面）。该摘要不计入OSPF数据包的长度字段，但会包含在数据包的IP长度字段中。超出摘要部分的尾部填充或长度字段不计数也不传输。

D.5 消息验证

当在某个接口上接收到一个OSPF数据包时，必须对其进行认证。认证过程由标准OSPF数据包头中的Autype字段指示，该字段的设置应与接收接口的Autype设置一致。

如果一个OSPF协议数据包被接受为真实有效，则继续按照第8.2节的规定处理该数据包。认证失败的数据包将被丢弃。

D.5.1 验证空认证

使用空认证时，必须验证OSPF头部中的校验和字段。该字段应设置为除认证字段外，所有16位字的补码和的补码（即16位的“ one's complement”）的值。（如果数据包的长度不是16位字的整数倍，则在进行校验和计算前，用一个字节的零进行填充。）

D.5.2 验证简单密码认证

使用简单密码认证时，接收到的OSPF数据包的认证过程如下：

（1）必须验证OSPF报文头中的校验和字段。该字段应设置为除认证字段外，所有16位字的补码和的16位一补码。若报文长度不是16位字的整数倍，则在校验和之前用一个零字节进行填充。

（2）OSPF报文头中的64位认证字段必须等于为该接口配置的64位密码（即认证密钥）。

Moy                         标准轨迹                   [第234页]

RFC 2328                     OSPF第2版                   1998年4月

D.5.3 验证密码学认证

使用密码学认证时，接收的OSPF包的验证步骤如下：

（1）查找接收接口上配置的密钥，其密钥ID应与接收到的OSPF包中指定的密钥ID相匹配（见图18）。如果未找到该密钥，或该密钥不适用于接收（即当前时间小于KeyStartAccept或大于等于KeyStopAccept），则丢弃该OSPF包。

（2）如果在OSPF头部（见图18）中找到的密码学序列号小于发送邻居的相关数据结构中记录的序列号，则丢弃该OSPF包。

（3）验证附加的消息摘要，步骤如下：

  (a) 将接收到的摘要暂存。

  (b) 按照第D.4.3节第6步的规定，计算一个新的摘要。

  (c) 比较计算得出的摘要与接收到的摘要。如果不匹配，则丢弃该OSPF包；如果匹配，则接受该OSPF协议包作为真实的，并将邻居数据结构中的“密码学序列号”设置为包头中的序列号。

Moy                         标准轨迹                   [第235页]

RFC 2328                     OSPF第2版                   1998年4月

E. 链路状态ID的分配算法

在AS外部链路状态广告（AS-external-LSAs）和摘要链路状态广告（summary-LSAs）中，链路状态ID通常被设置为所描述网络的IP地址。然而，如果有必要，可以在链路状态ID中设置一个或多个网络的主机位。这允许路由器为具有相同地址但不同子网掩码的网络生成不同的LSA。这种情况可能出现在超网（supernetting）和子网0（subnet 0）存在的情况下（参见[Ref10]）。

本附录提供了一种设置链路状态ID中主机位的可能算法。选择此类算法是本地的决策。不同的路由器可以使用不同的算法，因为唯一受影响的LSA是由该路由器自己生成的。对所用算法的唯一要求是：在可能的情况下，应使用网络的IP地址作为链路状态ID；这样可以最大程度地实现与早于RFC 1583的OSPF实现的互操作性。

以下算法适用于AS外部链路状态广告（AS-external-LSAs）。这里只为清晰起见，实际上相同的算法也可以用于摘要链路状态广告（summary-LSAs）。假设路由器希望为一个地址为NA、子网掩码为NM1的网络生成一个AS外部LSA。接下来将使用以下步骤确定该LSA的链路状态ID：

1. 判断路由器是否已经在生成一个链路状态ID为NA的AS外部LSA（在此LSA中，路由器本身会被列为广告路由器）。如果没有，则将链路状态ID设置为NA，算法结束。否则，

2. 从已存在的AS外部LSA的正文中获取网络掩码，记为NM2。此时有两种情况：

   - NM1比NM2更长（即更具体）。在这种情况下，将新LSA的链路状态ID设置为网络[NA, NM1]，并将所有主机位设置为1（即将NA与所有在NM1中未设置的位进行按位或操作，得到网络[NA, NM1]的广播地址）。

   - NM2比NM1更长。在这种情况下，将已有的链路状态ID为NA的LSA修改为引用新的网络[NA, NM1]，方法是增加序列号、将正文中的掩码改为NM1，并插入新网络的成本。然后，为旧网络[NA, NM2]生成一个新的LSA，其链路状态ID为NA与所有在NM2中未设置的位进行按位或（即网络[NA, NM2]的广播地址）。

上述算法假设所有的掩码都是连续的；这确保了当两个网络具有相同的地址时，一个掩码比另一个更具体。该算法还假设不存在一个网络的地址等于另一个网络的广播地址。在这两个假设的前提下，上述算法总能生成唯一的链路状态ID。上述算法也可以改写为如下方式：当发起一个AS外部LSA时，尝试使用网络编号作为链路状态ID。如果这样会导致冲突，则检查冲突的两个网络。它们中一个是另一个的子集。对于较不具体的网络，使用网络编号作为链路状态ID；而对于更具体的网络，则使用该网络的广播地址（即将所有“主机”位都置为1）。如果最具体的网络是先发出的，这将导致同时发出两个LSA。

作为算法的一个示例，考虑在单个路由器（路由器A）中发生以下事件时的操作：

1. 路由器A想为[10.0.0.0,255.255.255.0]发起一个AS外部LSA：
   
   (a) 使用链路状态ID为10.0.0.0。

2. 路由器A接着想为[10.0.0.0,255.255.0.0]发起一个AS外部LSA：
   
   (a) 重新发起[10.0.0.0,255.255.255.0]的LSA，使用新的链路状态ID为10.0.0.255。
   
   (b) 对于[10.0.0.0,255.255.0.0]，使用链路状态ID为10.0.0.0。

3. 路由器A随后想为[10.0.0.0,255.0.0.0]发起一个AS外部LSA：
   
   (a) 重新发起[10.0.0.0,255.255.0.0]的LSA，使用新的链路状态ID为10.0.255.255。
   
   (b) 对于[10.0.0.0,255.0.0.0]，使用链路状态ID为10.0.0.0。
   
   (c) 网络[10.0.0.0,255.255.255.0]保持其链路状态ID为10.0.0.255。

---

F. 多个接口连接到同一网络/子网

支持多个物理接口连接到同一IP子网至少有两种方法。这两种方法都可以与RFC 1583（以及本备忘录）实现兼容。下面简要介绍这两种方法。假设每个接口都被分配了不同的IP地址（否则，支持多个接口更多是链路层或ARP的问题，而非OSPF的问题）。

方法一：
在两个接口上运行整个OSPF功能，包括发送和接收Hello包、泛洪、支持每个接口的单独接口状态机（FSM）和邻居状态机（FSM）等。当这样做时，子网中的其他路由器会将这两个接口视为两个不同的邻居，因为邻居在广播和非广播多点接入网络（NBMA）中是通过它们的IP地址来识别的。

方法一存在以下缺点：

1. 增加了邻居和邻接的总数。
2. 失去了两个接口上的双向性测试，因为双向性是基于路由器ID的。
3. 在选举指定路由器（DR）时，必须同时考虑两个接口，因为如果同时将两个接口声明为DR，可能会混淆用来打破平局的规则（即路由器ID）。

方法二：
只在一个接口（称为主接口）上运行OSPF，但在路由器的路由LSA中同时包含主接口和备用接口。

方法二存在以下缺点：

1. 失去了备用接口上的双向性测试。
2. 当主接口失效时，需要将备用接口提升为主接口。

Moy                         标准追踪                   [第239页]

RFC 2328                     OSPF版本2                   1998年4月

G. 与RFC 2178的差异

本节记录了本备忘录与RFC 2178之间的差异。所有差异均向后兼容。实现本备忘录以及RFC 2178、1583和1247的实现可以互操作。

G.1 泛洪修改

在第13节的泛洪程序中进行了三项更改。

第一项更改涉及第13节中的第4步。现在，只有在满足两个条件时，MaxAge类型的LSA才会被确认（acknowledged）并丢弃：a）数据库中没有该LSA的副本，b）路由器的邻居中没有处于交换（Exchange）或加载（Loading）状态的邻居。在其他所有情况下，MaxAge的LSA会像其他LSA一样被处理，将其安装到数据库中，并在该LSA比数据库中的副本更新时，将其泛洪到适当的接口（第13节第5步）。此更改还影响表19的内容。

第二项更改涉及第13节中的第5a步。MinLSArrival检查仅适用于在泛洪过程中接收的LSA，不应对路由器自己产生的LSA进行此检查。

第三个变更涉及第13节中的第8步。路由器之间对哪个LSA实例更新更为新鲜的混淆，可能会在链路状态协议中引发灾难性的泛洪（参见[Ref26]）。OSPF通过两种方式防止此问题：a）LS年龄字段被用作泛洪中的TTL字段，最终将环路的LSA从网络中移除（见第13.3节）；b）路由器拒绝接受每隔最少LSA到达时间（MinLSArrival秒）就更新一次的LSA（见第13节）。然而，在RFC 2178中仍存在一种情况，即关于哪个LSA更新更为新鲜的分歧可能导致大量泛洪流量：即对旧LSA的响应是重新泛洪数据库副本。因此，第13节的第8步已被修订，只有在该数据库副本在过去的MinLSArrival秒内未曾被发送过任何链路状态更新时，才会用该副本进行响应。

Moy 规范追踪 [第240页]

RFC 2328 版本2的OSPF 1998年4月

G.2 对外部路径偏好的变更

在RFC 2178中，仍存在一个路由环路的可能性，当同时使用虚拟链路且多个ASBR（自治系统边界路由器）导入相同的外部路由时，每个ASBR都位于不同的区域。为解决此问题，已修订第16.4.1节。为了选择正确的ASBR/转发地址，偏好通过非骨干区域的区域内路径。然而，通过骨干区域（区域0）以及区域间路径的偏好现在是相等的，必须仅根据成本进行比较。

此变更背后的原因如下：当使用虚拟链路时，一个路由器的区域内骨干路径可能在距离目的地更近的路由器处变成区域间路径。因此，区域内骨干路径和区域间路径的偏好应相等。由于第16.3节中的计算，我们可以安全地比较它们的成本，偏好成本较小的路径。

感谢UNH互操作性实验室的Michael Briggs和Jeremy McCooey指出了这个问题。

G.3 虚拟下一跳的不完全解析

第16.3节中的计算功能之一是确定那些在第16.1和16.2节中被计算为虚拟链路的目的地的实际下一跳。在完成第16.3节的计算后，任何在第16.1和16.2节中计算出来但仍未解决虚拟下一跳的路径都应被丢弃。

G.4 路由表查找

第11.1节中的路由表查找算法已被修改，以反映当前的实践。现在，总是选择“最佳匹配”的路由表条目，即提供最具体（最长）匹配的条目。例如，假设一个路由器正转发数据包到目的地192.9.1.1，那么对于192.9.1/24的路由表条目，总是比192.9/16的路由表条目更匹配，无论这些条目的路径类型如何。然而，当一个路由表条目有多条路径可用时，第16.1、16.2和16.4节中的计算总是会产生具有最优路径类型的路径（在区域内路径最优，其次是区域间路径、类型1外部路径和类型2外部路径；详见第11节）。

安全考虑

所有的OSPF协议交换都经过认证。OSPF支持多种认证类型；可以在每个网络段上配置所使用的认证类型。OSPF的一种认证类型，即加密认证选项，被认为能有效防御被动攻击，并能显著增强对主动攻击的保护。在使用加密认证选项时，每个路由器会在其传输的OSPF数据包中附加一个“消息摘要”。接收方随后使用共享的密钥和接收到的摘要来验证每个接收的OSPF数据包的真实性。

加密认证选项提供的安全性质量完全取决于消息摘要算法（目前唯一被指定的消息摘要算法是MD5）、所使用密钥的强度，以及所有通信的OSPF实现中安全机制的正确实施。此外，还要求所有参与方都必须保持共享密钥的机密性。

任何一种OSPF认证类型都不提供机密性，也不能防止流量分析。密钥管理问题也未在本说明中涉及。

更多信息请参见第8.1节、第8.2节和附录D。

作者联系方式

约翰·莫伊（John Moy）  
Ascend Communications, Inc.  
1 Robbins Road  
Westford, MA 01886

电话：978-952-1367  
传真：978-392-2075  
电子邮箱：jmoy@casc.com

完整版权声明

版权所有 (C) 互联网协会（1998年）。保留所有权利。

本文件及其翻译版本可以被复制并提供给他人，也可以准备、复制、出版和分发其评论、解释或协助实现的衍生作品，全部或部分，且不受任何限制，前提是所有此类副本和衍生作品都必须包含上述版权声明和本段内容。然而，严禁以任何方式修改本文件本身，例如删除版权声明或提及互联网协会或其他互联网组织的内容，除非出于制定互联网标准的需要，在此情况下必须遵循互联网标准流程中关于版权的规定，或出于将其翻译成非英语语言的需要。

上述授予的有限权限是永久性的，不会被互联网协会或其继任者或受让人撤销。

本文件及其中包含的信息是“按原样”提供的，互联网协会和互联网工程任务组对其不作任何明示或暗示的保证，包括但不限于对使用本文件中的信息不会侵犯任何权利或对其适销性或特定用途适用性的任何保证。


















Moy                         标准轨迹                   [第244页]